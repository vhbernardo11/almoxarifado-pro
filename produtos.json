-- ALMOXARIFADO 2026 - Importação direta (PostgreSQL)
-- Arquivo esperado: almox2026_produtos_import.csv (UTF-8, vírgula, cabeçalho)

BEGIN;

CREATE TABLE IF NOT EXISTS almox_produtos (
  id              BIGSERIAL PRIMARY KEY,
  codigo          INTEGER NOT NULL UNIQUE,   -- novo (7 dígitos)
  codigo1         INTEGER,                   -- legado (8 dígitos)
  codigo2         TEXT,
  nome            TEXT NOT NULL,
  descricao       TEXT,
  categoria       TEXT NOT NULL,
  setor           TEXT NOT NULL DEFAULT 'ALMOXARIFADO',
  ncm             TEXT,
  estoque_atual   INTEGER NOT NULL DEFAULT 0,
  estoque_min     INTEGER NOT NULL DEFAULT 0,
  preco           NUMERIC(12,2),             -- em reais (assumindo centavos no JSON original)
  preco_raw       INTEGER,                   -- valor bruto original do JSON
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_almox_produtos_categoria ON almox_produtos (categoria);
CREATE INDEX IF NOT EXISTS idx_almox_produtos_ncm ON almox_produtos (ncm);
CREATE INDEX IF NOT EXISTS idx_almox_produtos_nome_gin ON almox_produtos USING gin (to_tsvector('portuguese', nome));

-- Tabela de staging para carga rápida e UPSERT
CREATE TABLE IF NOT EXISTS almox_produtos_stg (LIKE almox_produtos INCLUDING DEFAULTS);
TRUNCATE almox_produtos_stg;

-- IMPORTAÇÃO (no psql):
-- \copy almox_produtos_stg (codigo,codigo1,codigo2,nome,descricao,categoria,setor,ncm,estoque_atual,estoque_min,preco,preco_raw)
-- FROM 'almox2026_produtos_import.csv' WITH (FORMAT csv, HEADER true, DELIMITER ',', ENCODING 'UTF8');

-- UPSERT (atualiza pelo codigo novo)
INSERT INTO almox_produtos (
  codigo,codigo1,codigo2,nome,descricao,categoria,setor,ncm,estoque_atual,estoque_min,preco,preco_raw
)
SELECT
  codigo,codigo1,codigo2,nome,descricao,categoria,setor,ncm,estoqueAtual,estoqueMin,preco,preco_raw
FROM (
  SELECT
    codigo,
    codigo1,
    codigo2,
    nome,
    descricao,
    categoria,
    COALESCE(NULLIF(setor,''),'ALMOXARIFADO') AS setor,
    ncm,
    estoqueAtual,
    estoqueMin,
    preco,
    preco_raw
  FROM (
    SELECT * FROM almox_produtos_stg
  ) x
) s
ON CONFLICT (codigo) DO UPDATE SET
  codigo1       = EXCLUDED.codigo1,
  codigo2       = EXCLUDED.codigo2,
  nome          = EXCLUDED.nome,
  descricao     = EXCLUDED.descricao,
  categoria     = EXCLUDED.categoria,
  setor         = EXCLUDED.setor,
  ncm           = EXCLUDED.ncm,
  estoque_atual = EXCLUDED.estoque_atual,
  estoque_min   = EXCLUDED.estoque_min,
  preco         = EXCLUDED.preco,
  preco_raw     = EXCLUDED.preco_raw,
  updated_at    = now();

COMMIT;
