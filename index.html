<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ALMOX2026 - Controle de Almoxarifado</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#00d4ff; --primary-dark:#00a8cc; --secondary:#7c3aed;
      --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
      --bg-dark:#0f0f1e; --bg-darker:#0a0a14; --bg-card:#1a1a2e; --bg-hover:#252541;
      --text-primary:#e0e0ff; --text-secondary:#a0a0c0; --border:#3a3a5c;
    }
    html,body{height:100%;width:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,var(--bg-dark) 0%,var(--bg-darker) 100%);
      color:var(--text-primary);line-height:1.6;font-size:16px;
    }
    .app{display:grid;grid-template-columns:260px 1fr;height:100vh}

    /* ===== SIDEBAR ===== */
    .sidebar{
      background:var(--bg-card);border-right:1px solid var(--border);
      overflow-y:auto;display:flex;flex-direction:column;
      position:fixed;width:260px;height:100vh;left:0;top:0;z-index:200;
    }
    .sidebar-header{
      background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
      color:var(--bg-dark);padding:16px;text-align:center;font-weight:800;
      font-size:1.02em;border-bottom:1px solid var(--border);
    }
    .sidebar-nav{flex:1;overflow-y:auto}
    .nav-item{
      padding:14px 16px;cursor:pointer;border-left:3px solid transparent;
      transition:all .2s ease;color:var(--text-secondary);font-weight:600;font-size:.95em;
      display:flex;align-items:center;gap:10px;
      user-select:none;
    }
    .nav-item:hover{background:var(--bg-hover);color:var(--primary);border-left-color:var(--primary);transform:translateX(4px)}
    .nav-item.active{background:var(--bg-hover);color:var(--primary);border-left-color:var(--primary)}
    .sidebar-actions{padding:12px;border-top:1px solid var(--border);display:grid;gap:8px}
    .action-btn{
      width:100%;padding:10px;background:var(--bg-hover);border:1px solid var(--border);
      border-radius:10px;color:var(--text-primary);cursor:pointer;font-weight:800;font-size:.85em;
      transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:8px;white-space:nowrap;
    }
    .action-btn:hover{background:var(--primary);color:var(--bg-dark);border-color:var(--primary)}

    /* ===== CONTAINER ===== */
    .container{margin-left:260px;display:flex;flex-direction:column;height:100vh}
    .header{
      background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
      color:var(--bg-dark);padding:16px 18px;box-shadow:0 8px 25px rgba(0,0,0,.4);
      display:flex;flex-direction:column;gap:12px;
    }
    .header-top{
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;
    }
    .header-left{flex:1;min-width:250px}
    .header-title{font-size:1.55em;font-weight:900;margin:0 0 6px 0}
    .header-stats{display:flex;gap:10px;flex-wrap:wrap}
    .stat-item{
      display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.15);
      padding:7px 12px;border-radius:10px;font-weight:800;font-size:.92em;
    }
    .stat-value{font-size:1.15em;font-weight:900}
    .top-actions{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;
    }
    .btn-top{
      padding:10px 14px;background:rgba(255,255,255,.18);color:white;
      border:2px solid rgba(255,255,255,.35);border-radius:12px;cursor:pointer;
      font-weight:900;font-size:.85em;transition:all .2s ease;display:flex;align-items:center;gap:8px;
      user-select:none;
    }
    .btn-top:hover{background:rgba(255,255,255,.28);border-color:white;transform:translateY(-1px)}
    .btn-top.active{background:rgba(255,255,255,.35);border-color:white}

    .filtros{
      background:var(--bg-card);border-bottom:1px solid var(--border);
      padding:12px;display:grid;grid-template-columns:1fr;gap:10px;
    }
    .filtro-group{display:flex;flex-direction:column;gap:5px}
    .filtro-label{font-size:.72em;color:var(--text-secondary);font-weight:900;text-transform:uppercase;letter-spacing:.5px}
    input[type="search"],select{
      padding:11px;background:var(--bg-hover);border:1px solid var(--border);
      border-radius:10px;color:var(--text-primary);font-size:1em;font-family:inherit;
      transition:all .2s ease;
    }
    input[type="search"]:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 10px rgba(0,212,255,.18)}
    .btn-filtro{
      padding:11px;background:var(--bg-hover);border:1px solid var(--border);
      border-radius:10px;color:var(--text-secondary);cursor:pointer;font-weight:900;font-size:.85em;
    }
    .btn-filtro:hover{background:var(--danger);border-color:var(--danger);color:white}

    .content{flex:1;overflow-y:auto;padding:12px}
    .produtos-grid{display:grid;grid-template-columns:1fr;gap:12px}

    .produto-card{
      background:var(--bg-card);border-radius:16px;border:1px solid var(--border);padding:16px;
      cursor:pointer;transition:all .2s ease;box-shadow:0 2px 10px rgba(0,0,0,.22);
    }
    .produto-card:active{transform:scale(.99)}
    .produto-card:hover{background:var(--bg-hover);border-color:var(--primary);box-shadow:0 6px 18px rgba(0,212,255,.15)}
    .card-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:10px}
    .card-codigo{display:flex;flex-direction:column;gap:4px}
    .codigo-principal{font-size:1.05em;font-weight:900;color:var(--primary)}
    .codigo-secundario{font-size:.85em;color:var(--text-secondary)}
    .card-badge{display:inline-block;padding:6px 10px;background:var(--secondary);color:white;border-radius:10px;font-size:.75em;font-weight:900;white-space:nowrap}
    .card-titulo{font-size:1em;font-weight:800;color:var(--text-primary);margin-bottom:10px;line-height:1.35}
    .card-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
    .info-item{display:flex;flex-direction:column;gap:4px;padding:10px;background:var(--bg-hover);border-radius:12px}
    .info-label{font-size:.74em;color:var(--text-secondary);text-transform:uppercase;font-weight:900}
    .info-value{font-size:1.05em;font-weight:900;color:var(--primary)}
    .card-footer{display:flex;justify-content:space-between;align-items:center;gap:8px;padding-top:10px;border-top:1px solid var(--border)}
    .preco{font-size:1em;font-weight:900;color:var(--success)}
    .status-badge{padding:6px 12px;border-radius:10px;font-size:.82em;font-weight:900}
    .status-ok{background:rgba(16,185,129,.18);color:var(--success)}
    .status-baixo{background:rgba(245,158,11,.18);color:var(--warning)}
    .status-vazio{background:rgba(239,68,68,.18);color:var(--danger)}

    /* ===== MODAL / OVERLAY ===== */
    .modal-overlay{
      position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,.82);display:none;align-items:center;justify-content:center;
      padding:12px;overflow-y:auto;
    }
    .modal-overlay.active{display:flex;animation:fadeIn .2s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal-box{
      background:var(--bg-card);border-radius:18px;border:2px solid var(--primary);
      width:100%;max-width:860px;max-height:92vh;overflow:hidden;
      display:flex;flex-direction:column;animation:slideUp .2s ease;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
    }
    @keyframes slideUp{from{transform:translateY(22px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{
      background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
      color:var(--bg-dark);padding:14px 16px;display:flex;justify-content:space-between;align-items:center;
      font-weight:1000;font-size:1.05em;
    }
    .modal-close{
      background:rgba(255,255,255,.2);color:white;border:none;border-radius:50%;
      width:34px;height:34px;font-size:20px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;transition:all .2s ease;
    }
    .modal-close:hover{background:rgba(255,255,255,.3)}
    .modal-body{flex:1;overflow-y:auto;padding:16px}
    .modal-footer{padding:14px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

    .form-group{margin-bottom:12px}
    .form-label{
      display:block;font-weight:900;font-size:.78em;color:var(--text-primary);
      text-transform:uppercase;margin-bottom:6px;letter-spacing:.5px
    }
    .form-input,.form-select,.form-textarea{
      width:100%;padding:12px;background:var(--bg-hover);border:1px solid var(--border);
      border-radius:12px;color:var(--text-primary);font-family:inherit;font-size:1em;transition:all .2s ease;
    }
    .form-textarea{min-height:84px;resize:vertical}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 10px rgba(0,212,255,.18)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .btn{
      padding:12px 14px;border:none;border-radius:12px;font-size:.88em;font-weight:1000;
      cursor:pointer;transition:all .2s ease;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:var(--bg-dark)}
    .btn-secondary{background:var(--bg-hover);color:var(--text-primary);border:1px solid var(--border)}
    .btn-danger{background:var(--danger);color:white}
    .btn-warning{background:var(--warning);color:#111}
    .btn-primary:hover{box-shadow:0 8px 20px rgba(0,212,255,.25);transform:translateY(-1px)}
    .btn-secondary:hover{border-color:var(--primary)}
    .btn-danger:hover{opacity:.86}
    .btn-warning:hover{opacity:.92}

    .toast{
      position:fixed;bottom:-120px;right:12px;min-width:280px;background:var(--success);color:white;
      padding:12px 16px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:9999;
      transition:bottom .25s ease;font-weight:900;font-size:.9em;
    }
    .toast.show{bottom:18px}
    .toast.erro{background:var(--danger)}
    .toast.aviso{background:var(--warning);color:#111}

    /* ===== TABLES ===== */
    .rel-table{
      width:100%;border-collapse:collapse;background:var(--bg-hover);
      border-radius:12px;overflow:hidden;font-size:.9em;margin-bottom:16px;
    }
    .rel-table thead{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:var(--bg-dark)}
    .rel-table th{padding:12px 10px;text-align:left;font-weight:1000}
    .rel-table td{padding:10px;border-bottom:1px solid var(--border)}
    .rel-table tbody tr:last-child td{border-bottom:none}
    .rel-table tbody tr:hover{background:var(--bg-card)}

    /* ===== REPORT PAGES (pagination bottom-right) ===== */
    .report-pages{display:flex;flex-direction:column;gap:12px}
    .report-page{
      background:var(--bg-hover);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .report-page-title{
      font-weight:1000;
      color:var(--primary);
      margin-bottom:10px;
      letter-spacing:.3px;
    }
    .page-number{
      position:absolute;
      right:10px;
      bottom:8px;
      font-weight:1000;
      color:var(--text-secondary);
      font-size:.85em;
      background:rgba(0,0,0,.25);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
    }
    .mini-badges{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .mini-badge{
      font-size:.78em;font-weight:1000;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text-primary);
    }

    @media print{
      .sidebar,.header,.btn,.modal-close,.modal-footer{display:none!important}
      .container{margin-left:0}
      .modal-box{max-width:100%;border:none;box-shadow:none}
      .modal-header{border-radius:0}
      .modal-overlay{background:#fff}
      .report-page{page-break-after:always}
      .page-number{border:1px solid #999;color:#333;background:#eee}
    }

    @media (max-width:1024px){
      .app{grid-template-columns:1fr}
      .sidebar{
        width:100%;height:auto;position:relative;border-right:none;border-bottom:1px solid var(--border);
        flex-direction:row;
      }
      .sidebar-nav{display:flex;overflow-x:auto;flex:1}
      .nav-item{border-left:none;border-bottom:3px solid transparent;white-space:nowrap}
      .container{margin-left:0}
      .form-row{grid-template-columns:1fr}
    }
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-track{background:var(--bg-hover)}
    ::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px}
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">üì¶ ALMOX2026</div>
      <div class="sidebar-nav">
        <div class="nav-item active" data-sec="estoque" onclick="mudarSecao('estoque', this)">üì¶ Estoque</div>
        <div class="nav-item" data-sec="relatorio" onclick="mudarSecao('relatorio', this)">üìä Relat√≥rios</div>
        <div class="nav-item" data-sec="mov" onclick="abrirMovimentacoes()">üîÅ Movimenta√ß√µes</div>
        <div class="nav-item" data-sec="config" onclick="mudarSecao('config', this)">‚öôÔ∏è Config</div>
      </div>
      <div class="sidebar-actions">
        <button class="action-btn" onclick="abrirModalDados()">üíæ Dados</button>
        <button class="action-btn" onclick="abrirMovimentacoes()">üîÅ Movimenta√ß√µes</button>
      </div>
    </div>

    <!-- CONTAINER -->
    <div class="container">
      <!-- HEADER -->
      <div class="header">
        <div class="header-top">
          <div class="header-left">
            <div class="header-title" id="titulo">üì¶ ESTOQUE</div>
            <div class="header-stats">
              <div class="stat-item"><span>Total:</span><span class="stat-value" id="statTotal">0</span></div>
              <div class="stat-item" style="background: rgba(16, 185, 129, 0.18);">
                <span>‚úÖ OK:</span><span class="stat-value" id="statOk" style="color: var(--success);">0</span>
              </div>
              <div class="stat-item" style="background: rgba(245, 158, 11, 0.18);">
                <span>‚ö†Ô∏è Baixo:</span><span class="stat-value" id="statBaixo" style="color: var(--warning);">0</span>
              </div>
              <div class="stat-item" style="background: rgba(239, 68, 68, 0.18);">
                <span>‚ùå Vazio:</span><span class="stat-value" id="statVazio" style="color: var(--danger);">0</span>
              </div>
            </div>
          </div>

          <!-- ‚úÖ TOP BUTTONS (pedido) -->
          <div class="top-actions">
            <button id="btnTopDados" class="btn-top" onclick="abrirModalDados()">üíæ DADOS</button>
            <button id="btnTopRel" class="btn-top" onclick="mudarSecao('relatorio')">üìä RELAT√ìRIOS</button>
            <button id="btnTopEst" class="btn-top active" onclick="mudarSecao('estoque')">üì¶ ESTOQUE</button>
            <button id="btnTopMov" class="btn-top" onclick="abrirMovimentacoes()">üîÅ MOVIMENTA√á√ïES</button>
          </div>
        </div>
      </div>

      <!-- SE√á√ÉO ESTOQUE -->
      <div id="secEstoque" class="section" style="display:flex; flex-direction:column; flex:1;">
        <div class="filtros">
          <div class="filtro-group">
            <label class="filtro-label">üîç Buscar</label>
            <input type="search" id="busca" placeholder="Nome, c√≥digo..." onkeyup="filtrar()" />
          </div>
          <div class="filtro-group">
            <label class="filtro-label">üìÇ Categoria</label>
            <select id="setor" onchange="filtrar()">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="filtro-group">
            <label class="filtro-label">‚ö†Ô∏è Status</label>
            <select id="status" onchange="filtrar()">
              <option value="">Todos</option>
              <option value="ok">‚úÖ OK</option>
              <option value="baixo">‚ö†Ô∏è Baixo</option>
              <option value="vazio">‚ùå Vazio</option>
            </select>
          </div>
          <button class="btn-filtro" onclick="limparFiltros()" style="width:100%;">üîÑ Limpar</button>
        </div>

        <div class="content">
          <div class="produtos-grid" id="gridProdutos">
            <div style="text-align:center; color: var(--text-secondary); padding:20px;">Carregando...</div>
          </div>
        </div>
      </div>

      <!-- SE√á√ÉO RELAT√ìRIOS -->
      <div id="secRelatorio" class="section" style="display:none; flex:1; overflow-y:auto;">
        <div class="content">
          <h2 style="color: var(--primary); margin-bottom: 14px; font-size: 1.55em; font-weight:1000;">üìä RELAT√ìRIOS</h2>

          <div class="mini-badges">
            <span class="mini-badge">üìå Clique nos blocos para abrir detalhes</span>
            <span class="mini-badge">üñ®Ô∏è Imprim√≠vel com pagina√ß√£o</span>
            <span class="mini-badge">üîÅ Inclui Movimenta√ß√µes</span>
          </div>

          <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:16px;">
            <div class="report-page" onclick="abrirModalRelatorio('todos')">
              <div class="report-page-title">üì¶ Produtos (Todos)</div>
              <div style="font-size:2.2em; font-weight:1000; color:var(--primary);" id="relTotalBox">0</div>
              <div class="page-number">Abrir</div>
            </div>
            <div class="report-page" onclick="abrirModalRelatorio('criticos')">
              <div class="report-page-title">üö® Cr√≠ticos</div>
              <div style="font-size:2.2em; font-weight:1000; color:var(--danger);" id="relCriticosBox">0</div>
              <div class="page-number">Abrir</div>
            </div>
            <div class="report-page" onclick="abrirModalRelatorio('mov')">
              <div class="report-page-title">üîÅ Movimenta√ß√µes</div>
              <div style="font-size:2.2em; font-weight:1000; color:var(--secondary);" id="relMovBox">0</div>
              <div class="page-number">Abrir</div>
            </div>
            <div class="report-page" onclick="abrirModalRelatorio('setoresadm')">
              <div class="report-page-title">üè¢ Saldo por Setor (Admin)</div>
              <div style="font-size:2.2em; font-weight:1000; color:var(--success);" id="relSetoresAdmBox">0</div>
              <div class="page-number">Abrir</div>
            </div>
          </div>

          <h3 style="color: var(--text-primary); margin: 14px 0 10px; font-weight:1000;">üìÇ Por Categoria (estoque)</h3>
          <table class="rel-table">
            <thead>
              <tr><th>Categoria</th><th style="text-align:center;">Total</th><th style="text-align:center;">OK</th></tr>
            </thead>
            <tbody id="relSetoresTable">
              <tr><td colspan="3" style="text-align:center; padding:16px;">Carregando...</td></tr>
            </tbody>
          </table>

          <h3 style="color: var(--danger); margin: 14px 0 10px; font-weight:1000;">üö® Cr√≠ticos (Top 15)</h3>
          <table class="rel-table">
            <thead>
              <tr style="background: linear-gradient(135deg, var(--danger) 0%, #c91e3a 100%); color: white;">
                <th>Produto</th><th style="text-align:center;">Qtd</th><th style="text-align:center;">Categoria</th>
              </tr>
            </thead>
            <tbody id="relCriticosTable">
              <tr><td colspan="3" style="text-align:center; padding:16px;">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- SE√á√ÉO CONFIG -->
      <div id="secConfig" class="section" style="display:none; flex:1; overflow-y:auto;">
        <div class="content">
          <h2 style="color: var(--primary); margin-bottom: 12px; font-weight:1000;">‚öôÔ∏è CONFIGURA√á√ïES</h2>

          <div style="background: var(--bg-hover); padding: 16px; border-radius: 14px; border: 1px solid var(--border);">
            <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.95em; font-weight:900;">üíæ Sistema de Dados</p>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px;">
              <button class="btn btn-primary" onclick="verificarDados()">‚úÖ Verificar</button>
              <button class="btn btn-danger" onclick="limparDados()">üóëÔ∏è Limpar Tudo</button>
            </div>

            <div id="diagnostico"
              style="padding:12px; background: var(--bg-darker); border-radius: 12px; border:1px solid var(--border); color: var(--text-secondary); font-size:0.92em; line-height:1.6;">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MODAL EDITAR PRODUTO ===== -->
  <div class="modal-overlay" id="modalEditar">
    <div class="modal-box">
      <div class="modal-header">‚úèÔ∏è EDITAR PRODUTO
        <button class="modal-close" onclick="fecharModal('modalEditar')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">C√≥digo 1</label><input type="text" id="codigo1" class="form-input"></div>
        <div class="form-group"><label class="form-label">C√≥digo 2</label><input type="text" id="codigo2" class="form-input"></div>
        <div class="form-group"><label class="form-label">Nome</label><input type="text" id="nome" class="form-input"></div>
        <div class="form-group">
          <label class="form-label">Categoria</label>
          <select id="setorEdit" class="form-select"></select>
        </div>
        <div class="form-row">
          <div class="form-group"><label class="form-label">Qtd Atual</label><input type="number" id="estAtual" class="form-input" min="0" onchange="salvarEdicaoAuto()"></div>
          <div class="form-group"><label class="form-label">Qtd M√≠n</label><input type="number" id="estMinimo" class="form-input" min="0" onchange="salvarEdicaoAuto()"></div>
        </div>
        <div class="form-group"><label class="form-label">Pre√ßo (R$)</label><input type="number" id="preco" class="form-input" min="0" step="0.01" onchange="salvarEdicaoAuto()"></div>

        <div style="margin-top:10px; padding:12px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.04);">
          <div style="font-weight:1000; color:var(--primary); margin-bottom:6px;">üè¢ Saldos por Setor (Admin)</div>
          <div id="saldoSetoresProduto" style="color:var(--text-secondary); font-size:.92em; line-height:1.6;">
            ‚Äî
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalEditar')">Cancelar</button>
        <button class="btn btn-danger" onclick="deletarProduto()">üóëÔ∏è Deletar</button>
        <button class="btn btn-primary" onclick="salvarEdicao()">‚úÖ Salvar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL RELAT√ìRIO (com pagina√ß√£o) ===== -->
  <div class="modal-overlay" id="modalRelatorio">
    <div class="modal-box">
      <div class="modal-header">
        <span id="relTituloModal">üìä RELAT√ìRIO</span>
        <button class="modal-close" onclick="fecharModal('modalRelatorio')">&times;</button>
      </div>
      <div class="modal-body" id="relConteudoModal">Carregando...</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharModal('modalRelatorio')">Fechar</button>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL DADOS ===== -->
  <div class="modal-overlay" id="modalDados">
    <div class="modal-box">
      <div class="modal-header">üíæ DADOS
        <button class="modal-close" onclick="fecharModal('modalDados')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-secondary); margin-bottom: 10px; font-size: 0.95em; font-weight:900;">Gerencie seus dados:</p>

        <div style="display:grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px;">
          <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üì• Importar JSON</button>
          <button class="btn btn-primary" onclick="exportarJSON()">üì§ Exportar JSON</button>
          <button class="btn btn-primary" onclick="salvarArquivoJSON()" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);">
            üíæ Salvar arquivo .JSON (backup)
          </button>
          <button class="btn btn-primary" onclick="recarregarDoArquivo()" style="background: linear-gradient(135deg, #00d4ff 0%, #00a8cc 100%);">
            üîÑ Recarregar do produtos.json
          </button>
          <button class="btn btn-primary" onclick="exportarCSV()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            üìä Exportar CSV
          </button>
          <button class="btn btn-warning" onclick="exportarMovimentacoesJSON()">üîÅ Exportar Movimenta√ß√µes (JSON)</button>
        </div>

        <input type="file" id="fileInput" accept=".json" style="display:none;" onchange="importarJSON(event)">

        <div style="margin-top:10px; color: var(--text-secondary); font-size:.88em; line-height:1.55;">
          <strong>Offline:</strong> 1¬™ vez online (GitHub Pages) carrega <code>./produtos.json</code> e salva no celular. Depois funciona offline.
        </div>
      </div>
    </div>
  </div>

  <!-- ===== OVERLAY MOVIMENTA√á√ïES (pedido) ===== -->
  <div class="modal-overlay" id="modalMov">
    <div class="modal-box" style="max-width:980px;">
      <div class="modal-header">
        <span>üîÅ MOVIMENTA√á√ïES</span>
        <button class="modal-close" onclick="fecharMovimentacoes()">&times;</button>
      </div>

      <div class="modal-body">
        <div style="display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:12px;">
          <div style="background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:14px; padding:12px;">
            <div style="font-weight:1000; color:var(--primary); margin-bottom:8px;">üßæ Lan√ßamento</div>

            <div class="form-group">
              <label class="form-label">Item</label>
              <select id="movItem" class="form-select"></select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Quantidade</label>
                <input type="number" id="movQtd" class="form-input" min="1" value="1">
              </div>
              <div class="form-group">
                <label class="form-label">Data/Hora</label>
                <input type="text" id="movData" class="form-input" readonly>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Setor origem</label>
                <select id="movOrigem" class="form-select"></select>
              </div>
              <div class="form-group">
                <label class="form-label">Setor destinat√°rio</label>
                <select id="movDestino" class="form-select"></select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Observa√ß√£o</label>
              <textarea id="movObs" class="form-textarea" placeholder="Ex.: retirada para manuten√ß√£o, consumo interno..."></textarea>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-primary" onclick="gravarMovimentacao()">‚úÖ GRAVAR</button>
              <button class="btn btn-secondary" onclick="editarMovimentacao()" id="btnEditarMov" disabled>‚úèÔ∏è EDITAR</button>
              <button class="btn btn-danger" onclick="deletarMovimentacao()" id="btnDeletarMov" disabled>üóëÔ∏è DELETAR</button>
              <button class="btn btn-secondary" onclick="cancelarMovimentacao()">‚Ü©Ô∏è CANCELAR</button>
            </div>

            <div style="margin-top:10px; color:var(--text-secondary); font-size:.9em; line-height:1.55;">
              <strong>Regra:</strong> movimentar reduz/retorna estoque do ALMOXARIFADO e registra saldo por setor (admin).
            </div>
          </div>

          <div style="background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:14px; padding:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
              <div style="font-weight:1000; color:var(--primary);">üìö Hist√≥rico</div>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <input type="search" id="movBusca" placeholder="Buscar por item, setor..." onkeyup="renderizarMovimentacoes()" style="min-width:240px;">
                <button class="btn btn-secondary" onclick="abrirModalRelatorio('mov')">üìä Relat√≥rio</button>
              </div>
            </div>

            <table class="rel-table">
              <thead>
                <tr>
                  <th style="width:70px;">#</th>
                  <th>Item</th>
                  <th style="text-align:center; width:90px;">Qtd</th>
                  <th style="width:160px;">Origem</th>
                  <th style="width:160px;">Destino</th>
                  <th style="width:160px;">Data</th>
                </tr>
              </thead>
              <tbody id="movTable">
                <tr><td colspan="6" style="text-align:center; padding:14px; color:var(--text-secondary);">Carregando...</td></tr>
              </tbody>
            </table>

            <div style="color:var(--text-secondary); font-size:.9em;">
              Toque em uma linha para selecionar e habilitar <strong>Editar/Deletar</strong>.
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="fecharMovimentacoes()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <script>
    // ==========================
    // ‚úÖ LISTA DE SETORES (ADMIN)
    // Substitua por sua lista quando me enviar.
    // ==========================
    const SETORES_ADMIN = [
      "ALMOXARIFADO",
      "ADMINISTRA√á√ÉO",
      "FINANCEIRO",
      "RH",
      "COMPRAS",
      "TI",
      "MANUTEN√á√ÉO"
    ];

    // Categorias do estoque (do seu sistema)
    const SETORES_CATEGORIA = ["CONSUMO","LIMPEZA","ALIMENTOS","CONSTRU√á√ÉO","HIDR√ÅULICA","EL√âTRICA","PAPELARIA","ESCRIT√ìRIO"];

    // Storage keys
    const KEY_PROD = "produtosAlmox";
    const KEY_MOV  = "movAlmox2026";

    let produtos = [];
    let filtrados = [];
    let produtoEditando = null;

    let movimentacoes = [];
    let movSelecionadaId = null;

    // fallback m√≠nimo
    const dadosIniciais = [
      { codigo1:"28912", codigo2:"28192", nome:"FALLBACK - SEM produtos.json", estoqueMin:30, estoqueAtual:40, preco:0, setor:"CONSUMO" }
    ];

    document.addEventListener('DOMContentLoaded', async () => {
      await carregarDados();
      carregarMovimentacoes();

      construirCategorias();
      construirCategoriasNoEdit();
      construirMovSelects();

      filtrar();
      atualizarStats();
      carregarRelatorios();

      exibirToast(produtos.length ? "‚úÖ ALMOX2026 carregado!" : "‚ö†Ô∏è Sem dados. Abra 1x online ou importe JSON.", produtos.length ? "sucesso" : "aviso");
    });

    // ===== Helpers =====
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }
    function exibirToast(msg, tipo='sucesso'){
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = `toast show ${tipo === 'erro' ? 'erro' : tipo === 'aviso' ? 'aviso' : ''}`;
      setTimeout(() => toast.classList.remove('show'), 3200);
    }
    function agoraBR(){
      return new Date().toLocaleString('pt-BR', { hour12:false });
    }
    function normalizarCategoria(p){
      const cat = SETORES_CATEGORIA.find(s => s.toUpperCase() === String(p.setor || '').toUpperCase());
      if (cat) p.setor = cat;
      if (!p.setor) p.setor = "CONSUMO";
      // mapa de saldos por setor admin
      if (!p.alocacoes || typeof p.alocacoes !== "object") p.alocacoes = {};
      SETORES_ADMIN.forEach(s => { if (p.alocacoes[s] == null) p.alocacoes[s] = 0; });
      return p;
    }
    function getProdutoId(p){
      // id est√°vel para movimentos
      return String(p.codigo1 || p.codigo2 || p.nome || Math.random());
    }

    // ===== Carregar dados (1¬™ vez do produtos.json) =====
    async function carregarDados(){
      // 1) localStorage (prioridade)
      const raw = localStorage.getItem(KEY_PROD);
      if (raw){
        try{
          produtos = JSON.parse(raw).map(normalizarCategoria);
          filtrados = [...produtos];
          return;
        }catch(e){
          localStorage.removeItem(KEY_PROD);
        }
      }

      // 2) tentar ./produtos.json (GitHub Pages / servidor)
      try{
        const podeFetch = (location.protocol === 'http:' || location.protocol === 'https:');
        if (podeFetch){
          const resp = await fetch('./produtos.json', { cache: 'no-store' });
          if (resp.ok){
            const data = await resp.json();
            if (data && Array.isArray(data.produtos)){
              produtos = data.produtos.map(p => normalizarCategoria({
                codigo1: p.id || p.codigo1 || 'NULL',
                codigo2: p.sku || p.codigo2 || '',
                nome: p.nome || '',
                estoqueAtual: (p.estoque_atual ?? p.estoqueAtual ?? 0),
                estoqueMin: (p.estoque_minimo ?? p.estoqueMin ?? 0),
                preco: (p.preco_custo ?? p.preco ?? 0),
                setor: p.categoria || p.setor || 'CONSUMO',
                alocacoes: p.alocacoes || undefined
              }));
              salvarDados(false);
              filtrados = [...produtos];
              return;
            }
          }
        }
      }catch(err){}

      // 3) fallback
      produtos = dadosIniciais.map(p => normalizarCategoria({ ...p }));
      salvarDados(false);
      filtrados = [...produtos];
    }

    function salvarDados(recarregar=true){
      localStorage.setItem(KEY_PROD, JSON.stringify(produtos));
      if (recarregar){
        filtrar();
        atualizarStats();
        carregarRelatorios();
      }
    }

    // ===== Movimenta√ß√µes =====
    function carregarMovimentacoes(){
      const raw = localStorage.getItem(KEY_MOV);
      if (!raw){ movimentacoes = []; return; }
      try{
        movimentacoes = JSON.parse(raw) || [];
      }catch(e){
        movimentacoes = [];
      }
    }
    function salvarMovimentacoes(){
      localStorage.setItem(KEY_MOV, JSON.stringify(movimentacoes));
      carregarRelatorios();
      renderizarMovimentacoes();
    }

    function construirMovSelects(){
      // itens
      const selItem = document.getElementById('movItem');
      selItem.innerHTML = '';
      produtos
        .slice()
        .sort((a,b) => (a.nome||'').localeCompare(b.nome||''))
        .forEach(p => {
          const opt = document.createElement('option');
          opt.value = getProdutoId(p);
          opt.textContent = `${p.nome || '-'} ‚Ä¢ ${p.codigo2 || p.codigo1 || ''}`;
          selItem.appendChild(opt);
        });

      // origem/destino (admin)
      const selOrig = document.getElementById('movOrigem');
      const selDest = document.getElementById('movDestino');
      selOrig.innerHTML = '';
      selDest.innerHTML = '';
      SETORES_ADMIN.forEach(s => {
        const o1 = document.createElement('option'); o1.value=s; o1.textContent=s; selOrig.appendChild(o1);
        const o2 = document.createElement('option'); o2.value=s; o2.textContent=s; selDest.appendChild(o2);
      });

      // defaults
      selOrig.value = "ALMOXARIFADO";
      selDest.value = SETORES_ADMIN.find(s => s !== "ALMOXARIFADO") || "ALMOXARIFADO";
      document.getElementById('movData').value = agoraBR();
    }

    function abrirMovimentacoes(){
      // atualiza selects e data
      construirMovSelects();
      document.getElementById('movData').value = agoraBR();
      renderizarMovimentacoes();
      abrirModal('modalMov');

      // destaque no topo
      setTopActive('mov');
      setSidebarActive('mov');
    }
    function fecharMovimentacoes(){
      fecharModal('modalMov');
      // n√£o muda se√ß√£o, s√≥ fecha overlay
    }

    function cancelarMovimentacao(){
      movSelecionadaId = null;
      document.getElementById('movQtd').value = 1;
      document.getElementById('movObs').value = '';
      document.getElementById('movData').value = agoraBR();
      document.getElementById('movOrigem').value = "ALMOXARIFADO";
      document.getElementById('movDestino').value = SETORES_ADMIN.find(s => s !== "ALMOXARIFADO") || "ALMOXARIFADO";
      document.getElementById('btnEditarMov').disabled = true;
      document.getElementById('btnDeletarMov').disabled = true;
      exibirToast('‚Ü©Ô∏è Cancelado', 'aviso');
    }

    function findProdutoById(pid){
      return produtos.find(p => getProdutoId(p) === pid);
    }

    function aplicarMovimentoNoSaldo(prod, origem, destino, qtd, modo){
      // modo: "aplicar" ou "reverter"
      // regra:
      // - ALMOXARIFADO representa estoque central (prod.estoqueAtual)
      // - demais setores ficam em prod.alocacoes[setor]
      const sign = (modo === "aplicar") ? 1 : -1;

      if (origem === destino) throw new Error("Origem e destino n√£o podem ser iguais.");

      // sa√≠da da origem
      if (origem === "ALMOXARIFADO"){
        // baixa do estoque central
        const novo = (prod.estoqueAtual || 0) - (qtd * sign);
        if (modo === "aplicar" && novo < 0) throw new Error("Estoque insuficiente no ALMOXARIFADO.");
        prod.estoqueAtual = Math.max(0, novo);
      } else {
        prod.alocacoes[origem] = (prod.alocacoes[origem] || 0) - (qtd * sign);
        if (modo === "aplicar" && prod.alocacoes[origem] < 0) throw new Error(`Saldo insuficiente no setor ${origem}.`);
      }

      // entrada no destino
      if (destino === "ALMOXARIFADO"){
        prod.estoqueAtual = (prod.estoqueAtual || 0) + (qtd * sign);
        if (prod.estoqueAtual < 0) prod.estoqueAtual = 0;
      } else {
        prod.alocacoes[destino] = (prod.alocacoes[destino] || 0) + (qtd * sign);
        if (prod.alocacoes[destino] < 0) prod.alocacoes[destino] = 0;
      }
    }

    function gravarMovimentacao(){
      try{
        const pid = document.getElementById('movItem').value;
        const qtd = parseInt(document.getElementById('movQtd').value, 10) || 0;
        const origem = document.getElementById('movOrigem').value;
        const destino = document.getElementById('movDestino').value;
        const obs = (document.getElementById('movObs').value || '').trim();

        if (!pid) return exibirToast("‚ùå Selecione um item.", "erro");
        if (qtd <= 0) return exibirToast("‚ùå Quantidade inv√°lida.", "erro");
        if (!origem || !destino) return exibirToast("‚ùå Informe origem e destino.", "erro");
        if (origem === destino) return exibirToast("‚ùå Origem e destino iguais.", "erro");

        const prod = findProdutoById(pid);
        if (!prod) return exibirToast("‚ùå Produto n√£o encontrado.", "erro");

        // Se est√° editando (id setado), redireciona para editar
        if (movSelecionadaId){
          return editarMovimentacao(true);
        }

        // aplica
        aplicarMovimentoNoSaldo(prod, origem, destino, qtd, "aplicar");

        const mov = {
          id: String(Date.now()) + "_" + Math.random().toString(16).slice(2),
          pid,
          nome: prod.nome || '',
          codigo: prod.codigo2 || prod.codigo1 || '',
          qtd,
          origem,
          destino,
          obs,
          data: agoraBR()
        };

        movimentacoes.unshift(mov);
        salvarMovimentacoes();
        salvarDados(true);

        cancelarMovimentacao();
        exibirToast("‚úÖ Movimenta√ß√£o gravada!");
      }catch(err){
        exibirToast("‚ùå " + (err.message || "Erro ao gravar"), "erro");
      }
    }

    function selecionarMov(id){
      const mov = movimentacoes.find(m => m.id === id);
      if (!mov) return;

      movSelecionadaId = id;

      document.getElementById('movItem').value = mov.pid;
      document.getElementById('movQtd').value = mov.qtd;
      document.getElementById('movOrigem').value = mov.origem;
      document.getElementById('movDestino').value = mov.destino;
      document.getElementById('movObs').value = mov.obs || '';
      document.getElementById('movData').value = mov.data || agoraBR();

      document.getElementById('btnEditarMov').disabled = false;
      document.getElementById('btnDeletarMov').disabled = false;
    }

    // editarMovimentacao(forceFromGravar) -> se clicar editar com id selecionado
    function editarMovimentacao(forceFromGravar=false){
      try{
        if (!movSelecionadaId) return exibirToast("‚ö†Ô∏è Selecione uma movimenta√ß√£o na tabela.", "aviso");

        const movAntiga = movimentacoes.find(m => m.id === movSelecionadaId);
        if (!movAntiga) return exibirToast("‚ùå Movimenta√ß√£o n√£o encontrada.", "erro");

        const pid = document.getElementById('movItem').value;
        const qtd = parseInt(document.getElementById('movQtd').value, 10) || 0;
        const origem = document.getElementById('movOrigem').value;
        const destino = document.getElementById('movDestino').value;
        const obs = (document.getElementById('movObs').value || '').trim();

        if (!pid) return exibirToast("‚ùå Selecione um item.", "erro");
        if (qtd <= 0) return exibirToast("‚ùå Quantidade inv√°lida.", "erro");
        if (origem === destino) return exibirToast("‚ùå Origem e destino iguais.", "erro");

        // 1) reverter o impacto antigo
        const prodAntigo = findProdutoById(movAntiga.pid);
        if (!prodAntigo) return exibirToast("‚ùå Produto antigo n√£o encontrado.", "erro");
        aplicarMovimentoNoSaldo(prodAntigo, movAntiga.origem, movAntiga.destino, movAntiga.qtd, "reverter");

        // 2) aplicar o novo
        const prodNovo = findProdutoById(pid);
        if (!prodNovo) return exibirToast("‚ùå Produto novo n√£o encontrado.", "erro");
        aplicarMovimentoNoSaldo(prodNovo, origem, destino, qtd, "aplicar");

        // 3) atualiza registro
        movAntiga.pid = pid;
        movAntiga.nome = prodNovo.nome || '';
        movAntiga.codigo = prodNovo.codigo2 || prodNovo.codigo1 || '';
        movAntiga.qtd = qtd;
        movAntiga.origem = origem;
        movAntiga.destino = destino;
        movAntiga.obs = obs;
        movAntiga.data = agoraBR();

        salvarMovimentacoes();
        salvarDados(true);

        cancelarMovimentacao();
        exibirToast(forceFromGravar ? "‚úÖ Atualizado (modo edi√ß√£o)!" : "‚úÖ Movimenta√ß√£o editada!");
      }catch(err){
        exibirToast("‚ùå " + (err.message || "Erro ao editar"), "erro");
      }
    }

    function deletarMovimentacao(){
      try{
        if (!movSelecionadaId) return exibirToast("‚ö†Ô∏è Selecione uma movimenta√ß√£o.", "aviso");
        if (!confirm("‚ö†Ô∏è Deletar esta movimenta√ß√£o? (O saldo ser√° revertido)")) return;

        const idx = movimentacoes.findIndex(m => m.id === movSelecionadaId);
        if (idx < 0) return exibirToast("‚ùå N√£o encontrada.", "erro");

        const mov = movimentacoes[idx];

        // reverter impacto
        const prod = findProdutoById(mov.pid);
        if (!prod) return exibirToast("‚ùå Produto n√£o encontrado para revers√£o.", "erro");
        aplicarMovimentoNoSaldo(prod, mov.origem, mov.destino, mov.qtd, "reverter");

        movimentacoes.splice(idx, 1);
        salvarMovimentacoes();
        salvarDados(true);

        cancelarMovimentacao();
        exibirToast("üóëÔ∏è Movimenta√ß√£o deletada!");
      }catch(err){
        exibirToast("‚ùå " + (err.message || "Erro ao deletar"), "erro");
      }
    }

    function renderizarMovimentacoes(){
      const tbody = document.getElementById('movTable');
      const q = (document.getElementById('movBusca').value || '').toLowerCase();

      const lista = movimentacoes.filter(m => {
        if (!q) return true;
        return (m.nome||'').toLowerCase().includes(q) ||
               (m.codigo||'').toLowerCase().includes(q) ||
               (m.origem||'').toLowerCase().includes(q) ||
               (m.destino||'').toLowerCase().includes(q) ||
               (m.obs||'').toLowerCase().includes(q);
      });

      if (!lista.length){
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:14px; color:var(--text-secondary);">Nenhuma movimenta√ß√£o</td></tr>`;
        return;
      }

      tbody.innerHTML = lista.map((m, i) => {
        const selected = (m.id === movSelecionadaId);
        return `
          <tr onclick="selecionarMov('${m.id}')" style="cursor:pointer; ${selected ? 'background: rgba(0,212,255,.10);' : ''}">
            <td style="font-weight:1000; color:var(--text-secondary);">#${lista.length - i}</td>
            <td><div style="font-weight:900;">${escapeHtml(m.nome || '-')}</div><div style="font-size:.85em; color:var(--text-secondary);">${escapeHtml(m.codigo || '')}</div></td>
            <td style="text-align:center; font-weight:1000; color:var(--primary);">${m.qtd}</td>
            <td>${escapeHtml(m.origem || '')}</td>
            <td>${escapeHtml(m.destino || '')}</td>
            <td style="font-size:.9em; color:var(--text-secondary);">${escapeHtml(m.data || '')}</td>
          </tr>
        `;
      }).join('');
    }

    // ===== Constru√ß√£o de selects de categorias =====
    function construirCategorias(){
      const select = document.getElementById('setor');
      select.innerHTML = '<option value="">Todos</option>';
      SETORES_CATEGORIA.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s; select.appendChild(opt);
      });
    }
    function construirCategoriasNoEdit(){
      const select = document.getElementById('setorEdit');
      select.innerHTML = '';
      SETORES_CATEGORIA.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s; select.appendChild(opt);
      });
    }

    // ===== Estoque =====
    function obterStatus(p){
      const atual = p.estoqueAtual || 0;
      const min = p.estoqueMin || 0;
      if (atual === 0) return { classe:'vazio', texto:'‚ùå Vazio' };
      if (atual <= min) return { classe:'baixo', texto:'‚ö†Ô∏è Baixo' };
      return { classe:'ok', texto:'‚úÖ OK' };
    }

    function filtrar(){
      const busca = document.getElementById('busca').value.toLowerCase();
      const cat = document.getElementById('setor').value;
      const status = document.getElementById('status').value;

      filtrados = produtos.filter(p => {
        const match = !busca ||
          (p.nome && p.nome.toLowerCase().includes(busca)) ||
          (p.codigo1 && String(p.codigo1).toLowerCase().includes(busca)) ||
          (p.codigo2 && String(p.codigo2).toLowerCase().includes(busca));

        const catMatch = !cat || p.setor === cat;

        let statusMatch = !status;
        const atual = p.estoqueAtual || 0;
        const min = p.estoqueMin || 0;
        if (status === 'ok') statusMatch = atual > min;
        else if (status === 'baixo') statusMatch = atual > 0 && atual <= min;
        else if (status === 'vazio') statusMatch = atual === 0;

        return match && catMatch && statusMatch;
      });

      renderizarCards();
    }

    function renderizarCards(){
      const grid = document.getElementById('gridProdutos');
      grid.innerHTML = '';

      if (filtrados.length === 0){
        grid.innerHTML = '<div style="text-align:center; color: var(--text-secondary); padding:24px; grid-column:1 / -1;">Nenhum produto encontrado</div>';
        return;
      }

      filtrados.forEach(p => {
        const status = obterStatus(p);
        const card = document.createElement('div');
        card.className = 'produto-card';
        card.onclick = () => abrirEdicao(p);
        const codigoPrincipal = (p.codigo2 || p.codigo1 || '-');
        const codigoSec = (p.codigo1 && p.codigo1 !== 'NULL') ? '(' + p.codigo1 + ')' : '';
        card.innerHTML = `
          <div class="card-header">
            <div class="card-codigo">
              <div class="codigo-principal">${escapeHtml(codigoPrincipal)}</div>
              <div class="codigo-secundario">${escapeHtml(codigoSec)}</div>
            </div>
            <span class="card-badge">${escapeHtml(p.setor || 'SEM CATEGORIA')}</span>
          </div>
          <div class="card-titulo">${escapeHtml(p.nome || '-')}</div>
          <div class="card-info">
            <div class="info-item">
              <div class="info-label">üì¶ Quantidade</div>
              <div class="info-value">${(p.estoqueAtual || 0)}/${(p.estoqueMin || 0)}</div>
            </div>
            <div class="info-item">
              <div class="info-label">üí∞ Pre√ßo</div>
              <div class="info-value">R$ ${(p.preco || 0).toFixed(2)}</div>
            </div>
          </div>
          <div class="card-footer">
            <span class="preco">R$ ${(p.preco || 0).toFixed(2)}</span>
            <span class="status-badge status-${status.classe}">${status.texto}</span>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function abrirEdicao(p){
      produtoEditando = p;

      document.getElementById('codigo1').value = p.codigo1 || '';
      document.getElementById('codigo2').value = p.codigo2 || '';
      document.getElementById('nome').value = p.nome || '';
      document.getElementById('setorEdit').value = p.setor || 'CONSUMO';
      document.getElementById('estAtual').value = p.estoqueAtual || 0;
      document.getElementById('estMinimo').value = p.estoqueMin || 0;
      document.getElementById('preco').value = p.preco || 0;

      atualizarSaldoSetoresProduto(p);

      abrirModal('modalEditar');
    }

    function atualizarSaldoSetoresProduto(p){
      const el = document.getElementById('saldoSetoresProduto');
      if (!p || !p.alocacoes){ el.textContent = "‚Äî"; return; }

      const linhas = SETORES_ADMIN
        .filter(s => s !== "ALMOXARIFADO")
        .map(s => `<div><strong>${escapeHtml(s)}:</strong> ${p.alocacoes[s] || 0}</div>`)
        .join('');

      el.innerHTML = `
        <div style="margin-bottom:6px;"><strong>ALMOXARIFADO:</strong> ${p.estoqueAtual || 0}</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px;">${linhas}</div>
      `;
    }

    function salvarEdicaoAuto(){
      if(!produtoEditando) return;
      produtoEditando.codigo1 = document.getElementById('codigo1').value;
      produtoEditando.codigo2 = document.getElementById('codigo2').value;
      produtoEditando.nome = document.getElementById('nome').value;
      produtoEditando.setor = document.getElementById('setorEdit').value;
      produtoEditando.estoqueAtual = parseInt(document.getElementById('estAtual').value, 10) || 0;
      produtoEditando.estoqueMin = parseInt(document.getElementById('estMinimo').value, 10) || 0;
      produtoEditando.preco = parseFloat(document.getElementById('preco').value) || 0;
      normalizarCategoria(produtoEditando);

      salvarDados(true);
      construirMovSelects();
      atualizarSaldoSetoresProduto(produtoEditando);
    }

    function salvarEdicao(){
      salvarEdicaoAuto();
      fecharModal('modalEditar');
    }

    function deletarProduto(){
      if(!produtoEditando) return;
      if(!confirm('‚ö†Ô∏è Tem certeza?')) return;
      produtos = produtos.filter(p => p !== produtoEditando);

      // remove movimenta√ß√µes do produto deletado (opcional: manter hist√≥rico)
      const pid = getProdutoId(produtoEditando);
      movimentacoes = movimentacoes.filter(m => m.pid !== pid);
      salvarMovimentacoes();

      produtoEditando = null;
      salvarDados(true);
      construirMovSelects();
      fecharModal('modalEditar');
      exibirToast('üóëÔ∏è Produto deletado!');
    }

    function limparFiltros(){
      document.getElementById('busca').value = '';
      document.getElementById('setor').value = '';
      document.getElementById('status').value = '';
      filtrar();
    }

    function atualizarStats(){
      let ok = 0, baixo = 0, vazio = 0;
      produtos.forEach(p => {
        const atual = p.estoqueAtual || 0;
        const min = p.estoqueMin || 0;
        if (atual === 0) vazio++;
        else if (atual <= min) baixo++;
        else ok++;
      });
      document.getElementById('statTotal').textContent = produtos.length;
      document.getElementById('statOk').textContent = ok;
      document.getElementById('statBaixo').textContent = baixo;
      document.getElementById('statVazio').textContent = vazio;
    }

    // ===== Relat√≥rios (inclui movimenta√ß√µes + saldos admin) =====
    function carregarRelatorios(){
      // boxes
      document.getElementById('relTotalBox').textContent = produtos.length;

      const criticos = produtos.filter(p => (p.estoqueAtual||0) === 0 || (p.estoqueAtual||0) <= (p.estoqueMin||0));
      document.getElementById('relCriticosBox').textContent = criticos.length;

      document.getElementById('relMovBox').textContent = movimentacoes.length;

      // setor admin box: quantidade de setores com algum saldo
      const setorTemSaldo = {};
      SETORES_ADMIN.forEach(s => setorTemSaldo[s] = 0);
      produtos.forEach(p => {
        SETORES_ADMIN.forEach(s => {
          if (s === "ALMOXARIFADO"){
            if ((p.estoqueAtual||0) > 0) setorTemSaldo[s] += 1;
          }else{
            if ((p.alocacoes?.[s]||0) > 0) setorTemSaldo[s] += 1;
          }
        });
      });
      const setoresComSaldo = Object.entries(setorTemSaldo).filter(([s,v]) => s !== "ALMOXARIFADO" && v > 0).length;
      document.getElementById('relSetoresAdmBox').textContent = setoresComSaldo;

      // tabela por categoria
      const relCats = {};
      SETORES_CATEGORIA.forEach(s => relCats[s] = { total:0, ok:0 });

      produtos.forEach(p => {
        const c = p.setor || 'CONSUMO';
        if(!relCats[c]) relCats[c] = { total:0, ok:0 };
        relCats[c].total++;
        if ((p.estoqueAtual || 0) > (p.estoqueMin || 0)) relCats[c].ok++;
      });

      let html = '';
      Object.entries(relCats).forEach(([s, d]) => {
        html += `<tr><td>${escapeHtml(s)}</td><td style="text-align:center;">${d.total}</td><td style="text-align:center; color: var(--success); font-weight:1000;">${d.ok}</td></tr>`;
      });
      document.getElementById('relSetoresTable').innerHTML = html;

      // criticos top 15
      const top15 = criticos
        .slice()
        .sort((a,b) => (a.estoqueAtual||0) - (b.estoqueAtual||0))
        .slice(0,15);

      html = '';
      top15.forEach(p => {
        const cor = (p.estoqueAtual || 0) === 0 ? 'var(--danger)' : 'var(--warning)';
        html += `<tr>
          <td>${escapeHtml(p.nome || '')}</td>
          <td style="text-align:center; color:${cor}; font-weight:1000;">${p.estoqueAtual || 0}</td>
          <td style="text-align:center; font-size:0.9em; color:var(--text-secondary);">${escapeHtml(p.setor || '')}</td>
        </tr>`;
      });
      document.getElementById('relCriticosTable').innerHTML = html || '<tr><td colspan="3" style="text-align:center; padding:16px; color:var(--text-secondary);">‚úÖ Nenhum</td></tr>';
    }

    function paginarTabela(rowsHtml, headersHtml, pageTitle, rowsPerPage=22){
      // rowsHtml: array de strings <tr>...</tr>
      const total = Math.max(1, Math.ceil(rowsHtml.length / rowsPerPage));
      let out = `<div class="report-pages">`;
      for (let i=0; i<total; i++){
        const slice = rowsHtml.slice(i*rowsPerPage, (i+1)*rowsPerPage).join('');
        out += `
          <div class="report-page">
            <div class="report-page-title">${escapeHtml(pageTitle)} ‚Äî P√°gina ${i+1}/${total}</div>
            <table class="rel-table">
              <thead>${headersHtml}</thead>
              <tbody>${slice || `<tr><td style="padding:12px; color:var(--text-secondary);">Sem dados</td></tr>`}</tbody>
            </table>
            <div class="page-number">${i+1}/${total}</div>
          </div>
        `;
      }
      out += `</div>`;
      return out;
    }

    function abrirModalRelatorio(tipo){
      let titulo = 'üìä RELAT√ìRIO';
      let conteudo = '';

      if (tipo === 'todos'){
        titulo = 'üì¶ PRODUTOS ‚Äî LISTAGEM';
        const rows = produtos
          .slice()
          .sort((a,b) => (a.nome||'').localeCompare(b.nome||''))
          .map(p => `<tr>
            <td>${escapeHtml(p.codigo2 || '')}</td>
            <td>${escapeHtml(p.nome || '')}</td>
            <td style="text-align:center; font-weight:1000; color:var(--primary);">${(p.estoqueAtual||0)}/${(p.estoqueMin||0)}</td>
            <td>${escapeHtml(p.setor || '')}</td>
            <td style="text-align:right; font-weight:1000; color:var(--success);">R$ ${(p.preco||0).toFixed(2)}</td>
          </tr>`);
        const head = `<tr><th>C√≥digo</th><th>Produto</th><th style="text-align:center;">Qtd</th><th>Categoria</th><th style="text-align:right;">Pre√ßo</th></tr>`;
        conteudo = `
          <div class="mini-badges">
            <span class="mini-badge">Total: ${produtos.length}</span>
            <span class="mini-badge">Imprima para ver pagina√ß√£o</span>
          </div>
          ${paginarTabela(rows, head, "Produtos", 18)}
        `;
      }

      else if (tipo === 'criticos'){
        titulo = 'üö® PRODUTOS CR√çTICOS';
        const criticos = produtos
          .filter(p => (p.estoqueAtual||0) === 0 || (p.estoqueAtual||0) <= (p.estoqueMin||0))
          .sort((a,b) => (a.estoqueAtual||0) - (b.estoqueAtual||0));

        const rows = criticos.map(p => {
          const cor = (p.estoqueAtual||0) === 0 ? 'var(--danger)' : 'var(--warning)';
          return `<tr>
            <td>${escapeHtml(p.codigo2 || '')}</td>
            <td>${escapeHtml(p.nome || '')}</td>
            <td style="text-align:center; font-weight:1000; color:${cor};">${p.estoqueAtual||0}</td>
            <td style="text-align:center;">${p.estoqueMin||0}</td>
            <td>${escapeHtml(p.setor||'')}</td>
          </tr>`;
        });
        const head = `<tr><th>C√≥digo</th><th>Produto</th><th style="text-align:center;">Atual</th><th style="text-align:center;">M√≠n</th><th>Categoria</th></tr>`;
        conteudo = `
          <div class="mini-badges">
            <span class="mini-badge">Total cr√≠ticos: ${criticos.length}</span>
          </div>
          ${paginarTabela(rows, head, "Cr√≠ticos", 18)}
        `;
      }

      else if (tipo === 'mov'){
        titulo = 'üîÅ MOVIMENTA√á√ïES ‚Äî RELAT√ìRIO';
        const rows = movimentacoes
          .slice()
          .reverse()
          .map((m, idx) => `<tr>
            <td style="font-weight:1000; color:var(--text-secondary);">#${idx+1}</td>
            <td>${escapeHtml(m.nome || '')}<div style="font-size:.85em; color:var(--text-secondary);">${escapeHtml(m.codigo || '')}</div></td>
            <td style="text-align:center; font-weight:1000; color:var(--primary);">${m.qtd}</td>
            <td>${escapeHtml(m.origem || '')}</td>
            <td>${escapeHtml(m.destino || '')}</td>
            <td style="color:var(--text-secondary); font-size:.9em;">${escapeHtml(m.data || '')}</td>
          </tr>`);
        const head = `<tr><th>#</th><th>Item</th><th style="text-align:center;">Qtd</th><th>Origem</th><th>Destino</th><th>Data</th></tr>`;
        conteudo = `
          <div class="mini-badges">
            <span class="mini-badge">Total: ${movimentacoes.length}</span>
            <span class="mini-badge">Imprim√≠vel</span>
          </div>
          ${paginarTabela(rows, head, "Movimenta√ß√µes", 18)}
        `;
      }

      else if (tipo === 'setoresadm'){
        titulo = 'üè¢ SALDO POR SETOR (ADMIN)';
        // agrega por setor (somat√≥rio de saldos)
        const soma = {};
        SETORES_ADMIN.forEach(s => soma[s] = 0);

        produtos.forEach(p => {
          soma["ALMOXARIFADO"] += (p.estoqueAtual || 0);
          SETORES_ADMIN.forEach(s => {
            if (s === "ALMOXARIFADO") return;
            soma[s] += (p.alocacoes?.[s] || 0);
          });
        });

        const rows = Object.entries(soma)
          .filter(([s,_]) => s !== "ALMOXARIFADO")
          .sort((a,b) => b[1]-a[1])
          .map(([s,val]) => `<tr>
            <td style="font-weight:1000;">${escapeHtml(s)}</td>
            <td style="text-align:right; font-weight:1000; color:var(--primary);">${val}</td>
          </tr>`);

        const head = `<tr><th>Setor</th><th style="text-align:right;">Saldo</th></tr>`;
        conteudo = `
          <div class="mini-badges">
            <span class="mini-badge"><strong>ALMOXARIFADO:</strong> ${soma["ALMOXARIFADO"]}</span>
            <span class="mini-badge">Setores: ${SETORES_ADMIN.length-1}</span>
          </div>
          ${paginarTabela(rows, head, "Saldo por Setor", 22)}
        `;
      }

      document.getElementById('relTituloModal').textContent = titulo;
      document.getElementById('relConteudoModal').innerHTML = conteudo || '<div style="color:var(--text-secondary);">Sem dados.</div>';
      abrirModal('modalRelatorio');
    }

    // ===== Navega√ß√£o / BUG FIX =====
    function setSidebarActive(sec){
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      const el = document.querySelector(`.nav-item[data-sec="${sec}"]`);
      if (el) el.classList.add('active');
    }
    function setTopActive(sec){
      document.getElementById('btnTopEst').classList.toggle('active', sec === 'estoque');
      document.getElementById('btnTopRel').classList.toggle('active', sec === 'relatorio');
      document.getElementById('btnTopMov').classList.toggle('active', sec === 'mov');
      // dados √© modal, n√£o se√ß√£o
    }

    function mudarSecao(sec, el){
      // fecha modais de se√ß√£o, caso existam
      // (mant√©m overlay de movimenta√ß√µes s√≥ se voc√™ abrir)
      document.querySelectorAll('.section').forEach(e => e.style.display = 'none');

      if (sec === 'estoque'){
        document.getElementById('secEstoque').style.display = 'flex';
        document.getElementById('titulo').textContent = 'üì¶ ESTOQUE';
        filtrar();
        setTopActive('estoque');
        setSidebarActive('estoque');
      }
      else if (sec === 'relatorio'){
        document.getElementById('secRelatorio').style.display = 'block';
        document.getElementById('titulo').textContent = 'üìä RELAT√ìRIOS';
        carregarRelatorios();
        setTopActive('relatorio');
        setSidebarActive('relatorio');
      }
      else if (sec === 'config'){
        document.getElementById('secConfig').style.display = 'block';
        document.getElementById('titulo').textContent = '‚öôÔ∏è CONFIG';
        setTopActive('config');
        setSidebarActive('config');
      }

      // se clicou pela sidebar, mant√©m active l√° tamb√©m
      if (el && el.classList){
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
      }
    }

    // ===== Modais =====
    function abrirModal(id){ document.getElementById(id).classList.add('active'); }
    function fecharModal(id){ document.getElementById(id).classList.remove('active'); }
    function abrirModalDados(){ abrirModal('modalDados'); }

    window.addEventListener('click', (e) => {
      if (e.target.classList && e.target.classList.contains('modal-overlay')){
        // n√£o fecha o overlay de movimenta√ß√µes com clique fora? aqui fecha sim
        e.target.classList.remove('active');
      }
    });

    // ===== Import/Export =====
    function importarJSON(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          let dados = JSON.parse(ev.target.result);

          if (dados && typeof dados === 'object' && !Array.isArray(dados) && Array.isArray(dados.produtos)){
            dados = dados.produtos;
          }

          if (Array.isArray(dados) && dados.length){
            const mapeados = dados.map(p => normalizarCategoria({
              codigo1: p.id || p.codigo1 || 'NULL',
              codigo2: p.sku || p.codigo2 || '',
              nome: p.nome || '',
              estoqueAtual: (p.estoque_atual ?? p.estoqueAtual ?? 0),
              estoqueMin: (p.estoque_minimo ?? p.estoqueMin ?? 0),
              preco: (p.preco_custo ?? p.preco ?? 0),
              setor: p.categoria || p.setor || 'CONSUMO',
              alocacoes: p.alocacoes || undefined
            }));

            const substituir = confirm('‚ùì SUBSTITUIR dados atuais?\nOK = Sim\nCancel = Mesclar');
            if (substituir) produtos = mapeados;
            else produtos = [...produtos, ...mapeados];

            salvarDados(true);
            construirMovSelects();
            exibirToast(`‚úÖ ${mapeados.length} importados!`);
            fecharModal('modalDados');
            e.target.value = '';
          } else {
            exibirToast('‚ö†Ô∏è JSON vazio ou inv√°lido', 'aviso');
          }
        }catch(err){
          exibirToast('‚ùå Erro ao ler JSON', 'erro');
        }
      };
      reader.readAsText(file);
    }

    function exportarJSON(){
      const json = JSON.stringify(produtos, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `almox2026_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      exibirToast('‚úÖ JSON exportado!');
    }

    async function salvarArquivoJSON(){
      try{
        const json = JSON.stringify(produtos, null, 2);

        if (window.showSaveFilePicker){
          const suggestedName = `almox2026_${new Date().toISOString().split('T')[0]}.json`;
          const handle = await window.showSaveFilePicker({
            suggestedName,
            types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(json);
          await writable.close();
          exibirToast('üíæ Arquivo .JSON salvo!');
          return;
        }

        const blob = new Blob([json], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `almox2026_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        exibirToast('üíæ Arquivo .JSON gerado!');
      }catch(err){
        exibirToast('‚ùå N√£o foi poss√≠vel salvar o arquivo', 'erro');
      }
    }

    async function recarregarDoArquivo(){
      try{
        const podeFetch = (location.protocol === 'http:' || location.protocol === 'https:');
        if (!podeFetch){
          exibirToast('‚ö†Ô∏è Para carregar do arquivo, use GitHub Pages/servidor.', 'aviso');
          return;
        }

        const resp = await fetch('./produtos.json', { cache: 'no-store' });
        if (!resp.ok){
          exibirToast('‚ùå N√£o achei o produtos.json no projeto.', 'erro');
          return;
        }

        const data = await resp.json();
        if (!data || !Array.isArray(data.produtos)){
          exibirToast('‚ùå produtos.json inv√°lido (esperado: { "produtos": [...] })', 'erro');
          return;
        }

        produtos = data.produtos.map(p => normalizarCategoria({
          codigo1: p.id || p.codigo1 || 'NULL',
          codigo2: p.sku || p.codigo2 || '',
          nome: p.nome || '',
          estoqueAtual: (p.estoque_atual ?? p.estoqueAtual ?? 0),
          estoqueMin: (p.estoque_minimo ?? p.estoqueMin ?? 0),
          preco: (p.preco_custo ?? p.preco ?? 0),
          setor: p.categoria || p.setor || 'CONSUMO',
          alocacoes: p.alocacoes || undefined
        }));

        salvarDados(true);
        construirMovSelects();
        exibirToast('‚úÖ Recarregado do produtos.json e salvo offline!');
        fecharModal('modalDados');
      }catch(err){
        exibirToast('‚ùå Falha ao carregar do arquivo (offline?)', 'erro');
      }
    }

    function exportarCSV(){
      let csv = 'C√≥digo1,C√≥digo2,Nome,Categoria,Estoque Atual,Estoque M√≠nimo,Pre√ßo\n';
      produtos.forEach(p => {
        csv += `"${String(p.codigo1 || '').replace(/"/g,'""')}","${String(p.codigo2 || '').replace(/"/g,'""')}","${String(p.nome || '').replace(/"/g,'""')}","${String(p.setor || '').replace(/"/g,'""')}",${p.estoqueAtual || 0},${p.estoqueMin || 0},${p.preco || 0}\n`;
      });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `almox2026_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      exibirToast('‚úÖ CSV exportado!');
    }

    function exportarMovimentacoesJSON(){
      const json = JSON.stringify({ movimentacoes }, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `movimentacoes_almox2026_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      exibirToast('‚úÖ Movimenta√ß√µes exportadas!');
    }

    function verificarDados(){
      const tamanho = new Blob([JSON.stringify(localStorage)]).size;
      document.getElementById('diagnostico').innerHTML = `
        <p>üì¶ <strong>Produtos:</strong> ${produtos.length}</p>
        <p>üîÅ <strong>Movimenta√ß√µes:</strong> ${movimentacoes.length}</p>
        <p>üè¢ <strong>Setores Admin:</strong> ${SETORES_ADMIN.length - 1}</p>
        <p>üíæ <strong>Tamanho (local):</strong> ${(tamanho / 1024).toFixed(2)} KB</p>
        <p>üïê <strong>Agora:</strong> ${agoraBR()}</p>
        <p style="margin-top:10px; font-weight:1000; color:var(--success);">‚úÖ Sistema OK!</p>
      `;
    }

    function limparDados(){
      if(!confirm('‚ö†Ô∏è Tem certeza? Isso apaga PRODUTOS e MOVIMENTA√á√ïES locais.')) return;
      localStorage.clear();
      produtos = [];
      movimentacoes = [];
      filtrados = [];

      document.getElementById('gridProdutos').innerHTML =
        '<div style="text-align:center; color: var(--text-secondary); padding:24px;">Dados locais apagados. Abra 1x online para carregar produtos.json ou importe JSON.</div>';

      atualizarStats();
      carregarRelatorios();
      exibirToast('üóëÔ∏è Dados locais apagados!', 'aviso');
    }
  </script>
</body>
</html>
