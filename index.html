
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Almoxarifado Pro - Controle de Estoque</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00d4ff;
            --primary-dark: #00a8cc;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f0f1e;
            --bg-darker: #0a0a14;
            --bg-card: #1a1a2e;
            --bg-hover: #252541;
            --text-primary: #e0e0ff;
            --text-secondary: #a0a0c0;
            --border: #3a3a5c;
        }

        html, body {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
        }

        .app {
            display: grid;
            grid-template-columns: 260px 1fr;
            height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: fixed;
            width: 260px;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 200;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--bg-dark);
            padding: 16px;
            text-align: center;
            font-weight: 700;
            font-size: 1em;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 14px 16px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--primary);
            border-left-color: var(--primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--bg-hover);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .sidebar-actions {
            padding: 12px;
            border-top: 1px solid var(--border);
            display: grid;
            gap: 6px;
        }

        .action-btn {
            width: 100%;
            padding: 10px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: var(--primary);
            color: var(--bg-dark);
            border-color: var(--primary);
        }

        /* ===== CONTAINER ===== */
        .container {
            margin-left: 260px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--bg-dark);
            padding: 20px 24px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .header-left {
            flex: 1;
        }

        .header-title {
            font-size: 1.8em;
            font-weight: 800;
            margin: 0;
            margin-bottom: 8px;
        }

        .header-stats {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: 800;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-header {
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-header:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
            transform: translateY(-2px);
        }

        .filtros {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filtro-label {
            font-size: 0.7em;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
        }

        input[type="search"], select {
            padding: 10px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input[type="search"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.2);
        }

        .btn-filtro {
            padding: 10px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8em;
        }

        .btn-filtro:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .produtos-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .produto-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .produto-card:active {
            transform: scale(0.98);
        }

        .produto-card:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .card-codigo {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .codigo-principal {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
        }

        .codigo-secundario {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .card-badge {
            display: inline-block;
            padding: 6px 10px;
            background: var(--secondary);
            color: white;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .card-titulo {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            background: var(--bg-hover);
            border-radius: 6px;
        }

        .info-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .preco {
            font-size: 1em;
            font-weight: 700;
            color: var(--success);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 700;
        }

        .status-ok {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-baixo {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-vazio {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-box {
            background: var(--bg-card);
            border-radius: 16px;
            border: 2px solid var(--primary);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--bg-dark);
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 1.2em;
            border-radius: 14px 14px 0 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            font-size: 0.8em;
            color: var(--text-primary);
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--bg-dark);
            flex: 1;
        }

        .btn-primary:hover {
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
            flex: 1;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.8;
        }

        .toast {
            position: fixed;
            bottom: -100px;
            right: 12px;
            min-width: 280px;
            background: var(--success);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transition: bottom 0.3s ease;
            font-weight: 600;
            font-size: 0.9em;
        }

        .toast.show {
            bottom: 20px;
        }

        .toast.erro {
            background: var(--danger);
        }

        .toast.aviso {
            background: var(--warning);
        }

        /* ===== CAIXAS DE RESUMO CLIC√ÅVEIS ===== */
        .stat-box-wrapper {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: var(--bg-hover);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.2);
        }

        .stat-box-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stat-box-value {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-box.success .stat-box-value { color: var(--success); }
        .stat-box.warning .stat-box-value { color: var(--warning); }
        .stat-box.danger .stat-box-value { color: var(--danger); }

        /* ===== TABELAS EM MODAIS ===== */
        .rel-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-hover);
            border-radius: 6px;
            overflow: hidden;
            font-size: 0.85em;
            margin-bottom: 16px;
        }

        .rel-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--bg-dark);
        }

        .rel-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 700;
        }

        .rel-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .rel-table tbody tr:last-child td {
            border-bottom: none;
        }

        .rel-table tbody tr:hover {
            background: var(--bg-card);
        }

        @media print {
            .modal-footer, .btn, .modal-close {
                display: none !important;
            }
            .modal-box {
                max-width: 100%;
                border: none;
                box-shadow: none;
            }
            .modal-header {
                border-radius: 0;
            }
        }

        @media (max-width: 1024px) {
            .app {
                grid-template-columns: 1fr;
            }
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 1px solid var(--border);
                flex-direction: row;
            }
            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                flex: 1;
            }
            .nav-item {
                border-left: none;
                border-bottom: 3px solid transparent;
                white-space: nowrap;
            }
            .container {
                margin-left: 0;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px;
                gap: 12px;
            }
            .header-title {
                font-size: 1.2em;
                margin-bottom: 6px;
            }
            .header-stats {
                gap: 4px;
                font-size: 0.7em;
            }
            .stat-item {
                padding: 4px 8px;
            }
            .stat-value {
                font-size: 1.1em;
            }
            .stat-box-wrapper {
                grid-template-columns: 1fr;
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-hover);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">üì¶ ALMOXARIFADO</div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="mudarSecao('estoque')">üì¶ Estoque</div>
                <div class="nav-item" onclick="mudarSecao('relatorio')">üìä Relat√≥rios</div>
                <div class="nav-item" onclick="abrirModalDados()">üíæ Dados</div>
                <div class="nav-item" onclick="mudarSecao('config')">‚öôÔ∏è Config</div>
            </div>
            <div class="sidebar-actions">
                <button class="action-btn" onclick="abrirModalDados()">üíæ Dados</button>
                <button class="action-btn" onclick="mudarSecao('relatorio')">üìä Relat√≥rios</button>
            </div>
        </div>

        <!-- CONTAINER -->
        <div class="container">
            <!-- HEADER -->
            <div class="header">
                <div class="header-left">
                    <div class="header-title" id="titulo">üì¶ ESTOQUE</div>
                    <div class="header-stats">
                        <div class="stat-item">
                            <span>Total:</span>
                            <span class="stat-value" id="statTotal">0</span>
                        </div>
                        <div class="stat-item" style="background: rgba(16, 185, 129, 0.2);">
                            <span>‚úÖ OK:</span>
                            <span class="stat-value" id="statOk" style="color: var(--success);">0</span>
                        </div>
                        <div class="stat-item" style="background: rgba(245, 158, 11, 0.2);">
                            <span>‚ö†Ô∏è Baixo:</span>
                            <span class="stat-value" id="statBaixo" style="color: var(--warning);">0</span>
                        </div>
                        <div class="stat-item" style="background: rgba(239, 68, 68, 0.2);">
                            <span>‚ùå Vazio:</span>
                            <span class="stat-value" id="statVazio" style="color: var(--danger);">0</span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-header" onclick="abrirModalDados()">üíæ Dados</button>
                    <button class="btn-header" onclick="mudarSecao('relatorio')">üìä Relat√≥rios</button>
                </div>
            </div>

            <!-- SE√á√ÉO ESTOQUE -->
            <div id="secEstoque" class="section" style="display: flex; flex-direction: column; flex: 1;">
                <div class="filtros">
                    <div class="filtro-group">
                        <label class="filtro-label">üîç Buscar</label>
                        <input type="search" id="busca" placeholder="Nome, c√≥digo..." onkeyup="filtrar()">
                    </div>
                    <div class="filtro-group">
                        <label class="filtro-label">üìÇ Setor</label>
                        <select id="setor" onchange="filtrar()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-group">
                        <label class="filtro-label">‚ö†Ô∏è Status</label>
                        <select id="status" onchange="filtrar()">
                            <option value="">Todos</option>
                            <option value="ok">‚úÖ OK</option>
                            <option value="baixo">‚ö†Ô∏è Baixo</option>
                            <option value="vazio">‚ùå Vazio</option>
                        </select>
                    </div>
                    <button class="btn-filtro" onclick="limparFiltros()" style="width: 100%;">üîÑ Limpar</button>
                </div>

                <div class="content">
                    <div class="produtos-grid" id="gridProdutos">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">Carregando...</div>
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO RELAT√ìRIOS -->
            <div id="secRelatorio" class="section" style="display: none; flex: 1; overflow-y: auto;">
                <div class="content">
                    <h2 style="color: var(--primary); margin-bottom: 20px; font-size: 1.6em;">üìä RELAT√ìRIOS</h2>
                    
                    <h3 style="color: var(--text-primary); margin-bottom: 12px;">üìà Resumo Geral</h3>
                    <div class="stat-box-wrapper">
                        <div class="stat-box" onclick="abrirModalRelatorio('todos')">
                            <div class="stat-box-label">üì¶ Total</div>
                            <div class="stat-box-value" id="relTotalBox">0</div>
                        </div>
                        <div class="stat-box success" onclick="abrirModalRelatorio('ok')">
                            <div class="stat-box-label">‚úÖ OK</div>
                            <div class="stat-box-value" id="relOkBox">0</div>
                        </div>
                        <div class="stat-box warning" onclick="abrirModalRelatorio('baixo')">
                            <div class="stat-box-label">‚ö†Ô∏è Baixo</div>
                            <div class="stat-box-value" id="relBaixoBox">0</div>
                        </div>
                        <div class="stat-box danger" onclick="abrirModalRelatorio('vazio')">
                            <div class="stat-box-label">‚ùå Vazio</div>
                            <div class="stat-box-value" id="relVazioBox">0</div>
                        </div>
                    </div>

                    <h3 style="color: var(--text-primary); margin-top: 24px; margin-bottom: 12px;">üìÇ Por Setor</h3>
                    <table class="rel-table" onclick="abrirModalSetores()">
                        <thead>
                            <tr>
                                <th>Setor</th>
                                <th style="text-align: center;">Total</th>
                                <th style="text-align: center;">OK</th>
                            </tr>
                        </thead>
                        <tbody id="relSetoresTable">
                            <tr><td colspan="3" style="text-align: center; padding: 16px;">Carregando...</td></tr>
                        </tbody>
                    </table>

                    <h3 style="color: var(--danger); margin-top: 24px; margin-bottom: 12px;">üö® Produtos Cr√≠ticos (Clique para detalhes)</h3>
                    <table class="rel-table" onclick="abrirModalCriticos()">
                        <thead>
                            <tr style="background: linear-gradient(135deg, var(--danger) 0%, #c91e3a 100%); color: white;">
                                <th>Produto</th>
                                <th style="text-align: center;">Qty</th>
                                <th style="text-align: center;">Setor</th>
                            </tr>
                        </thead>
                        <tbody id="relCriticosTable">
                            <tr><td colspan="3" style="text-align: center; padding: 16px;">‚úÖ Nenhum cr√≠tico</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SE√á√ÉO CONFIG -->
            <div id="secConfig" class="section" style="display: none; flex: 1; overflow-y: auto;">
                <div class="content">
                    <h2 style="color: var(--primary); margin-bottom: 16px;">‚öôÔ∏è CONFIGURA√á√ïES</h2>
                    <div style="background: var(--bg-hover); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">
                        <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.95em;">üíæ Sistema de Dados</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                            <button class="btn btn-primary" onclick="verificarDados()" style="margin-top: 0;">‚úÖ Verificar</button>
                            <button class="btn btn-danger" onclick="limparDados()">üóëÔ∏è Limpar Tudo</button>
                        </div>
                        <div id="diagnostico" style="padding: 12px; background: var(--bg-darker); border-radius: 6px; border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL EDITAR PRODUTO ===== -->
    <div class="modal-overlay" id="modalEditar">
        <div class="modal-box">
            <div class="modal-header">
                ‚úèÔ∏è EDITAR PRODUTO
                <button class="modal-close" onclick="fecharModal('modalEditar')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">C√≥digo 1</label>
                    <input type="text" id="codigo1" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">C√≥digo 2</label>
                    <input type="text" id="codigo2" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" id="nome" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Setor</label>
                    <select id="setorEdit" class="form-select">
                        <option>CONSUMO</option>
                        <option>LIMPEZA</option>
                        <option>ALIMENTOS</option>
                        <option>CONSTRU√á√ÉO</option>
                        <option>HIDR√ÅULICA</option>
                        <option>EL√âTRICA</option>
                        <option>PAPELARIA</option>
                        <option>ESCRIT√ìRIO</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Estoque Atual</label>
                        <input type="number" id="estAtual" class="form-input" min="0" onchange="salvarEdicaoAuto()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estoque M√≠n</label>
                        <input type="number" id="estMinimo" class="form-input" min="0" onchange="salvarEdicaoAuto()">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Pre√ßo (R$)</label>
                    <input type="number" id="preco" class="form-input" min="0" step="0.01" onchange="salvarEdicaoAuto()">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalEditar')">Cancelar</button>
                <button class="btn btn-danger" onclick="deletarProduto()">üóëÔ∏è Deletar</button>
                <button class="btn btn-primary" onclick="salvarEdicao()">‚úÖ Salvar</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL RELAT√ìRIO (DIN√ÇMICO) ===== -->
    <div class="modal-overlay" id="modalRelatorio">
        <div class="modal-box">
            <div class="modal-header">
                <span id="relTituloModal">üìä RELAT√ìRIO</span>
                <button class="modal-close" onclick="fecharModal('modalRelatorio')">&times;</button>
            </div>
            <div class="modal-body" id="relConteudoModal">
                Carregando...
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal('modalRelatorio')">Fechar</button>
                <button class="btn btn-primary" onclick="imprimirRelatorio()">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL DADOS ===== -->
    <div class="modal-overlay" id="modalDados">
        <div class="modal-box">
            <div class="modal-header">
                üíæ DADOS
                <button class="modal-close" onclick="fecharModal('modalDados')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9em;">Gerencie seus dados:</p>
                <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üì• Importar JSON</button>
                    <button class="btn btn-primary" onclick="exportarJSON()">üì§ Exportar JSON</button>
                    <button class="btn btn-primary" onclick="exportarCSV()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üìä Exportar CSV</button>
                </div>
                <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="importarJSON(event)">
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <script>
        let produtos = [];
        let filtrados = [];
        let setores = new Set();
        let produtoEditando = null;

        const SETORES_UNICOS = ["CONSUMO", "LIMPEZA", "ALIMENTOS", "CONSTRU√á√ÉO", "HIDR√ÅULICA", "EL√âTRICA", "PAPELARIA", "ESCRIT√ìRIO"];

        const dadosIniciais = [
            { codigo1: "28912", codigo2: "28192", nome: "GUARDANAPO DE PAPEL PEQUENO FOLHA DUPLAS 50 UNIDADES", estoqueMin: 30, estoqueAtual: 40, preco: 0, setor: "CONSUMO" },
            { codigo1: "prod_986409", codigo2: "986409", nome: "√ìLEO DE SOJA 900ML", estoqueMin: 100, estoqueAtual: 11, preco: 0, setor: "ALIMENTOS" },
            { codigo1: "prod_110009", codigo2: "110009", nome: "√ÅGUA PERFUMADA ODORIZANTE LONGA DURA√á√ÉO 340ML", estoqueMin: 50, estoqueAtual: 98, preco: 0, setor: "LIMPEZA" },
            { codigo1: "17635735718525700", codigo2: "110001", nome: "√ÅGUA SANIT√ÅRIA 1LT", estoqueMin: 50, estoqueAtual: 200, preco: 0, setor: "LIMPEZA" },
            { codigo1: "prod_110002", codigo2: "110002", nome: "√ÅGUA SANIT√ÅRIA FRASCO 2L", estoqueMin: 300, estoqueAtual: 1206, preco: 0, setor: "LIMPEZA" },
            { codigo1: "prod_110004", codigo2: "110004", nome: "√ÅLCOOL ET√çLICO 46¬∫ INPM ABRE E FECHA 1 LT", estoqueMin: 20, estoqueAtual: 70, preco: 0, setor: "LIMPEZA" },
            { codigo1: "prod_110003", codigo2: "110003", nome: "√ÅLCOOL ET√çLICO HIDRATADO GEL 70 INPM 460G", estoqueMin: 100, estoqueAtual: 210, preco: 0, setor: "LIMPEZA" },
            { codigo1: "prod_110500", codigo2: "110500", nome: "√ÅLCOOL L√çQUIDO 70", estoqueMin: 100, estoqueAtual: 0, preco: 0, setor: "LIMPEZA" },
            { codigo1: "prod_130002", codigo2: "130002", nome: "A√á√öCAR CRISTAL BRANCO TIPO I PACOTE 5KG", estoqueMin: 100, estoqueAtual: 213, preco: 0, setor: "ALIMENTOS" },
            { codigo1: "NULL", codigo2: "123", nome: "ABRA√áADEIRA A√áO TIPO U COMUM 1/2\"", estoqueMin: 0, estoqueAtual: 0, preco: 0.35, setor: "CONSTRU√á√ÉO" }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            construirSetores();
            filtrar();
            atualizarStats();
            carregarRelatorios();
            exibirToast('‚úÖ Sistema carregado!');
        });

        function carregarDados() {
            const dados = localStorage.getItem('produtosAlmox');
            if (dados) {
                try {
                    produtos = JSON.parse(dados);
                    produtos.forEach(p => {
                        const setorNormalizado = SETORES_UNICOS.find(s => s.toUpperCase() === (p.setor || '').toUpperCase());
                        if(setorNormalizado) p.setor = setorNormalizado;
                    });
                } catch(e) {
                    produtos = dadosIniciais;
                    salvarDados();
                }
            } else {
                produtos = dadosIniciais;
                salvarDados();
            }
            filtrados = [...produtos];
        }

        function salvarDados() {
            localStorage.setItem('produtosAlmox', JSON.stringify(produtos));
            carregarDados();
            filtrar();
            atualizarStats();
        }

        function construirSetores() {
            const select = document.getElementById('setor');
            select.innerHTML = '<option value="">Todos</option>';
            SETORES_UNICOS.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                select.appendChild(opt);
            });
        }

        function filtrar() {
            const busca = document.getElementById('busca').value.toLowerCase();
            const setor = document.getElementById('setor').value;
            const status = document.getElementById('status').value;

            filtrados = produtos.filter(p => {
                const match = !busca || 
                    (p.nome && p.nome.toLowerCase().includes(busca)) ||
                    (p.codigo1 && p.codigo1.toLowerCase().includes(busca)) ||
                    (p.codigo2 && p.codigo2.toLowerCase().includes(busca));

                const setorMatch = !setor || p.setor === setor;

                let statusMatch = !status;
                if(status === 'ok') statusMatch = (p.estoqueAtual || 0) > (p.estoqueMin || 0);
                else if(status === 'baixo') statusMatch = (p.estoqueAtual || 0) > 0 && (p.estoqueAtual || 0) <= (p.estoqueMin || 0);
                else if(status === 'vazio') statusMatch = (p.estoqueAtual || 0) === 0;

                return match && setorMatch && statusMatch;
            });

            renderizarCards();
        }

        function renderizarCards() {
            const grid = document.getElementById('gridProdutos');
            grid.innerHTML = '';

            if(filtrados.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 24px; grid-column: 1 / -1;">Nenhum produto encontrado</div>';
                return;
            }

            filtrados.forEach((p) => {
                const status = obterStatus(p);
                const card = document.createElement('div');
                card.className = 'produto-card';
                card.onclick = () => abrirEdicao(p);
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-codigo">
                            <div class="codigo-principal">${p.codigo2 || p.codigo1 || '-'}</div>
                            <div class="codigo-secundario">${p.codigo1 && p.codigo1 !== 'NULL' ? '('+p.codigo1+')' : ''}</div>
                        </div>
                        <span class="card-badge">${p.setor || 'SEM SETOR'}</span>
                    </div>
                    <div class="card-titulo">${p.nome || '-'}</div>
                    <div class="card-info">
                        <div class="info-item">
                            <div class="info-label">üì¶ Estoque</div>
                            <div class="info-value">${p.estoqueAtual || 0}/${p.estoqueMin || 0}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">üí∞ Pre√ßo</div>
                            <div class="info-value">R$ ${(p.preco || 0).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span class="preco">R$ ${(p.preco || 0).toFixed(2)}</span>
                        <span class="status-badge status-${status.classe}">${status.texto}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function obterStatus(p) {
            const atual = p.estoqueAtual || 0;
            const min = p.estoqueMin || 0;
            if(atual === 0) return { classe: 'vazio', texto: '‚ùå Vazio' };
            if(atual <= min) return { classe: 'baixo', texto: '‚ö†Ô∏è Baixo' };
            return { classe: 'ok', texto: '‚úÖ OK' };
        }

        function abrirEdicao(p) {
            produtoEditando = p;
            document.getElementById('codigo1').value = p.codigo1 || '';
            document.getElementById('codigo2').value = p.codigo2 || '';
            document.getElementById('nome').value = p.nome || '';
            document.getElementById('setorEdit').value = p.setor || 'CONSUMO';
            document.getElementById('estAtual').value = p.estoqueAtual || 0;
            document.getElementById('estMinimo').value = p.estoqueMin || 0;
            document.getElementById('preco').value = p.preco || 0;
            abrirModal('modalEditar');
        }

        function salvarEdicaoAuto() {
            if(!produtoEditando) return;
            produtoEditando.codigo1 = document.getElementById('codigo1').value;
            produtoEditando.codigo2 = document.getElementById('codigo2').value;
            produtoEditando.nome = document.getElementById('nome').value;
            produtoEditando.setor = document.getElementById('setorEdit').value;
            produtoEditando.estoqueAtual = parseInt(document.getElementById('estAtual').value) || 0;
            produtoEditando.estoqueMin = parseInt(document.getElementById('estMinimo').value) || 0;
            produtoEditando.preco = parseFloat(document.getElementById('preco').value) || 0;
            salvarDados();
            filtrar();
        }

        function salvarEdicao() {
            salvarEdicaoAuto();
            fecharModal('modalEditar');
        }

        function deletarProduto() {
            if(!produtoEditando) return;
            if(!confirm('‚ö†Ô∏è Tem certeza?')) return;
            produtos = produtos.filter(p => p !== produtoEditando);
            salvarDados();
            filtrar();
            fecharModal('modalEditar');
            exibirToast('üóëÔ∏è Deletado!');
        }

        function limparFiltros() {
            document.getElementById('busca').value = '';
            document.getElementById('setor').value = '';
            document.getElementById('status').value = '';
            filtrar();
        }

        function atualizarStats() {
            let ok = 0, baixo = 0, vazio = 0;
            produtos.forEach(p => {
                const atual = p.estoqueAtual || 0;
                const min = p.estoqueMin || 0;
                if(atual === 0) vazio++;
                else if(atual <= min) baixo++;
                else ok++;
            });
            document.getElementById('statTotal').textContent = produtos.length;
            document.getElementById('statOk').textContent = ok;
            document.getElementById('statBaixo').textContent = baixo;
            document.getElementById('statVazio').textContent = vazio;
        }

        function carregarRelatorios() {
            let ok = 0, baixo = 0, vazio = 0;
            produtos.forEach(p => {
                const atual = p.estoqueAtual || 0;
                const min = p.estoqueMin || 0;
                if(atual === 0) vazio++;
                else if(atual <= min) baixo++;
                else ok++;
            });

            document.getElementById('relTotalBox').textContent = produtos.length;
            document.getElementById('relOkBox').textContent = ok;
            document.getElementById('relBaixoBox').textContent = baixo;
            document.getElementById('relVazioBox').textContent = vazio;

            // Por setor
            const relSetores = {};
            SETORES_UNICOS.forEach(s => {
                relSetores[s] = { total: 0, ok: 0 };
            });

            produtos.forEach(p => {
                const setor = p.setor || 'CONSUMO';
                if(!relSetores[setor]) relSetores[setor] = { total: 0, ok: 0 };
                relSetores[setor].total++;
                if((p.estoqueAtual || 0) > (p.estoqueMin || 0)) relSetores[setor].ok++;
            });

            let html = '';
            Object.entries(relSetores).forEach(([s, d]) => {
                html += `<tr><td>${s}</td><td style="text-align: center;">${d.total}</td><td style="text-align: center; color: var(--success);">${d.ok}</td></tr>`;
            });
            document.getElementById('relSetoresTable').innerHTML = html;

            // Cr√≠ticos
            const criticos = produtos.filter(p => {
                const atual = p.estoqueAtual || 0;
                const min = p.estoqueMin || 0;
                return atual === 0 || atual <= min;
            }).sort((a, b) => (a.estoqueAtual || 0) - (b.estoqueAtual || 0)).slice(0, 15);

            html = '';
            criticos.forEach(p => {
                html += `<tr><td>${p.nome}</td><td style="text-align: center; color: ${(p.estoqueAtual || 0) === 0 ? 'var(--danger)' : 'var(--warning)'};">${p.estoqueAtual || 0}</td><td style="text-align: center; font-size: 0.8em;">${p.setor}</td></tr>`;
            });
            document.getElementById('relCriticosTable').innerHTML = html || '<tr><td colspan="3" style="text-align: center; padding: 16px;">‚úÖ Nenhum</td></tr>';
        }

        function abrirModalRelatorio(tipo) {
            let titulo = '';
            let conteudo = '';

            if(tipo === 'todos') {
                titulo = 'üì¶ TODOS OS PRODUTOS';
                const tabela = produtos.map(p => {
                    const status = obterStatus(p);
                    return `<tr><td>${p.codigo2}</td><td>${p.nome}</td><td style="text-align: center;">${p.estoqueAtual}/${p.estoqueMin}</td><td>${p.setor}</td><td style="text-align: right;">R$ ${(p.preco || 0).toFixed(2)}</td></tr>`;
                }).join('');
                conteudo = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">Total de ${produtos.length} produtos no estoque</p>
                    <table class="rel-table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th style="text-align: center;">Estoque</th>
                                <th>Setor</th>
                                <th style="text-align: right;">Pre√ßo</th>
                            </tr>
                        </thead>
                        <tbody>${tabela}</tbody>
                    </table>
                `;
            } else if(tipo === 'ok') {
                titulo = '‚úÖ PRODUTOS COM ESTOQUE OK';
                const ok = produtos.filter(p => (p.estoqueAtual || 0) > (p.estoqueMin || 0));
                const tabela = ok.map(p => `<tr><td>${p.codigo2}</td><td>${p.nome}</td><td style="text-align: center;">${p.estoqueAtual}</td><td>${p.setor}</td></tr>`).join('');
                conteudo = `
                    <p style="color: var(--success); margin-bottom: 16px;">‚úÖ ${ok.length} produtos com estoque acima do m√≠nimo</p>
                    <table class="rel-table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th style="text-align: center;">Qtd</th>
                                <th>Setor</th>
                            </tr>
                        </thead>
                        <tbody>${tabela}</tbody>
                    </table>
                `;
            } else if(tipo === 'baixo') {
                titulo = '‚ö†Ô∏è ESTOQUE BAIXO';
                const baixo = produtos.filter(p => (p.estoqueAtual || 0) > 0 && (p.estoqueAtual || 0) <= (p.estoqueMin || 0));
                const tabela = baixo.map(p => `<tr><td>${p.codigo2}</td><td>${p.nome}</td><td style="text-align: center; color: var(--warning);">${p.estoqueAtual}/${p.estoqueMin}</td><td>${p.setor}</td></tr>`).join('');
                conteudo = `
                    <p style="color: var(--warning); margin-bottom: 16px;">‚ö†Ô∏è ${baixo.length} produtos com estoque baixo</p>
                    <table class="rel-table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th style="text-align: center;">Estoque</th>
                                <th>Setor</th>
                            </tr>
                        </thead>
                        <tbody>${tabela}</tbody>
                    </table>
                `;
            } else if(tipo === 'vazio') {
                titulo = '‚ùå ESTOQUE ZERADO';
                const vazio = produtos.filter(p => (p.estoqueAtual || 0) === 0);
                const tabela = vazio.map(p => `<tr><td>${p.codigo2}</td><td>${p.nome}</td><td style="text-align: center; color: var(--danger);">0</td><td>${p.setor}</td></tr>`).join('');
                conteudo = `
                    <p style="color: var(--danger); margin-bottom: 16px;">‚ùå ${vazio.length} produtos sem estoque</p>
                    <table class="rel-table">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th style="text-align: center;">Qtd</th>
                                <th>Setor</th>
                            </tr>
                        </thead>
                        <tbody>${tabela}</tbody>
                    </table>
                `;
            }

            document.getElementById('relTituloModal').textContent = titulo;
            document.getElementById('relConteudoModal').innerHTML = conteudo;
            abrirModal('modalRelatorio');
        }

        function abrirModalSetores() {
            const relSetores = {};
            SETORES_UNICOS.forEach(s => {
                relSetores[s] = { total: 0, ok: 0, produtos: [] };
            });

            produtos.forEach(p => {
                const setor = p.setor || 'CONSUMO';
                if(!relSetores[setor]) relSetores[setor] = { total: 0, ok: 0, produtos: [] };
                relSetores[setor].total++;
                relSetores[setor].produtos.push(p);
                if((p.estoqueAtual || 0) > (p.estoqueMin || 0)) relSetores[setor].ok++;
            });

            let conteudo = '<h3 style="color: var(--primary); margin-bottom: 16px;">Distribui√ß√£o por Setor</h3>';
            Object.entries(relSetores).forEach(([s, d]) => {
                const tabela = d.produtos.map(p => `<tr><td>${p.codigo2}</td><td>${p.nome}</td><td style="text-align: center;">${p.estoqueAtual}</td></tr>`).join('');
                conteudo += `
                    <h4 style="color: var(--secondary); margin-top: 16px; margin-bottom: 8px;">${s} (${d.total} produtos)</h4>
                    <table class="rel-table" style="margin-bottom: 12px;">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th style="text-align: center;">Qtd</th>
                            </tr>
                        </thead>
                        <tbody>${tabela}</tbody>
                    </table>
                `;
            });

            document.getElementById('relTituloModal').textContent = 'üìÇ RELAT√ìRIO POR SETOR';
            document.getElementById('relConteudoModal').innerHTML = conteudo;
            abrirModal('modalRelatorio');
        }

        function abrirModalCriticos() {
            const criticos = produtos.filter(p => {
                const atual = p.estoqueAtual || 0;
                const min = p.estoqueMin || 0;
                return atual === 0 || atual <= min;
            }).sort((a, b) => (a.estoqueAtual || 0) - (b.estoqueAtual || 0));

            const tabela = criticos.map(p => {
                const cor = (p.estoqueAtual || 0) === 0 ? 'var(--danger)' : 'var(--warning)';
                return `<tr><td>${p.codigo2}</td><td>${p.nome}</td><td style="text-align: center; color: ${cor};">${p.estoqueAtual || 0}</td><td style="text-align: center;">${p.estoqueMin}</td><td>${p.setor}</td></tr>`;
            }).join('');

            const conteudo = criticos.length > 0 ? `
                <p style="color: var(--danger); margin-bottom: 16px;">üö® ${criticos.length} produtos com estoque cr√≠tico (zerado ou abaixo do m√≠nimo)</p>
                <table class="rel-table">
                    <thead>
                        <tr style="background: linear-gradient(135deg, var(--danger) 0%, #c91e3a 100%); color: white;">
                            <th>C√≥digo</th>
                            <th>Produto</th>
                            <th style="text-align: center;">Atual</th>
                            <th style="text-align: center;">M√≠n</th>
                            <th>Setor</th>
                        </tr>
                    </thead>
                    <tbody>${tabela}</tbody>
                </table>
            ` : '<p style="color: var(--success); text-align: center; padding: 20px;">‚úÖ Nenhum produto cr√≠tico!</p>';

            document.getElementById('relTituloModal').textContent = 'üö® PRODUTOS CR√çTICOS';
            document.getElementById('relConteudoModal').innerHTML = conteudo;
            abrirModal('modalRelatorio');
        }

        function imprimirRelatorio() {
            window.print();
            exibirToast('üñ®Ô∏è Enviado para impressora!');
        }

        function mudarSecao(sec) {
            document.querySelectorAll('.section').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            
            if(sec === 'estoque') {
                document.getElementById('secEstoque').style.display = 'flex';
                document.getElementById('titulo').textContent = 'üì¶ ESTOQUE';
            } else if(sec === 'relatorio') {
                document.getElementById('secRelatorio').style.display = 'flex';
                document.getElementById('titulo').textContent = 'üìä RELAT√ìRIOS';
                carregarRelatorios();
            } else if(sec === 'config') {
                document.getElementById('secConfig').style.display = 'flex';
                document.getElementById('titulo').textContent = '‚öôÔ∏è CONFIG';
            }
            
            event.target.closest('.nav-item').classList.add('active');
        }

        function abrirModal(id) { document.getElementById(id).classList.add('active'); }
        function fecharModal(id) { document.getElementById(id).classList.remove('active'); }

        function abrirModalDados() { abrirModal('modalDados'); }

        window.onclick = function(e) {
            if(e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        }

        function importarJSON(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const dados = JSON.parse(event.target.result);
                                    // Tratar formato especial: [ {}, "produtos", ":", [...] ]
                                    if (Array.isArray(dados) && dados.length > 3 && dados[1] === 'produtos' && dados[2] === ':' && Array.isArray(dados[3])) {
                                                            dados = dados[3];
                                                        }
                                    // Tratar formato: { "produtos": [...] }
                                    if (dados && typeof dados === 'object' && !Array.isArray(dados) && dados.produtos && Array.isArray(dados.produtos)) {
                                                            dados = dados.produtos;
                                                        }
                    if(Array.isArray(dados) && dados.length > 0) {
                                        dados = dados.map(p => {
                                            // Mapear nova estrutura JSON para estrutura interna
                                            const produtoMapeado = {
                        codigo1: p.id || p.codigo1 || 'NULL',
                            codigo2: p.sku || p.codigo2 || '',
                            nome: p.nome || '',
                                                estoqueAtual: p.estoque_atual !== undefined ? p.estoque_atual : (p.estoqueAtual || 0),
                                                                    estoqueMin: p.estoque_minimo !== undefined ? p.estoque_minimo : (p.estoqueMin || 0),
                            preco: p.preco_custo !== undefined ? p.preco_custo : (p.preco || 0),
                                                                    setor: p.categoria || p.setor || 'CONSUMO',
                            ncm: p.ncm || '',
                                                                    descricao: p.descricao || '',
                                                                    numero_sequencial: p.numero_sequencial,
                                                                    linha_excel: p.linha_excel
                                                                                        };

                                // Normalizar o setor
                                            const setorEncontrado = SETORES_UNICOS.find(s => s.toUpperCase() === (produtoMapeado.setor || '').toUpperCase());
                                            if(setorEncontrado) produtoMapeado.setor = setorEncontrado;

                                            // Retornar o produto mapeado para a lista
                                            return produtoMapeado;
                        });

                        const modo = confirm('‚ùì SUBSTITUIR dados atuais?\nOK = Sim\nCancel = Mesclar');
                        if(modo) {
                            produtos = dados;
                        } else {
                            produtos = [...produtos, ...dados];
                        }
                        salvarDados();
                        filtrar();
                        carregarRelatorios();
                        exibirToast(`‚úÖ ${dados.length} importados!`);
                        fecharModal('modalDados');
                    }
                } catch(err) {
                    exibirToast('‚ùå Erro ao ler JSON', 'erro');
                }
            };
            reader.readAsText(file);
        }

        function exportarJSON() {
            const json = JSON.stringify(produtos, null, 2);
            const blob = new Blob([json], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `almoxarifado_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            exibirToast('‚úÖ JSON exportado!');
        }

        function exportarCSV() {
            let csv = 'C√≥digo1,C√≥digo2,Nome,Setor,Estoque Atual,Estoque M√≠nimo,Pre√ßo\n';
            produtos.forEach(p => {
                csv += `"${(p.codigo1 || '').replace(/"/g, '""')}","${(p.codigo2 || '').replace(/"/g, '""')}","${(p.nome || '').replace(/"/g, '""')}","${(p.setor || '').replace(/"/g, '""')}",${p.estoqueAtual || 0},${p.estoqueMin || 0},${p.preco || 0}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `almoxarifado_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            exibirToast('‚úÖ CSV exportado!');
        }

        function verificarDados() {
            const tamanho = new Blob([JSON.stringify(localStorage)]).size;
            document.getElementById('diagnostico').innerHTML = `
                <p>üì¶ <strong>Produtos:</strong> ${produtos.length}</p>
                <p>üìÇ <strong>Setores √∫nicos:</strong> ${new Set(produtos.map(p => p.setor)).size}</p>
                <p>üíæ <strong>Tamanho:</strong> ${(tamanho / 1024).toFixed(2)} KB</p>
                <p>üïê <strong>Atualizado:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                <p style="margin-top: 12px;">‚úÖ Sistema OK!</p>
            `;
        }

        function limparDados() {
            if(!confirm('‚ö†Ô∏è Tem certeza?')) return;
            localStorage.clear();
            produtos = dadosIniciais;
            salvarDados();
            exibirToast('üóëÔ∏è Resetado!');
        }

        function exibirToast(msg, tipo = 'sucesso') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast show ${tipo === 'erro' ? 'erro' : tipo === 'aviso' ? 'aviso' : ''}`;
            setTimeout(() => toast.classList.remove('show'), 3500);
        }
    </script>
</body>
</html>
