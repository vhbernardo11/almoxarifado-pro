
<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>ALMOX2026 ‚Ä¢ Offline (Base)</title>
<style>
  :root{
    --bg0:#0b0d18; --bg1:#11142a; --card:#171b34; --card2:#1c2140;
    --txt:#e9ecff; --muted:#aab0d8; --pri:#00d4ff; --sec:#7c3aed;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    color:var(--txt);
    background:radial-gradient(1200px 700px at 20% 0%, #15204a 0%, var(--bg0) 60%);
    overflow-x:hidden;
  }

  /* ===== Floating Nav (n√£o fixa conte√∫do) ===== */
  .fnav{
    position:fixed; left:50%; transform:translateX(-50%);
    top:10px; z-index:9999;
    display:flex; gap:12px; align-items:center; justify-content:center;
    padding:14px 16px 18px;
    background:rgba(23,27,52,.92);
    border:1px solid var(--line);
    border-radius:26px;
    /* blur removido (Android Chrome evita artefatos) */
    backdrop-filter:none; -webkit-backdrop-filter:none;
box-shadow:0 14px 40px rgba(0,0,0,.45);
    max-width:calc(100vw - 16px);
  }
  .fbtn{
    width:58px;height:58px;border-radius:18px;border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    display:flex;align-items:center;justify-content:center;
    font-size:28px; cursor:pointer; user-select:none;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
    touch-action:manipulation;
  }
  .fbtn:active{transform:scale(.96)}
  .fbtn:hover{border-color:rgba(0,212,255,.35)}
  .fhandle{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:8px; width:84px; height:7px; border-radius:999px;
    background:rgba(255,255,255,.35);
  }

  main{padding:108px 12px 18px}
  .topbar{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin:0 2px 12px;}
  .title{font-weight:950; font-size:24px; letter-spacing:.3px}
  .pill{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; font-size:12px; color:var(--muted)}
  .pill span{background:rgba(255,255,255,.06); border:1px solid var(--line); padding:6px 10px; border-radius:999px}
  .muted{color:var(--muted)}
  .search{
    margin:10px 2px 14px;
    background:rgba(255,255,255,.06); border:1px solid var(--line);
    border-radius:16px; padding:12px;
    display:flex; gap:10px; align-items:center;
  }
  .search input{
    width:100%; border:none; outline:none; background:transparent; color:var(--txt);
    font-size:16px;
  }

  .grid{display:grid; gap:12px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    box-shadow:0 8px 24px rgba(0,0,0,.28);
  }
  .row{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
  .code{color:var(--pri); font-weight:900}
  .cat{font-size:12px; background:rgba(124,58,237,.22); border:1px solid rgba(124,58,237,.35); padding:6px 10px; border-radius:999px}
  .name{margin-top:8px; font-weight:850; line-height:1.25}
  .meta{margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .box{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.09); border-radius:14px; padding:10px}
  .lbl{font-size:11px;color:var(--muted);font-weight:800;letter-spacing:.4px}
  .val{margin-top:4px;font-size:16px;font-weight:950}
  .status{
    margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;
    border-top:1px solid rgba(255,255,255,.08); padding-top:12px;
  }
  .badge{font-weight:950; font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid transparent}
  .ok{background:rgba(16,185,129,.18); color:var(--ok); border-color:rgba(16,185,129,.28)}
  .low{background:rgba(245,158,11,.18); color:var(--warn); border-color:rgba(245,158,11,.28)}
  .zero{background:rgba(239,68,68,.18); color:var(--bad); border-color:rgba(239,68,68,.28)}

  /* ===== Modal (sheet) ===== */
  .modal{
    position:fixed; inset:0; z-index:10000;
    background:rgba(0,0,0,.62);
    display:none; align-items:flex-end; justify-content:center;
    padding:12px;
  }
  .modal.active{display:flex}
  .sheet{
    width:100%; max-width:820px; max-height:88vh; overflow:auto;
    background:rgba(23,27,52,.98);
    border:1px solid var(--line);
    border-radius:20px 20px 0 0;
    box-shadow:0 24px 70px rgba(0,0,0,.6);
  }
  .mhead{
    position:sticky; top:0; z-index:2;
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#041018;
    padding:14px 14px 12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:950;
    border-radius:18px 18px 0 0;
  }
  .mhead .x{
    width:40px;height:40px;border-radius:999px;border:none;
    background:rgba(255,255,255,.25); color:#fff; font-size:20px; cursor:pointer;
  }
  .mbar{width:80px;height:7px;border-radius:999px;background:rgba(255,255,255,.55); margin:10px auto 0}
  .mbody{padding:14px}
  .group{margin-bottom:12px}
  label{display:block;font-size:12px;color:rgba(255,255,255,.85);font-weight:900;letter-spacing:.3px;margin-bottom:6px}
  input,select,textarea{
    width:100%; padding:12px 12px; border-radius:14px;
    border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
    color:var(--txt); outline:none; font-size:16px;
  }
  textarea{min-height:84px; resize:vertical}
  .twocol{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:12px 14px 16px; border-top:1px solid rgba(255,255,255,.10)}
  .btn{
    border:none; border-radius:16px; padding:14px 12px;
    font-weight:950; cursor:pointer; font-size:15px;
    touch-action:manipulation;
  }
  .primary{background:linear-gradient(135deg,var(--pri),#00a8cc); color:#041018}
  .secondary{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:var(--txt)}
  .danger{background:var(--bad); color:#fff}

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:11000;
    background:rgba(23,27,52,.96); border:1px solid var(--line);
    padding:10px 14px; border-radius:999px; font-weight:900;
    display:none;
  }
  .toast.show{display:block}

  @media (max-width:360px){
    .fbtn{width:54px;height:54px;border-radius:16px}
    .meta{grid-template-columns:1fr}
  }

  /* ===== Sugest√µes (movimenta√ß√µes) ===== */
  .sug-item{
    padding:12px 12px;
    background:rgba(255,255,255,.04);
    border-bottom:1px solid rgba(255,255,255,.10);
    cursor:pointer;
  }
  .sug-item:last-child{border-bottom:none}
  .sug-item:hover{background:rgba(0,212,255,.10)}
  .sug-title{font-weight:950}
  .sug-sub{margin-top:4px;font-size:12px;color:var(--muted);font-weight:800}

  
  /* Ajuste: bot√µes do modal Relat√≥rios centralizados */
  #modalRel .twocol{width:100%}
  #modalRel .twocol .btn{width:100%}

  
  /* ===== Relat√≥rios (tabs) ===== */
  .rt-switch{display:flex;gap:8px;flex-wrap:wrap}
  .rt-tab{
    flex:1 1 auto;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:rgba(255,255,255,.92);
    font-weight:950;
    letter-spacing:.2px;
    cursor:pointer;
    white-space:nowrap;
    text-align:center;
    -webkit-tap-highlight-color: transparent;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
  }
  .rt-tab:active{transform:scale(.98)}
  .rt-tab.active{
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#08101a;
    border-color:transparent;
  }
  @media (max-width:420px){
    .rt-tab{flex:1 1 48%}
  }

/* ===== Relat√≥rios (tabelas) ===== */
  .rt-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px}
  .rt-title{font-weight:950;font-size:16px;margin-bottom:6px}
  .rt-sub{color:var(--muted);font-weight:800;font-size:12px;margin-bottom:10px}
  .rt-table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid rgba(255,255,255,.12)}
  .rt-table thead th{
    text-align:left; padding:10px 10px;
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#041018; font-weight:950; font-size:12px;
  }
  .rt-table tbody td{padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.10); font-size:12px; vertical-align:top}
  .rt-table tbody tr:nth-child(even){background:rgba(255,255,255,.04)}
  .rt-table tbody tr:last-child td{border-bottom:none}
  .rt-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:950;font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}

  /* ===== Setores ===== */
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:380px){ .grid2{grid-template-columns:1fr} }
  .set-card{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    transition:transform .15s ease, border-color .15s ease, background .15s ease;
  }
  .set-card:active{transform:scale(.98)}
  .set-card:hover{border-color:rgba(0,212,255,.45); background:rgba(0,212,255,.08)}
  .set-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
  .set-name{font-weight:950; font-size:13px; letter-spacing:.2px}
  .set-chip{padding:4px 8px;border-radius:999px;font-weight:950;font-size:11px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
  .set-sub{margin-top:8px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35}
  .set-num{font-weight:950;color:var(--pri)}

  /* Anti-banding: aumenta opacidade dos cards no Android Chrome */
  .pCard,.prod-card,.cardItem,.itemCard,.produto-card{
    background:rgba(26,28,52,.92) !important;
  }

  /* ===== Notas (XML NF-e) ===== */
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
  .pill b{color:var(--txt)}
  .nfgrid{display:grid;grid-template-columns:1fr;gap:10px}
  .nftable{width:100%;border-collapse:separate;border-spacing:0 8px}
  .nftable th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
  .nftable td{padding:0 6px}
  .nftable .row{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden}
  .nftable .row td{padding:8px 8px}
  .nftable input,.nftable select{width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:var(--txt);outline:none}
  .nftable input:focus,.nftable select:focus{border-color:rgba(0,212,255,.55);box-shadow:0 0 0 3px rgba(0,212,255,.12)}
  .tagOk{color:var(--ok);font-weight:900}
  .tagWarn{color:var(--warn);font-weight:900}
  .nfactions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .muteline{height:1px;background:var(--line);margin:10px 0}


  /* ===== Hist√≥rico de Notas ===== */
  .filters{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:10px;
  }
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:10px 0}
  .kpi{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
  }
  .kpi .lbl{color:var(--muted); font-size:12px}
  .kpi .val{font-size:18px; font-weight:800; margin-top:4px}
  .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:16px}
  table.tbl{width:100%;border-collapse:collapse;min-width:860px;background:rgba(0,0,0,.12)}
  .tbl th,.tbl td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left;vertical-align:top}
  .tbl th{position:sticky;top:0;background:rgba(23,27,52,.92);backdrop-filter:none}
  .subtxt{color:var(--muted);font-size:12px}


  /* ===== Relat√≥rios (padroniza√ß√£o moderna) ===== */
  .rel-card{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    border-radius:18px;
    padding:14px;
    box-shadow:0 14px 40px rgba(0,0,0,.25);
  }
  .rel-top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .rel-title{font-size:18px;font-weight:900;letter-spacing:.2px}
  .rel-sub{color:var(--muted);margin-top:4px;font-weight:700}
  .rel-chip{
    padding:8px 10px;border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.20);
    font-weight:900; font-size:12px; white-space:nowrap
  }
  .rel-kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:12px}
  .kpi{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:10px}
  .kpi .k{color:var(--muted);font-weight:800;font-size:12px}
  .kpi .v{font-weight:950;font-size:16px;margin-top:2px}
  @media (max-width:560px){ .rel-kpis{grid-template-columns:repeat(2,minmax(0,1fr));} }

  .chk{display:flex;gap:10px;align-items:center;font-weight:800;color:rgba(233,236,255,.92);padding:8px 10px;border:1px solid rgba(255,255,255,.12);border-radius:14px;background:rgba(0,0,0,.16)}
  .chk input{transform:scale(1.1)}
  .rel-table{width:100%;border-collapse:collapse;margin-top:12px; overflow:hidden; border-radius:14px}
  .rel-table thead th{
    text-align:left; font-size:12px; color:rgba(233,236,255,.86);
    padding:10px; border-bottom:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.22);
    position:sticky; top:0;
  }
  .rel-table tbody td{
    padding:10px; border-bottom:1px solid rgba(255,255,255,.10);
    vertical-align:top; font-size:13px
  }
  .rel-table tbody tr:hover{background:rgba(255,255,255,.04)}
  .rel-pill{
    display:inline-flex; align-items:center; justify-content:center;
    padding:5px 10px; border-radius:999px; font-weight:950; font-size:12px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.18);
  }
  .rel-pill.ok{border-color:rgba(16,185,129,.55); background:rgba(16,185,129,.12)}
  .rel-pill.warn{border-color:rgba(245,158,11,.55); background:rgba(245,158,11,.12)}
  .rel-pill.bad{border-color:rgba(239,68,68,.55); background:rgba(239,68,68,.12)}

  .rel-section{margin-top:12px}
  .rel-sec-top{display:flex;justify-content:space-between;gap:10px;align-items:baseline;margin:8px 2px 6px}
  .rel-sec-title{font-weight:950}
  .rel-sec-sub{color:var(--muted);font-weight:800;font-size:12px}

</style>
</head>
<body>
<!-- Floating nav -->
<div class="fnav" id="fnav">
<div class="fbtn" id="btnEstoque" title="Estoque">üì¶</div>
<div class="fbtn" id="btnMov" title="Movimenta√ß√µes">üîÅ</div>
<div class="fbtn" id="btnRel" title="Relat√≥rios">üìä</div>
<div class="fbtn" id="btnSet" title="Setores">üèõÔ∏è</div>
<div class="fbtn" id="btnNotas" title="Entrada de Notas (XML)">üßæ</div>
<div class="fbtn" id="btnHistNotas" title="Hist√≥rico de Notas">üìö</div>
<div class="fbtn" id="btnDados" title="Dados">üíæ</div>
<div class="fhandle" id="fhandle"></div>
</div>
<main>
<div class="topbar">
<div>
<div class="title">ALMOX2026</div>
<div class="muted" style="margin-top:4px;font-weight:700">Base Offline ‚Ä¢ Importar JSON em Dados</div>
</div>
<div class="pill">
<span>Total: <b id="statTotal">0</b></span>
<span style="color:var(--ok)">OK: <b id="statOk">0</b></span>
<span style="color:var(--warn)">Baixo: <b id="statLow">0</b></span>
<span style="color:var(--bad)">Zerado: <b id="statZero">0</b></span>
</div>
</div>
<div class="search">
<span style="font-size:18px">üîé</span>
<input id="q" placeholder="Buscar por nome, c√≥digo, classifica√ß√£o..." type="search"/>
</div>
<div class="grid" id="grid"></div>
</main>
<!-- MODAL: DADOS -->
<div aria-hidden="true" class="modal" id="modalDados">
<div class="sheet">
<div class="mhead">
<div>üíæ Dados</div>
<button class="x" data-close="modalDados">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<button class="btn primary" id="btnImport">üì• Importar JSON</button>
<input accept=".json" id="fileInput" style="display:none" type="file"/>
</div>
<div class="card" id="camposBox" style="margin-top:10px; display:none;">
  <div style="font-weight:900">Campos detectados no JSON</div>
  <div class="muted" style="margin-top:6px;font-size:12px;">O sistema vai mapear automaticamente estes campos.</div>
  <div id="camposDetectados" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;"></div>
</div>
<div class="group">
<button class="btn secondary" id="btnExport">üì§ Exportar JSON (produtos + movimenta√ß√µes)</button>
</div>
<div class="group">
<button class="btn secondary" id="btnExportCSV">üìÑ Exportar CSV (produtos)</button>
</div>
</div>
<div class="group">
  <button class="btn secondary" id="btnExportNotas">üßæ Exportar Notas (JSON)</button>
</div>
<div class="group">
  <button class="btn secondary" id="btnImportNotas">üßæ Importar Notas (JSON)</button>
  <input accept=".json" id="notasInput" style="display:none" type="file"/>
</div>

<div class="group" style="display:grid; gap:8px;">
<div class="muted" style="font-weight:850;">üîó Vincular arquivo (opcional)</div>
<button class="btn secondary" id="btnLinkFile">üìé Escolher arquivo .json (lembrar)</button>
<button class="btn secondary" disabled="" id="btnSaveToLinked">üíæ Salvar no mesmo arquivo</button>
<div class="muted" id="dbFileStatus" style="font-size:13px;line-height:1.35;">
          Nenhum arquivo vinculado.
        </div>
</div>
<div class="group muted" style="font-size:13px;line-height:1.4">
<b>Offline (Android/Chrome):</b> o navegador n√£o consegue ‚Äúalterar o JSON do reposit√≥rio‚Äù.
        O que ele faz √© salvar tudo no aparelho e, quando voc√™ quiser, exporta um novo JSON j√° com as movimenta√ß√µes.
        <div style="margin-top:8px"><b>Dica:</b> se o bot√£o <i>Salvar no mesmo arquivo</i> n√£o funcionar no seu celular, use o <i>Exportar</i>.</div>
</div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalDados">Fechar</button>
<button class="btn secondary" id="btnReset">üßπ Limpar dados do aparelho</button>
</div>
</div>
</div>
<!-- MODAL: EDITAR PRODUTO -->
<div aria-hidden="true" class="modal" id="modalProduto">
<div class="sheet">
<div class="mhead">
<div>‚úèÔ∏è Editar produto</div>
<button class="x" data-close="modalProduto">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<label>C√≥digo 1</label>
<input id="pCodigo1">
</input></div>
<div class="group">
<label>C√≥digo 2</label>
<input id="pCodigo2"/>
</div>
<div class="group">
<label>Nome</label>
<input id="pNome"/>
</div>
<div class="group">
<label>Classifica√ß√£o (do JSON)</label>
<select id="pCategoria"></select>
</div>
<div class="twocol">
<div class="group">
<label>NCM</label>
<input id="pNcm" placeholder="Ex.: 8203.20.10"/>
</div>
<div class="group">
<label>Setor (campo do JSON)</label>
<input id="pSetor" placeholder="Ex.: ALMOXARIFADO"/>
</div>
</div>
<div class="group" style="margin-top:-4px;">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
<input id="pAtivo" type="checkbox" style="width:18px;height:18px;"/>
<span>Ativo</span>
</label>
</div>
<div class="twocol">
<div class="group">
<label>Estoque atual (Almoxarifado)</label>
<input id="pAtual" min="0" type="number"/>
</div>
<div class="group">
<label>Estoque m√≠nimo</label>
<input id="pMin" min="0" type="number"/>
</div>
</div>
<div class="group">
<label>Pre√ßo</label>
<input id="pPreco" min="0" step="0.01" type="number"/>
</div>
<div class="group">
<label>Descri√ß√£o</label>
<textarea id="pDesc" placeholder="Opcional"></textarea>
</div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalProduto">Cancelar</button>
<button class="btn danger" id="btnDelProd">üóëÔ∏è Deletar</button>
<button class="btn primary" id="btnSaveProd">‚úÖ Salvar</button>
</div>
</div>
</div>
<!-- MODAL: MOVIMENTA√á√ïES (1 tela) -->
<div aria-hidden="true" class="modal" id="modalMov">
<div class="sheet">
<div class="mhead">
<div>üîÅ Movimenta√ß√µes</div>
<button class="x" data-close="modalMov">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<label>Item (digite para buscar)</label>
<input autocomplete="off" id="mItem" placeholder="Ex.: sulfite, martelo..."/>
<div id="mSug" style="display:none; margin-top:8px; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden;"></div>
</div>
<div class="twocol">
<div class="group">
<label>Quantidade</label>
<input id="mQtd" min="1" type="number" value="1"/>
</div>
<div class="group">
<label>Data/Hora</label>
<input id="mQuando" type="datetime-local"/>
</div>
</div>
<div class="group">
<label>Setor origem</label>
<select id="mOrig"></select>
</div>
<div class="group">
<label>Setor destinat√°rio</label>
<select id="mDest"></select>
</div>
<div class="group">
<label>Observa√ß√£o</label>
<input id="mObs" placeholder="Opcional"/>
</div>
<div class="group">
<button class="btn primary" id="btnGravarMov">‚úÖ Gravar movimenta√ß√£o</button>
</div>
<div class="group">
<div class="muted" style="font-weight:900;margin-bottom:8px">√öltimas movimenta√ß√µes</div>
<div id="movList"></div>
</div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalMov">Fechar</button>
<button class="btn secondary" id="btnExportMov">üì§ Exportar Movimenta√ß√µes</button>
</div>
</div>
</div>
<!-- MODAL: EDITAR/EXCLUIR MOVIMENTA√á√ÉO -->
<div aria-hidden="true" class="modal" id="modalMovEdit">
<div class="sheet">
<div class="sheet-hd">
<div class="sheet-title">‚úèÔ∏è Editar movimenta√ß√£o</div>
<button class="x" onclick="fecharModal('modalMovEdit')">√ó</button>
</div>
<div class="sheet-bd">
<div class="grid2">
<div class="field" style="grid-column:1/-1">
<label>Item</label>
<input class="inp" id="meItem" readonly="" type="text"/>
<div class="hint">Item n√£o pode ser trocado aqui (para manter o v√≠nculo com o estoque). Se precisar trocar, delete e grave outra.</div>
</div>
<div class="field">
<label>Quantidade</label>
<input class="inp" id="meQtd" inputmode="numeric" min="1" type="number"/>
</div>
<div class="field">
<label>Data/Hora</label>
<input class="inp" id="meQuando" type="datetime-local"/>
</div>
<div class="field">
<label>Setor origem</label>
<select class="inp" id="meOrig"></select>
</div>
<div class="field">
<label>Setor destinat√°rio</label>
<select class="inp" id="meDest"></select>
</div>
<div class="field" style="grid-column:1/-1">
<label>Observa√ß√£o</label>
<input class="inp" id="meObs" placeholder="Opcional" type="text"/>
</div>
</div>
<div class="muted" id="meInfo" style="margin-top:10px;font-weight:900"></div>
</div>
<div class="sheet-ft">
<button class="btn ghost" onclick="fecharModal('modalMovEdit')">Cancelar</button>
<button class="btn danger" id="btnMovEditDel">üóëÔ∏è Deletar</button>
<button class="btn primary" id="btnMovEditSalvar">‚úÖ Salvar</button>
</div>
</div>
</div>
<!-- MODAL: RELAT√ìRIOS -->
<div aria-hidden="true" class="modal" id="modalRel">
<div class="sheet">
<div class="mhead">
<div>üìä Relat√≥rios</div>
<button class="x" data-close="modalRel">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div aria-label="Tipos de relat√≥rio" class="rt-switch" role="tablist"><button class="rt-tab active" data-rt="movgeral">üîÅ Mov. Geral</button><button class="rt-tab" data-rt="movsetor">üè¢ Mov. por setor</button></div>
<!-- Mantido para compatibilidade do JS -->
<select id="rTipo" style="display:none">
  <option value="movgeral" selected>Movimenta√ß√µes (Geral)</option>
  <option value="movsetor">Movimenta√ß√µes por setor</option>
  <option value="invgeral">Invent√°rio Geral</option>
  <option value="critico">Estoque Cr√≠tico</option>
  <option value="porclass">Produtos por Classifica√ß√£o</option>
  <option value="entradas">Entradas (NF-e)</option>
  <option value="abc">Curva ABC</option>
</select>
<div class="group" id="rFiltros" style="margin-top:12px"></div>
<div class="twocol" style="margin-top:10px">
<button class="btn primary" id="btnGerarRel">‚úÖ Gerar</button>
<button class="btn secondary" id="btnPDFRel">üìÑ Salvar em PDF</button>
</div>
<div id="rOut" style="margin-top:12px"></div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalRel">Fechar</button>
<button class="btn secondary" id="btnLimparRel">üßπ Limpar</button>
</div>
</div>
</div>
<!-- MODAL: GEST√ÉO DE SETORES -->
<div aria-hidden="true" class="modal" id="modalSet">
<div class="sheet">
<div class="mhead">
<div>üèõÔ∏è Gest√£o de Setores</div>
<button class="x" data-close="modalSet">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<label>Buscar setor</label>
<input id="sBusca" placeholder="Digite: admin, sa√∫de...">
</input></div>
<div class="grid2" id="setGrid" style="margin-top:10px"></div>
<div class="muted" style="margin-top:10px;font-weight:800">
        Toque em um setor para ver as movimenta√ß√µes e gerar PDF.
      </div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalSet">Fechar</button>
</div>
</div>
</div>
<!-- MODAL: DETALHE DO SETOR -->
<div aria-hidden="true" class="modal" id="modalSetDet">
<div class="sheet">
<div class="mhead">
<div id="sdTitle">üèõÔ∏è Setor</div>
<button class="x" data-close="modalSetDet">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="twocol">
<div class="group" style="margin:0">
<label>De</label>
<input id="sdDe" type="date">
</input></div>
<div class="group" style="margin:0">
<label>At√©</label>
<input id="sdAte" type="date">
</input></div>
</div>
<div class="group">
<label>Dire√ß√£o</label>
<select id="sdDir">
<option value="ambos">Entradas + Sa√≠das</option>
<option value="entradas">Somente Entradas</option>
<option value="saidas">Somente Sa√≠das</option>
</select>
</div>
<div class="twocol">
<button class="btn primary" id="btnGerarSet">‚úÖ Gerar</button>
<button class="btn secondary" id="btnPDFSet">üìÑ Salvar em PDF</button>
</div>
<div class="rt-card" id="sdResumo" style="margin-top:12px"></div>
<div id="sdOut" style="margin-top:12px"></div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalSetDet">Fechar</button>
<button class="btn secondary" id="btnVoltarSet">‚Ü©Ô∏è Setores</button>
</div>
</div>
</div>
<div class="toast" id="toast"></div>

<!-- MODAL: ENTRADA DE NOTAS (XML NF-e) -->
<div aria-hidden="true" class="modal" id="modalNotas">
  <div class="sheet">
    <div class="mhead">
      <div>üßæ Entrada de Nota (XML)</div>
      <button class="x" data-close="modalNotas">√ó</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group">
        <button class="btn primary" id="btnImportXML">üìÑ Importar XML (NF-e)</button>
        <input accept=".xml" id="xmlInput" style="display:none" type="file"/>
      </div>

      <div class="card" id="nfResumo" style="display:none; margin-top:10px;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <span class="pill">N¬∫ <b id="nfNum">‚Äî</b> S√©rie <b id="nfSerie">‚Äî</b></span>
            <span class="pill">Emiss√£o <b id="nfEmi">‚Äî</b></span>
            <span class="pill">Fornecedor <b id="nfForn">‚Äî</b></span>
          </div>
          <div class="pill">Itens <b id="nfItens">0</b></div>
        </div>
        <div class="muteline"></div>
        <div style="font-size:12px;color:var(--muted)">
          Voc√™ pode <b>editar</b> qualquer campo abaixo. Itens n√£o cadastrados podem ser <b>cadastrados automaticamente</b>.
          Ao confirmar, o sistema cria movimenta√ß√µes de <b>ENTRADA NOTA</b> e <b>aumenta o estoque</b>.
        </div>
      </div>

      <div class="card" id="nfTabelaBox" style="display:none; margin-top:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="font-weight:900">Produtos da Nota</div>
          <div class="pill">Dica: use o campo ‚ÄúVincular‚Äù para apontar para um item j√° existente</div>
        </div>

        <div style="overflow:auto; margin-top:8px;">
          <table class="nftable" id="nfTable">
            <thead>
              <tr>
                <th style="min-width:120px">C√≥digo (NF)</th>
                <th style="min-width:220px">Descri√ß√£o</th>
                <th style="min-width:120px">NCM</th>
                <th style="min-width:90px">Un</th>
                <th style="min-width:110px">Qtd</th>
                <th style="min-width:120px">Vlr Unit</th>
                <th style="min-width:120px">Total</th>
                <th style="min-width:260px">Vincular / Status</th>
                <th style="min-width:130px"></th>
              </tr>
            </thead>
            <tbody id="nfTbody"></tbody>
          </table>
        </div>

        <div class="nfactions" style="margin-top:10px;">
          <button class="btn" id="btnNFRecarregar">‚Üª Recarregar XML</button>
          <button class="btn" id="btnNFCadastrarTodos">‚ûï Cadastrar n√£o cadastrados</button>
          <button class="btn primary" id="btnNFAplicar">‚úÖ Confirmar Entrada e Atualizar Estoque</button>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- MODAL: HIST√ìRICO DE NOTAS -->
<div aria-hidden="true" class="modal" id="modalHistNotas">
  <div class="sheet" style="max-width:1100px">
    <div class="mhead">
      <div>üìö Hist√≥rico de Notas</div>
      <button class="x" data-close="modalHistNotas">√ó</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group filters">
        <div>
          <div class="sub">Data inicial</div>
          <input class="in" id="hnIni" type="date"/>
        </div>
        <div>
          <div class="sub">Data final</div>
          <input class="in" id="hnFim" type="date"/>
        </div>
        <div>
          <div class="sub">Empresa / Fornecedor</div>
          <input class="in" id="hnEmp" placeholder="Digite para filtrar"/>
        </div>
        <div>
          <div class="sub">Produto</div>
          <input class="in" id="hnProd" placeholder="Nome, c√≥digo NF, NCM..."/>
        </div>
        <div style="display:flex;align-items:flex-end;gap:10px">
          <button class="btn primary" id="btnHistFiltrar">Filtrar</button>
          <button class="btn secondary" id="btnHistLimpar">Limpar</button>
        </div>
      </div>

      <div class="kpis" id="hnKpis" style="display:none"></div>

      <div class="card" style="margin-top:10px">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div class="muted" id="hnInfo">Importe XMLs para visualizar o hist√≥rico.</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="btnHistPDF">üñ®Ô∏è Gerar relat√≥rio / PDF</button>
            <button class="btn" id="btnHistExport">‚¨áÔ∏è Exportar Notas (JSON)</button>
            <label class="btn" style="cursor:pointer">
              ‚¨ÜÔ∏è Importar Notas (JSON)
              <input accept=".json" id="hnImport" style="display:none" type="file"/>
            </label>
          </div>
        </div>
      </div>

      <div class="tableWrap" style="margin-top:10px">
        <table class="tbl">
          <thead>
            <tr>
              <th>Data</th>
              <th>Empresa</th>
              <th>NF</th>
              <th>Produto</th>
              <th>NCM</th>
              <th>Qtd</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody id="hnTb"></tbody>
        </table>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn secondary" data-close="modalHistNotas">Fechar</button>
    </div>
  </div>
</div>


<!-- Editor de Item da Nota (sobreposto) -->
<div aria-hidden="true" class="modal" id="modalNFItem">
  <div class="sheet">
    <div class="mhead">
      <div>‚úèÔ∏è Editar Item da Nota</div>
      <button class="x" data-close="modalNFItem">√ó</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="grid2">
        <div>
          <div class="sub">C√≥digo (NF)</div>
          <input class="in" id="nfEditCodigo" placeholder="cProd"/>
        </div>
        <div>
          <div class="sub">Unidade</div>
          <input class="in" id="nfEditUn" placeholder="UN"/>
        </div>
        <div style="grid-column:1/-1">
          <div class="sub">Descri√ß√£o</div>
          <input class="in" id="nfEditNome" placeholder="Descri√ß√£o do produto"/>
        </div>
        <div>
          <div class="sub">NCM</div>
          <input class="in" id="nfEditNCM" placeholder="00000000"/>
        </div>
        <div>
          <div class="sub">Quantidade</div>
          <input class="in" id="nfEditQtd" inputmode="decimal" placeholder="0"/>
        </div>
        <div>
          <div class="sub">Valor unit√°rio</div>
          <input class="in" id="nfEditVUn" inputmode="decimal" placeholder="0,00"/>
        </div>
        <div>
          <div class="sub">Total</div>
          <input class="in" id="nfEditVTot" inputmode="decimal" placeholder="0,00"/>
        </div>
        <div style="grid-column:1/-1">
          <div class="sub">Vincular ao produto cadastrado</div>
          <select class="in" id="nfEditVinc"></select>
          <div class="muted" id="nfEditStatus" style="margin-top:6px;font-size:12px"></div>
        </div>
      </div>
      <div class="muteline"></div>
      <div class="muted" style="font-size:12px">
        Dica: use ‚ÄúVincular‚Äù para apontar para um produto existente. Se n√£o existir, use ‚ÄúCadastrar‚Äù no item na tabela.
      </div>
      <input id="nfEditIndex" type="hidden" value="-1"/>
    </div>
    <div class="mfoot">
      <button class="btn secondary" data-close="modalNFItem">Cancelar</button>
      <button class="btn primary" id="btnNFItemSalvar">Salvar</button>
    </div>
  </div>
</div>

<script>


/* ========= ALMOX2026 ‚Ä¢ BASE OFFLINE (Fase 1) =========
   Objetivo: modais SEMPRE abrem + importar JSON + listar + editar + salvar.
*/
"use strict";

const KEY_PROD = "ALMOX2026_PROD_BASE_V1";
const KEY_MOV  = "ALMOX2026_MOV_BASE_V1";


const KEY_NOTAS = "ALMOX2026_NOTAS_V1";
const SETORES = [
  "ALMOXARIFADO",
  "ADMINISTRA√á√ÉO","AGRICULTURA","DESENV SOCIAL","BOMBEIROS","COMPRAS","CONSELHO TUTELAR","CRAS","CREAS","CRIAN√áA FELIZ",
  "CULTURA","DESENV REGIONAL","EDUCA√á√ÉO","ESPA√áO AMIGO","ESPORTE","FINAN√áAS","GABINETE","GEST√ÉO PESSOAL","LAR DO ANCI√ÉO",
  "LICITA√á√ÉO","LIMPEZA P√öBLICA","MEIO AMBIENTE","MERENDAS","OBRAS E INFRA","POUPATEMPO","PROCURADORIA","RH","SA√öDE",
  "TERCEIRO SETOR","TR√ÇNSITO","TRANSPORTE","TRIBUTA√á√ÉO","TURISMO","VIGIL√ÇNCIA SANIT√ÅRIA"
];

let movs = [];
let movProdutoIndex = -1; // √≠ndice do produto selecionado para movimenta√ß√£o


let produtos = [];
let notas = [];
let editIndex = -1;

const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}

/* ---- Modais (100% independentes) ---- */
function abrirModal(id){
  const m=$(id); if(!m) return;
  m.classList.add("active");
  m.setAttribute("aria-hidden","false");
}
function fecharModal(id){
  const m=$(id); if(!m) return;
  m.classList.remove("active");
  m.setAttribute("aria-hidden","true");
}

// Fecha por bot√£o, ou clicando fora do sheet
document.addEventListener("click",(e)=>{
  const close = e.target.closest?.("[data-close]");
  if(close){ fecharModal(close.getAttribute("data-close")); }
  if(e.target.classList?.contains("modal")){ e.target.classList.remove("active"); }
});

/* ---- Nav ---- */
$("btnDados").addEventListener("click",()=>abrirModal("modalDados"));

$("btnNotas").addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  abrirModal("modalNotas");
});


/* ---- Hist√≥rico de Notas ---- */
$("btnHistNotas").addEventListener("click",()=>{
  abrirModal("modalHistNotas");
  renderHistNotas();
});

$("btnHistFiltrar").addEventListener("click", renderHistNotas);
$("btnHistLimpar").addEventListener("click", ()=>{
  $("hnIni").value = "";
  $("hnFim").value = "";
  $("hnEmp").value = "";
  $("hnProd").value = "";
  renderHistNotas();
});

$("btnHistPDF").addEventListener("click", ()=>{
  const rep = buildNotasReport();
  openPrintWindow(rep, "Relatorio_Notas");
});

$("btnHistExport").addEventListener("click", ()=>{
  const notas = loadNotas();
  const blob = new Blob([JSON.stringify({ notas, exportado_em: new Date().toISOString() }, null, 2)], {type:"application/json"});
  downloadBlob(blob, `ALMOX2026_NOTAS_BACKUP_${new Date().toISOString().slice(0,10)}.json`);
});

$("hnImport").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    const incoming = Array.isArray(obj) ? obj : (obj.notas || obj.data || []);
    if(!Array.isArray(incoming)) throw new Error("Formato inv√°lido");
    const merged = mergeNotas(loadNotas(), incoming);
    saveNotas(merged);
    toast(`‚úÖ Notas importadas: ${incoming.length} (total: ${merged.length})`);
    renderHistNotas();
  }catch(err){
    console.error(err);
    toast("‚ö†Ô∏è Falha ao importar notas");
  }finally{
    e.target.value = "";
  }
});

function fmtNum(n){
  const v = Number(n||0);
  return (isFinite(v)? v:0).toLocaleString("pt-BR");
}
function fmtMoney(n){
  const v = Number(n||0);
  return (isFinite(v)? v:0).toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
}

function loadNotas(){
  try{ return JSON.parse(localStorage.getItem(KEY_NOTAS)||"[]"); }catch{ return []; }
}
function saveNotas(arr){
  localStorage.setItem(KEY_NOTAS, JSON.stringify(arr||[]));
}
function notaKey(n){
  const c = String(n.cnpj||"").replace(/\D/g,"");
  const nnf = String(n.nNF||n.numero||"");
  const ser = String(n.serie||"");
  const dt = String(n.dhEmiISO||n.dhEmi||n.data||"");
  if(c||nnf||ser||dt) return `${c}|${nnf}|${ser}|${dt}`;
  return String(n.id||"");
}
function mergeNotas(base, incoming){
  const map = new Map();
  [...(base||[]), ...(incoming||[])].forEach(n=>{
    const k = notaKey(n);
    if(!k) return;
    // se j√° existe, preserva a que tiver mais itens/detalhes
    if(!map.has(k)) map.set(k, n);
    else{
      const a = map.get(k);
      const aItens = (a.itens||[]).length;
      const bItens = (n.itens||[]).length;
      if(bItens > aItens) map.set(k, n);
    }
  });
  return Array.from(map.values()).sort((a,b)=> String(b.dhEmiISO||b.dhEmi||"").localeCompare(String(a.dhEmiISO||a.dhEmi||"")));
}

function renderHistNotas(){
  const notas = loadNotas();
  const tb = $("hnTb");
  const info = $("hnInfo");
  const kpis = $("hnKpis");
  tb.innerHTML = "";

  if(notas.length===0){
    info.textContent = "Nenhuma nota registrada ainda. Importe um XML e confirme a entrada para gravar.";
    kpis.style.display="none";
    return;
  }

  const ini = $("hnIni").value ? new Date($("hnIni").value + "T00:00:00") : null;
  const fim = $("hnFim").value ? new Date($("hnFim").value + "T23:59:59") : null;
  const emp = $("hnEmp").value.trim().toLowerCase();
  const prod = $("hnProd").value.trim().toLowerCase();

  let rows = [];
  notas.forEach(n=>{
    const fornecedor = String(n.fornecedor||"");
    const nf = String(n.nNF||"");
    const serie = String(n.serie||"");
    const iso = n.dhEmiISO || normalizeDateISO(n.dhEmi||n.data||"");
    const dt = iso ? new Date(iso) : null;

    if(ini && dt && dt < ini) return;
    if(fim && dt && dt > fim) return;
    if(emp && !fornecedor.toLowerCase().includes(emp)) return;

    const itens = Array.isArray(n.itens) ? n.itens : [];
    itens.forEach(it=>{
      const hay = `${it.nome||""} ${(it.codigoNF||"")} ${(it.ncm||"")} ${(it.codigo1||"")} ${(it.codigo2||"")}`.toLowerCase();
      if(prod && !hay.includes(prod)) return;
      rows.push({
        data: iso ? iso.slice(0,10) : (n.dhEmi||n.data||""),
        fornecedor,
        nf: nf ? `${nf}${serie?(" / "+serie):""}` : (serie?("S√©rie "+serie):""),
        produto: it.nome||"",
        ncm: it.ncm||"",
        qtd: Number(String(it.qtd||it.quantidade||"0").replace(",","."))||0,
        valor: Number(String(it.vTot||it.valor||"0").replace(",","."))||0,
      });
    });
  });

  // KPIs
  const totalNotas = new Set(rows.map(r=> `${r.data}|${r.fornecedor}|${r.nf}`)).size;
  const totalItens = rows.length;
  const qtdTotal = rows.reduce((s,r)=>s+r.qtd,0);
  const valorTotal = rows.reduce((s,r)=>s+r.valor,0);

  kpis.innerHTML = `
    <div class="kpi"><div class="lbl">Notas</div><div class="val">${totalNotas}</div></div>
    <div class="kpi"><div class="lbl">Itens lan√ßados</div><div class="val">${totalItens}</div></div>
    <div class="kpi"><div class="lbl">Quantidade total</div><div class="val">${fmtNum(qtdTotal)}</div></div>
    <div class="kpi"><div class="lbl">Valor total (itens)</div><div class="val">${fmtMoney(valorTotal)}</div></div>
  `;
  kpis.style.display = "grid";

  info.textContent = `Linhas: ${rows.length} ‚Ä¢ √öltima atualiza√ß√£o: ${new Date().toLocaleString("pt-BR")}`;

  if(rows.length===0){
    tb.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px">Nenhum resultado para os filtros.</td></tr>`;
    return;
  }

  // Ordena
  rows.sort((a,b)=> String(b.data).localeCompare(String(a.data)) || a.fornecedor.localeCompare(b.fornecedor) || a.produto.localeCompare(b.produto));

  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(r.data||"‚Äî")}</b><div class="subtxt">${escapeHtml(r.nf||"")}</div></td>
      <td>${escapeHtml(r.fornecedor||"‚Äî")}</td>
      <td>${escapeHtml(r.nf||"‚Äî")}</td>
      <td>${escapeHtml(r.produto||"‚Äî")}</td>
      <td>${escapeHtml(r.ncm||"")}</td>
      <td>${fmtNum(r.qtd)}</td>
      <td>${fmtMoney(r.valor)}</td>
    `;
    frag.appendChild(tr);
  });
  tb.appendChild(frag);
}

function buildNotasReport(){
  // reaproveita a mesma l√≥gica de filtro do render
  const notas = loadNotas();
  const iniV = $("hnIni").value;
  const fimV = $("hnFim").value;
  const empV = $("hnEmp").value.trim();
  const prodV = $("hnProd").value.trim();

  const ini = iniV ? new Date(iniV + "T00:00:00") : null;
  const fim = fimV ? new Date(fimV + "T23:59:59") : null;
  const emp = empV.toLowerCase();
  const prod = prodV.toLowerCase();

  let rows = [];
  notas.forEach(n=>{
    const fornecedor = String(n.fornecedor||"");
    const nf = String(n.nNF||"");
    const serie = String(n.serie||"");
    const iso = n.dhEmiISO || normalizeDateISO(n.dhEmi||n.data||"");
    const dt = iso ? new Date(iso) : null;

    if(ini && dt && dt < ini) return;
    if(fim && dt && dt > fim) return;
    if(emp && !fornecedor.toLowerCase().includes(emp)) return;

    const itens = Array.isArray(n.itens) ? n.itens : [];
    itens.forEach(it=>{
      const hay = `${it.nome||""} ${(it.codigoNF||"")} ${(it.ncm||"")} ${(it.codigo1||"")} ${(it.codigo2||"")}`.toLowerCase();
      if(prod && !hay.includes(prod)) return;
      rows.push({
        data: iso ? iso.slice(0,10) : (n.dhEmi||n.data||""),
        fornecedor,
        nf: nf ? `${nf}${serie?(" / "+serie):""}` : (serie?("S√©rie "+serie):""),
        produto: it.nome||"",
        ncm: it.ncm||"",
        qtd: Number(String(it.qtd||it.quantidade||"0").replace(",","."))||0,
        valor: Number(String(it.vTot||it.valor||"0").replace(",","."))||0,
      });
    });
  });

  rows.sort((a,b)=> String(a.data).localeCompare(String(b.data)) || a.fornecedor.localeCompare(b.fornecedor));

  const qtdTotal = rows.reduce((s,r)=>s+r.qtd,0);
  const valorTotal = rows.reduce((s,r)=>s+r.valor,0);

  const filtrosTxt = [
    iniV ? `De: <b>${escapeHtml(iniV)}</b>` : null,
    fimV ? `At√©: <b>${escapeHtml(fimV)}</b>` : null,
    empV ? `Empresa: <b>${escapeHtml(empV)}</b>` : null,
    prodV ? `Produto: <b>${escapeHtml(prodV)}</b>` : null
  ].filter(Boolean).join(" ‚Ä¢ ") || "Sem filtros";

  const body = `
    <div class="kpiRow">
      <div class="kpi"><div class="k">Linhas</div><div class="v">${rows.length}</div></div>
      <div class="kpi"><div class="k">Qtd total</div><div class="v">${fmtNum(qtdTotal)}</div></div>
      <div class="kpi"><div class="k">Valor total</div><div class="v">${fmtMoney(valorTotal)}</div></div>
    </div>

    <div style="margin:10px 0;color:#5b607a;font-size:12px">${filtrosTxt}</div>

    <table class="t">
      <thead><tr>
        <th>Data</th><th>Empresa</th><th>NF</th><th>Produto</th><th>NCM</th><th>Qtd</th><th>Valor</th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${escapeHtml(r.data||"")}</td>
            <td>${escapeHtml(r.fornecedor||"")}</td>
            <td>${escapeHtml(r.nf||"")}</td>
            <td>${escapeHtml(r.produto||"")}</td>
            <td>${escapeHtml(r.ncm||"")}</td>
            <td style="text-align:right">${fmtNum(r.qtd)}</td>
            <td style="text-align:right">${fmtMoney(r.valor)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  return buildPrintableDoc({
    title: "Hist√≥rico de Notas (NF-e)",
    subtitle: "Entrada de notas ‚Ä¢ filtros por data/empresa/produto",
    bodyHTML: `
      <style>
        .kpiRow{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:10px 0}
        .kpi{border:1px solid #e7e9f4;border-radius:14px;padding:10px;background:#fff}
        .k{color:#5b607a;font-size:12px}
        .v{font-weight:800;font-size:16px;margin-top:4px}
        table.t{width:100%;border-collapse:collapse;margin-top:10px}
        .t th,.t td{padding:8px 10px;border-bottom:1px solid #eef0f7;text-align:left;vertical-align:top;font-size:12px}
        .t th{background:#f6f7fb}
      </style>
      ${body}
    `
  });
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename || "download";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}
$("btnMov").addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  prepararMovimentacao();
  renderMovList();
  abrirModal("modalMov");
});


/* =========================
   ENTRADA DE NOTAS (XML NF-e)
   ========================= */
let nfAtual = null;       // metadados da nota
let nfItens = [];         // itens extra√≠dos do XML (edit√°veis)
let nfMapIdx = [];        // √≠ndice do produto vinculado em "produtos" (ou -1)

$("btnImportXML").addEventListener("click", ()=> $("xmlInput").click());
$("xmlInput").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    // valida√ß√µes r√°pidas: muita gente tenta importar o DANFE (PDF) em vez do XML
    const name = String(file.name||"").toLowerCase();
    if(name && !name.endsWith(".xml")){
      // checa assinatura PDF sem ler tudo como texto
      const head = await file.slice(0, 5).text().catch(()=> "");
      if(head.startsWith("%PDF")){
        throw new Error("Arquivo selecionado parece ser PDF (DANFE). Para importar, selecione o XML da NF-e (.xml).");
      }
      // n√£o √© pdf, mas tamb√©m n√£o √© xml
      throw new Error("Arquivo n√£o √© .xml. Selecione o XML da NF-e.");
    }

    const txt = await file.text();
    const t = String(txt||"").trim();

    if(!t.startsWith("<")){
      const head = await file.slice(0, 5).text().catch(()=> "");
      if(head.startsWith("%PDF")) throw new Error("Arquivo selecionado parece ser PDF (DANFE). Selecione o XML da NF-e (.xml).");
      throw new Error("Conte√∫do inv√°lido. Selecione o XML da NF-e.");
    }
    // heur√≠sticas do XML NF-e
    const low = t.slice(0, 4000).toLowerCase();
    const ok = (low.includes("<nfe") || low.includes("<nfeproc") || low.includes("<nfeproc") || low.includes("portalfiscal.inf.br/nfe"));
    if(!ok){
      throw new Error("Este XML n√£o parece ser de NF-e (modelo 55). Verifique se voc√™ selecionou o XML correto.");
    }

    carregarXMLNota(txt);
  }catch(err){
    console.error(err);
    toast(`‚ùå ${err?.message || "Falha ao importar XML"}`);
    const dbg = document.getElementById("nfDebug");
    if(dbg){ dbg.style.display="block"; dbg.textContent = String(err?.stack || err); }
  }finally{
    // permite reimportar o mesmo arquivo
    e.target.value = "";
  }
});

$("btnNFRecarregar").addEventListener("click", ()=> $("xmlInput").click());

$("btnNFCadastrarTodos").addEventListener("click", ()=>{
  if(!nfItens.length){ toast("‚ö†Ô∏è Importe um XML primeiro"); return; }
  let count=0;
  nfItens.forEach((it,i)=>{
    if(nfMapIdx[i]===-1){
      nfMapIdx[i]=cadastrarProdutoDeXML(it);
      count++;
    }
  });
  if(count>0){ save(); render(); toast(`‚úÖ ${count} produto(s) cadastrado(s)`); }
  renderNFTable();
});

$("btnNFAplicar").addEventListener("click", ()=>{
  if(!nfItens.length){ toast("‚ö†Ô∏è Importe um XML primeiro"); return; }

  // valida: todos precisam estar vinculados
  const faltando = nfMapIdx.findIndex(v=>v===-1);
  if(faltando!==-1){
    toast("‚ö†Ô∏è Existem itens n√£o vinculados. Use Vincular ou 'Cadastrar n√£o cadastrados'.");
    return;
  }

  // aplica no estoque + gera movimenta√ß√µes
  const agora = new Date().toISOString();
  const dataMov = nfAtual?.dhEmiISO || agora;
  const fornecedor = nfAtual?.fornecedor || "FORNECEDOR";
  const numeroNota = nfAtual?.nNF || "";

  nfItens.forEach((it,i)=>{
    const idx = nfMapIdx[i];
    const p = produtos[idx];
    const qtd = num(it.qtd);
    if(!Number.isFinite(qtd) || qtd<=0) return;

    // atualiza cadastro com eventuais edi√ß√µes
    p.nome = String(it.nome||p.nome||"").trim();
    p.ncm  = String(it.ncm||p.ncm||"").trim();
    if(Number.isFinite(num(it.vUn))) p.preco = num(it.vUn);

    // entrada aumenta estoque do almox
    p.estoqueAtual = num(p.estoqueAtual) + qtd;

    // movimenta√ß√£o de entrada
    movs.push({
      id: cryptoId(),
      data: dataMov,
      tipo: "ENTRADA NOTA",
      origem: fornecedor,
      destino: "ALMOXARIFADO",
      produtoCodigo: p.codigo1 || p.codigo2 || "",
      produtoNome: p.nome,
      quantidade: qtd,
      observacao: numeroNota ? `NF ${numeroNota}` : "NF (XML)"
    });
  });

  // registra a nota (log)
  notas.push({
    id: cryptoId(),
    nNF: nfAtual?.nNF || "",
    serie: nfAtual?.serie || "",
    dhEmi: nfAtual?.dhEmi || "",
    dhEmiISO: nfAtual?.dhEmiISO || "",
    fornecedor: nfAtual?.fornecedor || "",
    cnpj: nfAtual?.cnpj || "",
    totalItens: nfItens.length,
    totalValorItens: nfItens.reduce((s,it)=> s + (Number(String(it.vTot||"0").replace(",","."))||0), 0),
    itens: nfItens.map(it=>({
      codigoNF: it.codigoNF || "",
      nome: it.nome || "",
      ncm: it.ncm || "",
      un: it.un || "",
      qtd: it.qtd || "",
      vUn: it.vUn || "",
      vTot: it.vTot || ""
    })),
    criado_em: agora
  });

save();
  render();
  renderMovList?.();
  toast("‚úÖ Entrada aplicada no estoque");
  fecharModal("modalNotas");
});

function carregarXMLNota(xmlText){
  try{
    const parsed = parseNFeXML(xmlText);
    nfAtual = parsed.meta;
    nfItens = parsed.itens;
    nfMapIdx = nfItens.map(it=>matchProdutoIndex(it));

    // UI resumo
    $("nfResumo").style.display = "block";
    $("nfTabelaBox").style.display = "block";
    $("nfNum").textContent = nfAtual.nNF || "‚Äî";
    $("nfSerie").textContent = nfAtual.serie || "‚Äî";
    $("nfEmi").textContent = nfAtual.dhEmi || "‚Äî";
    $("nfForn").textContent = nfAtual.fornecedor || "‚Äî";
    $("nfItens").textContent = String(nfItens.length);

    renderNFTable();
    toast("‚úÖ XML carregado");
  }catch(err){
    console.error(err);
    toast(`‚ùå Erro ao ler XML: ${err?.message||err}. Abra o console (F12) para detalhes.`);
    // exibe no modal tamb√©m
    const dbg = document.getElementById("nfDebug");
    if(dbg){ dbg.style.display="block"; dbg.textContent = String(err?.stack || err); }
  }
}

function parseNFeXML(xmlText){
  const dom = new DOMParser().parseFromString(xmlText, "text/xml");
  const parserErr = dom.getElementsByTagName("parsererror")?.[0];
  if(parserErr) throw new Error("XML inv√°lido");

  // helpers por localName (ignora namespace) + case-insensitive
  const all = Array.from(dom.getElementsByTagName("*"));
  const eqName = (node, name) => String(node?.localName||"").toLowerCase() === String(name||"").toLowerCase();
  const first = (name, root=dom) => {
    const nodes = (root===dom ? all : Array.from(root.getElementsByTagName("*")));
    return nodes.find(n=>eqName(n,name)) || null;
  };
  const childrenBy = (root, name) => Array.from(root.getElementsByTagName("*")).filter(n=>eqName(n,name));
  const textOf = (root, name) => {
    const n = first(name, root);
    return n ? (n.textContent||"").trim() : "";
  };

  // encontra infNFe
  const infNFe = all.find(n=>String(n.localName||"").toLowerCase()==="infnfe") || dom.documentElement;
  const ide = all.find(n=>String(n.localName||"").toLowerCase()==="ide");
  const emit = all.find(n=>String(n.localName||"").toLowerCase()==="emit");

  const nNF = ide ? textOf(ide,"nNF") : "";
  const serie = ide ? textOf(ide,"serie") : "";
  const dhEmi = ide ? (textOf(ide,"dhEmi") || textOf(ide,"dEmi")) : "";

  // fornecedor
  const fornecedor = emit ? (textOf(emit,"xNome") || textOf(emit,"xFant")) : "";
  const cnpj = emit ? (textOf(emit,"CNPJ") || textOf(emit,"CPF")) : "";

  // data ISO para movimenta√ß√£o
  const dhEmiISO = normalizeDateISO(dhEmi);

  // itens: det/prod
  const dets = all.filter(n=>String(n.localName||"").toLowerCase()==="det");
  const itens = dets.map(det=>{
    const prod = Array.from(det.getElementsByTagName("*")).find(n=>String(n.localName||"").toLowerCase()==="prod") || det;
    const cProd = textOf(prod,"cProd");
    const xProd = textOf(prod,"xProd");
    const ncm = textOf(prod,"NCM");
    const uCom = textOf(prod,"uCom");
    const qCom = textOf(prod,"qCom");
    const vUnCom = textOf(prod,"vUnCom");
    const vProd = textOf(prod,"vProd");
    return {
      codigoNF: cProd,
      nome: xProd,
      ncm,
      un: uCom,
      qtd: qCom,
      vUn: vUnCom,
      vTot: vProd
    };
  }).filter(it=>it.nome || it.codigoNF);

  return { 
    meta:{ nNF, serie, dhEmi, dhEmiISO, fornecedor, cnpj },
    itens
  };
}

function normalizeDateISO(dh){
  const s = String(dh||"").trim();
  if(!s) return "";
  // NF-e costuma vir como 2024-01-31T10:11:12-03:00
  const d = new Date(s);
  if(!isNaN(d.getTime())) return d.toISOString();
  // ou dd/mm/aaaa
  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
  if(m){
    const d2 = new Date(`${m[3]}-${m[2]}-${m[1]}T00:00:00`);
    if(!isNaN(d2.getTime())) return d2.toISOString();
  }
  return "";
}

function matchProdutoIndex(it){
  const cod = String(it.codigoNF||"").trim();
  const nome = normText(it.nome||"");
  const ncm = String(it.ncm||"").trim();

  // 1) por c√≥digo1/c√≥digo2
  if(cod){
    let idx = produtos.findIndex(p=>String(p.codigo1||"").trim()===cod || String(p.codigo2||"").trim()===cod);
    if(idx!==-1) return idx;
  }
  // 2) por nome parecido + ncm (quando existir)
  if(nome){
    let idx = produtos.findIndex(p=>{
      const pn = normText(p.nome||"");
      if(!pn) return false;
      const okNome = pn.includes(nome) || nome.includes(pn);
      if(!okNome) return false;
      if(ncm) return String(p.ncm||"").trim()===ncm;
      return true;
    });
    if(idx!==-1) return idx;
  }
  return -1;
}

function cadastrarProdutoDeXML(it){
  const cod = String(it.codigoNF||"").trim();
  const novo = normalizeProduto({
    codigo1: cod || "",
    codigo2: "",
    nome: String(it.nome||"").trim(),
    descricao: "",
    categoria: "ENTRADA XML",
    ncm: String(it.ncm||"").trim(),
    preco: num(it.vUn),
    estoqueAtual: 0,
    estoqueMin: 0,
    setor: "",
    ativo: true
  });
  produtos.push(novo);
  return produtos.length-1;
}

function renderNFTable(){
  const tb = $("nfTbody");
  if(!tb) throw new Error("Tela de itens da nota n√£o encontrada (nfTbody).");
  tb.innerHTML = "";

  nfItens.forEach((it,i)=>{
    const idx = nfMapIdx[i];
    const status = idx===-1 ? `<span class="tagWarn">NOVO</span>` : `<span class="tagOk">CADASTRADO</span>`;
    const linked = idx===-1 ? "" : ` ‚Üí ${escapeHtml(produtos[idx]?.nome||"")}`;

    const row = document.createElement("tr");
    row.className = "row";
    row.innerHTML = `
      <td><input data-i="${i}" data-f="codigoNF" value="${escapeAttr(it.codigoNF||"")}"></td>
      <td><input data-i="${i}" data-f="nome" value="${escapeAttr(it.nome||"")}"></td>
      <td><input data-i="${i}" data-f="ncm" value="${escapeAttr(it.ncm||"")}"></td>
      <td><input data-i="${i}" data-f="un" value="${escapeAttr(it.un||"")}"></td>
      <td><input data-i="${i}" data-f="qtd" value="${escapeAttr(String(it.qtd??""))}"></td>
      <td><input data-i="${i}" data-f="vUn" value="${escapeAttr(String(it.vUn??""))}"></td>
      <td><input data-i="${i}" data-f="vTot" value="${escapeAttr(String(it.vTot??""))}"></td>
      <td>
        <select data-i="${i}" data-f="vinc">
          ${renderVincOptions(idx)}
        </select>
        <div style="margin-top:6px;font-size:12px;color:var(--muted)">${status}${linked ? " " + linked : ""}</div>
      </td>
      <td>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" data-nf-edit="${i}">Editar</button>
          ${idx===-1 ? `<button class="btn" data-nf-cad="${i}">Cadastrar</button>` : `<button class="btn" data-nf-ver="${i}">Ver</button>`}
        </div>
      </td>
    `;
    tb.appendChild(row);
  });

  // inputs edit√°veis
  tb.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", (e)=>{
      const i = +e.target.getAttribute("data-i");
      const f = e.target.getAttribute("data-f");
      nfItens[i][f] = e.target.value;
      if(f==="codigoNF" || f==="nome" || f==="ncm"){
        // refaz match autom√°tico se ainda n√£o vinculado
        if(nfMapIdx[i]===-1){
          nfMapIdx[i] = matchProdutoIndex(nfItens[i]);
          renderNFTable();
        }
      }
    });
  });

  // vincular manualmente
  tb.querySelectorAll('select[data-f="vinc"]').forEach(sel=>{
    sel.addEventListener("change",(e)=>{
      const i = +e.target.getAttribute("data-i");
      const v = e.target.value;
      nfMapIdx[i] = v==="-1" ? -1 : Number(v);
      renderNFTable();
    });
  });

  // cadastrar item
  tb.querySelectorAll("[data-nf-cad]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.getAttribute("data-nf-cad");
      nfMapIdx[i] = cadastrarProdutoDeXML(nfItens[i]);
      save(); render(); renderNFTable();
      toast("‚úÖ Produto cadastrado");
    });
  });

  // editar item (sobreposto)
  tb.querySelectorAll("[data-nf-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.getAttribute("data-nf-edit");
      abrirEditorItemNF(i);
    });
  });

  // ver item existente
  tb.querySelectorAll("[data-nf-ver]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = +btn.getAttribute("data-nf-ver");
      const idx = nfMapIdx[i];
      if(idx<0) return;
      editarProduto(idx);
      abrirModal("modalProduto");
    });
  });
}

/* ---- Editor sobreposto de item da nota (n√£o altera o fluxo existente) ---- */
function preencherSelectVinc(elSelect, selectedIdx){
  elSelect.innerHTML = renderVincOptions(selectedIdx);
}
function statusVinculoTexto(i){
  const idx = nfMapIdx[i];
  if(idx===-1) return '<span class="tagWarn">NOVO</span> N√£o vinculado';
  return '<span class="tagOk">CADASTRADO</span> ‚Üí ' + escapeHtml(produtos[idx]?.nome||'');
}
function abrirEditorItemNF(i){
  const it = nfItens[i];
  if(!it) return;
  $("nfEditIndex").value = String(i);
  $("nfEditCodigo").value = it.codigoNF || "";
  $("nfEditNome").value = it.nome || "";
  $("nfEditNCM").value = it.ncm || "";
  $("nfEditUn").value = it.un || "";
  $("nfEditQtd").value = String(it.qtd ?? "");
  $("nfEditVUn").value = String(it.vUn ?? "");
  $("nfEditVTot").value = String(it.vTot ?? "");

  preencherSelectVinc($("nfEditVinc"), nfMapIdx[i]);
  $("nfEditStatus").innerHTML = statusVinculoTexto(i);

  // mudan√ßa manual no v√≠nculo dentro do editor
  $("nfEditVinc").onchange = (e)=>{
    const v = e.target.value;
    nfMapIdx[i] = v==="-1" ? -1 : Number(v);
    $("nfEditStatus").innerHTML = statusVinculoTexto(i);
  };

  abrirModal("modalNFItem");
}

$("btnNFItemSalvar").addEventListener("click", ()=>{
  const i = Number($("nfEditIndex").value);
  if(!(i>=0)) return;

  // Atualiza o item (mant√©m compatibilidade com renderNFTable existente)
  nfItens[i].codigoNF = $("nfEditCodigo").value.trim();
  nfItens[i].nome     = $("nfEditNome").value.trim();
  nfItens[i].ncm      = $("nfEditNCM").value.trim();
  nfItens[i].un       = $("nfEditUn").value.trim();
  nfItens[i].qtd      = $("nfEditQtd").value.trim();
  nfItens[i].vUn      = $("nfEditVUn").value.trim();
  nfItens[i].vTot     = $("nfEditVTot").value.trim();

  // Se n√£o estiver vinculado, tenta match autom√°tico
  if(nfMapIdx[i]===-1){
    nfMapIdx[i] = matchProdutoIndex(nfItens[i]);
  }

  fecharModal("modalNFItem");
  renderNFTable();
  toast("‚úÖ Item atualizado");
});

function renderVincOptions(currentIdx){
  const opts = [`<option value="-1"${currentIdx===-1?" selected":""}>‚Äî n√£o vinculado ‚Äî</option>`];
  // lista top 200 para evitar modal pesado; ainda d√° para buscar pelo c√≥digo NF (match autom√°tico)
  const lim = Math.min(produtos.length, 200);
  for(let i=0;i<lim;i++){
    const p = produtos[i];
    const label = `${(p.codigo1||p.codigo2||"").toString().padEnd(8," ")} ‚Ä¢ ${p.nome||""}`.trim();
    opts.push(`<option value="${i}"${currentIdx===i?" selected":""}>${escapeHtml(label)}</option>`);
  }
  if(produtos.length>lim){
    opts.push(`<option value="-1" disabled>‚Ä¶ (mostrando ${lim} de ${produtos.length})</option>`);
  }
  return opts.join("");
}

function normText(s){
  return String(s||"").toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ").trim();
}


/* ---- Relat√≥rios ---- */
$("btnRel").addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderFiltrosRel();
  $("rOut").innerHTML = "";
  abrirModal("modalRel");
});

// Tabs de relat√≥rios (mudan√ßa instant√¢nea)
document.addEventListener("click",(e)=>{
  const b = e.target && e.target.closest ? e.target.closest(".rt-tab") : null;
  if(!b) return;
  const t = b.getAttribute("data-rt");
  if(!t) return;
  document.querySelectorAll("#modalRel .rt-tab").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  $("rTipo").value = t;
  renderFiltrosRel();
  $("rOut").innerHTML = "";
  lastPDFHtml = "";
});



$("rTipo").addEventListener("change",renderFiltrosRel);


function renderFiltrosRel(){
  const tipo = $("rTipo").value;
  const box = $("rFiltros");
  const pad = (s)=>escapeHtml(s);

  const setoresOpts = SETORES.map(s=>`<option value="${pad(s)}">${pad(s)}</option>`).join("");

  // Classifica√ß√µes (derivadas dos produtos)
  const classes = Array.from(new Set(produtos.map(p=>String(p.categoria||p.classificacao||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"pt-BR"));
  const classOpts = ['<option value="">(todas)</option>', ...classes.map(c=>`<option value="${pad(c)}">${pad(c)}</option>`)].join("");

  if(tipo==="movsetor"){
    box.innerHTML = `
      <div class="twocol">
        <div class="group">
          <label>Setor</label>
          <select id="rSetor">${setoresOpts}</select>
        </div>
        <div class="group">
          <label>Dire√ß√£o</label>
          <select id="rDir">
            <option value="ambos">Entradas e sa√≠das</option>
            <option value="entradas">Somente entradas</option>
            <option value="saidas">Somente sa√≠das</option>
          </select>
        </div>
      </div>
      <div class="twocol">
        <div class="group">
          <label>De (dd/mm/aaaa)</label>
          <input id="rDeBR" placeholder="01/01/2026" inputmode="numeric" />
        </div>
        <div class="group">
          <label>At√© (dd/mm/aaaa)</label>
          <input id="rAteBR" placeholder="31/12/2026" inputmode="numeric" />
        </div>
      </div>
      <div class="muted">Dica: filtre por per√≠odo e gere o PDF.</div>
    `;
    return;
  }

  if(tipo==="invgeral"){
    box.innerHTML = `
      <div class="group">
        <label>Buscar (opcional)</label>
        <input id="rBusca" placeholder="produto, c√≥digo, NCM, setor..." />
      </div>
      <div class="twocol">
        <label class="chk"><input id="rInvIncluiZerado" type="checkbox" checked> Incluir zerados</label>
        <label class="chk"><input id="rInvSomenteAtivos" type="checkbox" checked> Somente ativos</label>
      </div>
    `;
    return;
  }

  if(tipo==="critico"){
    box.innerHTML = `
      <div class="twocol">
        <label class="chk"><input id="rCritAbaixoMin" type="checkbox" checked> Abaixo do m√≠nimo</label>
        <label class="chk"><input id="rCritSomenteZerado" type="checkbox"> Somente zerado</label>
      </div>
      <div class="group">
        <label>Classifica√ß√£o (opcional)</label>
        <select id="rCritClass">${classOpts}</select>
      </div>
      <div class="group">
        <label>Buscar (opcional)</label>
        <input id="rBusca" placeholder="produto, c√≥digo, NCM..." />
      </div>
    `;
    return;
  }

  if(tipo==="porclass"){
    box.innerHTML = `
      <div class="group">
        <label>Classifica√ß√£o</label>
        <select id="rClass">${classOpts}</select>
      </div>
      <div class="group">
        <label>Ordenar</label>
        <select id="rClassOrd">
          <option value="nome">Nome</option>
          <option value="estoqueDesc">Estoque (maior ‚Üí menor)</option>
          <option value="valorDesc">Valor em estoque (maior ‚Üí menor)</option>
        </select>
      </div>
      <div class="group">
        <label>Buscar (opcional)</label>
        <input id="rBusca" placeholder="produto, c√≥digo, NCM..." />
      </div>
    `;
    return;
  }

  if(tipo==="entradas"){
    box.innerHTML = `
      <div class="twocol">
        <div class="group" style="margin:0">
          <label>De (dd/mm/aaaa)</label>
          <input id="rDeBR" placeholder="01/01/2026" inputmode="numeric" />
        </div>
        <div class="group" style="margin:0">
          <label>At√© (dd/mm/aaaa)</label>
          <input id="rAteBR" placeholder="31/12/2026" inputmode="numeric" />
        </div>
      </div>
      <div class="group">
        <label>Empresa / Fornecedor (opcional)</label>
        <input id="rEmp" placeholder="ex.: CASA DO CONSTRUTOR" />
      </div>
      <div class="group">
        <label>Produto (opcional)</label>
        <input id="rProd" placeholder="nome, NCM, c√≥digo do item..." />
      </div>
      <div class="muted">Usa as notas importadas via XML (Hist√≥rico de notas).</div>
    `;
    return;
  }

  if(tipo==="abc"){
    box.innerHTML = `
      <div class="group">
        <label>Base da Curva ABC</label>
        <select id="rAbcBase">
          <option value="estoque" selected>Valor em estoque (estoqueAtual √ó pre√ßo)</option>
          <option value="entradas">Valor de entradas (NF-e) no per√≠odo</option>
        </select>
      </div>
      <div class="twocol" id="rAbcPeriodo" style="display:none">
        <div class="group" style="margin:0">
          <label>De (dd/mm/aaaa)</label>
          <input id="rDeBR" placeholder="01/01/2026" inputmode="numeric" />
        </div>
        <div class="group" style="margin:0">
          <label>At√© (dd/mm/aaaa)</label>
          <input id="rAteBR" placeholder="31/12/2026" inputmode="numeric" />
        </div>
      </div>
      <div class="group">
        <label>Buscar (opcional)</label>
        <input id="rBusca" placeholder="produto, classifica√ß√£o, NCM..." />
      </div>
      <div class="muted">Classes: A (at√© 80%), B (at√© 95%), C (restante).</div>
    `;
    setTimeout(()=>{
      const sel = $("rAbcBase");
      if(sel){
        const sync = ()=>{
          const show = (sel.value==="entradas");
          const box = $("rAbcPeriodo");
          if(box) box.style.display = show ? "" : "none";
        };
        sel.addEventListener("change", sync);
        sync();
      }
    },0);
    return;
  }

  // padr√£o: movgeral
  box.innerHTML = `
    <div class="twocol">
      <div class="group">
        <label>De (dd/mm/aaaa)</label>
        <input id="rDeBR" placeholder="01/01/2026" inputmode="numeric" />
      </div>
      <div class="group">
        <label>At√© (dd/mm/aaaa)</label>
        <input id="rAteBR" placeholder="31/12/2026" inputmode="numeric" />
      </div>
    </div>
    <div class="group">
      <label>Buscar (opcional)</label>
      <input id="rBusca" placeholder="produto, c√≥digo, setor..." />
    </div>
  `;
}


function brDateTime(dt){
  const d = (dt instanceof Date) ? dt : new Date(dt);
  const pad = (n)=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function ptbrToDate(s){
  // s: "dd/mm/aaaa, hh:mm:ss" or "dd/mm/aaaa hh:mm"
  if(!s) return null;
  const m = String(s).match(/^(\d{2})\/(\d{2})\/(\d{4})/);
  if(!m) return null;
  const dd=+m[1], mm=+m[2]-1, yy=+m[3];
  // try time
  const t = String(s).match(/(\d{2}):(\d{2})(?::(\d{2}))?/);
  const hh=t?+t[1]:0, mi=t?+t[2]:0, ss=t&&t[3]?+t[3]:0;
  return new Date(yy,mm,dd,hh,mi,ss);
}

function buildReportCard(title, subtitle, tableHTML){
  return `
    <div class="rt-card">
      <div class="rt-title">${escapeHtml(title)}</div>
      <div class="rt-sub">${escapeHtml(subtitle)}</div>
      ${tableHTML}
    </div>
  `;
}

function tableFromRows(cols, rows){
  const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr></thead>`;
  const tbody = rows.length
    ? `<tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${r[c] ?? ""}</td>`).join("")}</tr>`).join("")}</tbody>`
    : `<tbody><tr><td colspan="${cols.length}" class="muted" style="padding:12px">Nenhum registro.</td></tr></tbody>`;
  return `<table class="rt-table">${thead}${tbody}</table>`;
}

/* ---- Template de PDF (modelo moderno) ---- */
let lastPDFHtml = "";
let lastPDFName = "relatorio";

function buildPrintableDoc({title, subtitle, bodyHTML}){
  const now = new Date().toLocaleString("pt-BR");
  // IMPORTANTE (Android/Chrome): N√ÉO usar tags <script> dentro desta string,
  // pois isso pode encerrar o <script> principal do app e imprimir c√≥digo na tela.
  // Para disparar o PDF, usamos onload no <body>.
  return `<!doctype html><html lang="pt-BR"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHtml(title)}</title>
<style>
:root{--pri:#00d4ff;--sec:#7c3aed;--line:#e7e9f4;--mut:#5b6288;}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; color:#111; background:#fff}
.wrap{padding:14mm 12mm 18mm}

.phdr{position:fixed;left:0;right:0;top:0;padding:10mm 12mm 6mm;background:#fff;border-bottom:1px solid var(--line);z-index:2}
.wrap{padding:32mm 0 22mm} /* espa√ßo para cabe√ßalho e rodap√© fixos */
@media print{
  body{margin:0}
}

.hdr{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;border-bottom:3px solid #0b0d18;padding-bottom:10px;margin-bottom:12px}
.brand{display:flex;flex-direction:column;gap:4px}
.brand .app{font-weight:950;font-size:18px;letter-spacing:.2px}
.title{font-weight:950;font-size:20px;margin:0}
.subtitle{font-weight:800;font-size:12px;color:var(--mut);margin-top:6px}
.meta{font-size:11px;color:var(--mut);font-weight:800;text-align:right}
table{width:100%;border-collapse:collapse;font-size:11px}
thead th{padding:10px 8px;text-align:left;background:linear-gradient(135deg,var(--pri),var(--sec));color:#061018;font-weight:950}
tbody td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
tbody tr:nth-child(even){background:#f6f7fb}
.card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px}
.footer{position:fixed;left:0;right:0;bottom:0;padding:6mm 12mm;font-size:11px;color:var(--mut);display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--line);background:#fff}
.pnum{font-weight:900}
.pnum::after{content:"P√°gina " counter(page) " de " counter(pages);}
@page{margin:14mm 12mm 18mm}
</style></head>
<body onload="setTimeout(function(){window.print();},250)">
<div class="phdr">
  <div class="hdr">
    <div class="brand">
      <div class="app">ALMOX2026</div>
      <div class="title">${escapeHtml(title)}</div>
      <div class="subtitle">${escapeHtml(subtitle||"")}</div>
    </div>
    <div class="meta">
      <div><b>Gerado:</b> ${escapeHtml(now)}</div>
      <div>Modo offline</div>
    </div>
  </div>
</div>
<div class="wrap">
  ${bodyHTML}
</div>
<div class="footer">
  <div class="pnum"></div>
  <div>ALMOX2026 ‚Ä¢ Relat√≥rio</div>
  <div>${escapeHtml(now)}</div>
</div>
</body></html>`;
}

function openPrintWindow(html, name){
  const w = window.open("", "_blank");
  if(!w){ toast("‚ö†Ô∏è Pop-up bloqueado"); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* ---- Gerar relat√≥rios ---- */

$("btnGerarRel").addEventListener("click",()=>{
  const tipo = $("rTipo").value;
  const out = $("rOut");

  const toDate = (br)=>{
    const m = String(br||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return null;
    return new Date(+m[3], +m[2]-1, +m[1], 0,0,0);
  };
  const de = toDate($("rDeBR")?.value);
  const ate = toDate($("rAteBR")?.value);
  const ateEnd = ate ? new Date(ate.getFullYear(), ate.getMonth(), ate.getDate(), 23,59,59) : null;

  const norm = (s)=>String(s||"").toLowerCase();
  const busca = norm($("rBusca")?.value);

  // ========= Helpers p/ relat√≥rios =========
  const money = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const num = (v)=> (Number(v||0)).toLocaleString("pt-BR");
  const safe = (s)=>escapeHtml(String(s||""));

  const produtoHay = (p)=>{
    return `${p.nome||""} ${p.descricao||""} ${p.codigo1||""} ${p.codigo2||""} ${p.ncm||""} ${p.categoria||p.classificacao||""}`.toLowerCase();
  };

  // ========= 1) Movimenta√ß√µes (mantido) =========
  if(tipo==="movgeral" || tipo==="movsetor"){
    let list = movs.slice().reverse().filter(m=>{
      const dt = m.quandoISO ? new Date(m.quandoISO) : ptbrToDate(m.quando);
      if(de && (!dt || dt<de)) return false;
      if(ateEnd && (!dt || dt>ateEnd)) return false;
      if(busca){
        const hay = `${m.produto_nome||""} ${m.codigo2||""} ${m.origem||""} ${m.destino||""} ${m.obs||""}`.toLowerCase();
        if(!hay.includes(busca)) return false;
      }
      return true;
    });

    let subt = "Registro de entradas e sa√≠das";
    if(tipo==="movsetor"){
      const setor = $("rSetor")?.value || "ALMOXARIFADO";
      const dir = $("rDir")?.value || "ambos";
      subt = `${setor} ‚Ä¢ ${$("rDir")?.selectedOptions?.[0]?.textContent||""}`;
      list = list.filter(m=>{
        let ok = (m.origem===setor || m.destino===setor);
        if(dir==="entradas") ok = (m.destino===setor);
        if(dir==="saidas") ok = (m.origem===setor);
        return ok;
      });
    }

    const titulo = (tipo==="movsetor") ? `Movimenta√ß√µes por Setor` : `Movimenta√ß√µes (Geral)`;
    const periodo = `${$("rDeBR")?.value||"‚Äî"} at√© ${$("rAteBR")?.value||"‚Äî"}`;

    const rows = list.map(m=>{
      const dt = m.quandoISO ? new Date(m.quandoISO) : ptbrToDate(m.quando);
      const quando = dt ? brDateTime(dt) : (m.quando||"");
      return `
        <tr>
          <td>${safe(quando)}</td>
          <td><b>${safe(m.produto_nome||"")}</b><div class="muted">C√≥digo: ${safe(m.codigo2||"")}</div></td>
          <td>${safe(m.origem||"")}</td>
          <td>${safe(m.destino||"")}</td>
          <td style="text-align:right"><b>${safe(String(m.qtd||0))}</b></td>
          <td>${safe(m.obs||"")}</td>
        </tr>
      `;
    }).join("");

    const body = `
      <div class="rel-card">
        <div class="rel-top">
          <div>
            <div class="rel-title">üìÑ ${safe(titulo)}</div>
            <div class="rel-sub">${safe(subt)} ‚Ä¢ Per√≠odo: ${safe(periodo)}</div>
          </div>
          <div class="rel-chip">${list.length} registros</div>
        </div>

        <table class="rel-table">
          <thead>
            <tr>
              <th>Data/Hora</th><th>Produto</th><th>Origem</th><th>Destino</th><th style="text-align:right">Qtd</th><th>Obs</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="6" class="muted" style="padding:14px">Nenhuma movimenta√ß√£o no per√≠odo.</td></tr>`}</tbody>
        </table>
      </div>
    `;

    out.innerHTML = body;
    lastPDFHtml = buildPDFHtml(titulo, subt, periodo, body);
    return;
  }

  // ========= 2) Invent√°rio Geral =========
  if(tipo==="invgeral"){
    const incluiZerado = !!$("rInvIncluiZerado")?.checked;
    const somenteAtivos = !!$("rInvSomenteAtivos")?.checked;

    let list = produtos.slice().filter(p=>{
      if(somenteAtivos && p.ativo===false) return false;
      const est = Number(p.estoqueAtual||0);
      if(!incluiZerado && est<=0) return false;
      if(busca && !produtoHay(p).includes(busca)) return false;
      return true;
    });

    list.sort((a,b)=> (String(a.categoria||"").localeCompare(String(b.categoria||""),"pt-BR")) || (String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR")));

    const totalItens = list.length;
    const totalQtd = list.reduce((s,p)=>s+(Number(p.estoqueAtual||0)),0);
    const totalValor = list.reduce((s,p)=>s+(Number(p.estoqueAtual||0)*Number(p.preco||0)),0);

    const rows = list.map(p=>{
      const est = Number(p.estoqueAtual||0);
      const min = Number(p.estoqueMin||0);
      const status = est<=0 ? "ZERADO" : (est<min ? "BAIXO" : "OK");
      const cls = safe(p.categoria||p.classificacao||"");
      return `
        <tr>
          <td>${safe(p.codigo2||p.codigo1||"")}</td>
          <td><b>${safe(p.nome||"")}</b><div class="muted">${safe(p.descricao||"")}</div></td>
          <td>${cls}</td>
          <td>${safe(p.ncm||"")}</td>
          <td style="text-align:right">${num(est)}</td>
          <td style="text-align:right">${num(min)}</td>
          <td style="text-align:right">${money(p.preco||0)}</td>
          <td style="text-align:right"><b>${money(est*Number(p.preco||0))}</b></td>
          <td><span class="rel-pill ${status==="OK"?"ok":status==="BAIXO"?"warn":"bad"}">${status}</span></td>
        </tr>
      `;
    }).join("");

    const titulo = "Invent√°rio Geral";
    const subt = (somenteAtivos ? "Somente ativos" : "Ativos + inativos") + (incluiZerado ? " ‚Ä¢ inclui zerados" : " ‚Ä¢ sem zerados");
    const periodo = "Base: estoque atual";
    const kpis = `
      <div class="rel-kpis">
        <div class="kpi"><div class="k">Itens</div><div class="v">${num(totalItens)}</div></div>
        <div class="kpi"><div class="k">Qtd total</div><div class="v">${num(totalQtd)}</div></div>
        <div class="kpi"><div class="k">Valor total</div><div class="v">${money(totalValor)}</div></div>
      </div>
    `;
    const body = `
      <div class="rel-card">
        <div class="rel-top">
          <div>
            <div class="rel-title">üì¶ ${safe(titulo)}</div>
            <div class="rel-sub">${safe(subt)}</div>
          </div>
          <div class="rel-chip">${num(totalItens)} itens</div>
        </div>
        ${kpis}
        <table class="rel-table">
          <thead>
            <tr>
              <th>C√≥digo</th><th>Produto</th><th>Classifica√ß√£o</th><th>NCM</th>
              <th style="text-align:right">Estoque</th><th style="text-align:right">M√≠n</th>
              <th style="text-align:right">Pre√ßo</th><th style="text-align:right">Valor</th><th>Status</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="9" class="muted" style="padding:14px">Nenhum item encontrado.</td></tr>`}</tbody>
        </table>
      </div>
    `;
    out.innerHTML = body;
    lastPDFHtml = buildPDFHtml(titulo, subt, periodo, body);
    return;
  }

  // ========= 3) Estoque Cr√≠tico =========
  if(tipo==="critico"){
    const abaixoMin = !!$("rCritAbaixoMin")?.checked;
    const somenteZerado = !!$("rCritSomenteZerado")?.checked;
    const filClass = ($("rCritClass")?.value||"").trim();

    let list = produtos.slice().filter(p=>{
      const est = Number(p.estoqueAtual||0);
      const min = Number(p.estoqueMin||0);
      const crit = somenteZerado ? (est<=0) : (abaixoMin ? (est<min) : (est<=0));
      if(!crit) return false;
      const cls = String(p.categoria||p.classificacao||"").trim();
      if(filClass && cls!==filClass) return false;
      if(busca && !produtoHay(p).includes(busca)) return false;
      return true;
    });

    list.sort((a,b)=> (Number(a.estoqueAtual||0)-Number(b.estoqueAtual||0)) || String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));

    const titulo = "Estoque Cr√≠tico";
    const subt = (somenteZerado ? "Somente zerados" : "Abaixo do m√≠nimo") + (filClass? ` ‚Ä¢ ${filClass}`:"");
    const periodo = "Base: estoque atual";

    const rows = list.map(p=>{
      const est = Number(p.estoqueAtual||0);
      const min = Number(p.estoqueMin||0);
      const status = est<=0 ? "ZERADO" : "BAIXO";
      return `
        <tr>
          <td>${safe(p.codigo2||p.codigo1||"")}</td>
          <td><b>${safe(p.nome||"")}</b><div class="muted">${safe(p.descricao||"")}</div></td>
          <td>${safe(p.categoria||p.classificacao||"")}</td>
          <td>${safe(p.ncm||"")}</td>
          <td style="text-align:right"><b>${num(est)}</b></td>
          <td style="text-align:right">${num(min)}</td>
          <td><span class="rel-pill ${status==="BAIXO"?"warn":"bad"}">${status}</span></td>
        </tr>
      `;
    }).join("");

    const body = `
      <div class="rel-card">
        <div class="rel-top">
          <div>
            <div class="rel-title">üö® ${safe(titulo)}</div>
            <div class="rel-sub">${safe(subt)}</div>
          </div>
          <div class="rel-chip">${num(list.length)} itens</div>
        </div>
        <table class="rel-table">
          <thead>
            <tr>
              <th>C√≥digo</th><th>Produto</th><th>Classifica√ß√£o</th><th>NCM</th>
              <th style="text-align:right">Estoque</th><th style="text-align:right">M√≠n</th><th>Status</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="7" class="muted" style="padding:14px">Nenhum item cr√≠tico encontrado.</td></tr>`}</tbody>
        </table>
      </div>
    `;
    out.innerHTML = body;
    lastPDFHtml = buildPDFHtml(titulo, subt, periodo, body);
    return;
  }

  // ========= 4) Produtos por Classifica√ß√£o =========
  if(tipo==="porclass"){
    const cls = ($("rClass")?.value||"").trim();
    const ord = $("rClassOrd")?.value || "nome";

    let list = produtos.slice().filter(p=>{
      const c = String(p.categoria||p.classificacao||"").trim();
      if(cls && c!==cls) return false;
      if(busca && !produtoHay(p).includes(busca)) return false;
      return true;
    });

    const val = (p)=> Number(p.estoqueAtual||0)*Number(p.preco||0);
    if(ord==="estoqueDesc") list.sort((a,b)=> (Number(b.estoqueAtual||0)-Number(a.estoqueAtual||0)) || String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));
    else if(ord==="valorDesc") list.sort((a,b)=> (val(b)-val(a)) || String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));
    else list.sort((a,b)=> String(a.nome||"").localeCompare(String(b.nome||""),"pt-BR"));

    const titulo = "Produtos por Classifica√ß√£o";
    const subt = cls ? cls : "Todas";
    const periodo = "Base: estoque atual";

    const groups = {};
    for(const p of list){
      const c = String(p.categoria||p.classificacao||"Sem classifica√ß√£o").trim() || "Sem classifica√ß√£o";
      (groups[c]=groups[c]||[]).push(p);
    }
    const groupKeys = Object.keys(groups).sort((a,b)=>a.localeCompare(b,"pt-BR"));

    const sections = groupKeys.map(k=>{
      const items = groups[k];
      const totQtd = items.reduce((s,p)=>s+Number(p.estoqueAtual||0),0);
      const totVal = items.reduce((s,p)=>s+(Number(p.estoqueAtual||0)*Number(p.preco||0)),0);
      const rows = items.map(p=>`
        <tr>
          <td>${safe(p.codigo2||p.codigo1||"")}</td>
          <td><b>${safe(p.nome||"")}</b><div class="muted">${safe(p.descricao||"")}</div></td>
          <td>${safe(p.ncm||"")}</td>
          <td style="text-align:right">${num(p.estoqueAtual||0)}</td>
          <td style="text-align:right">${money(p.preco||0)}</td>
          <td style="text-align:right"><b>${money(Number(p.estoqueAtual||0)*Number(p.preco||0))}</b></td>
        </tr>
      `).join("");
      return `
        <div class="rel-section">
          <div class="rel-sec-top">
            <div class="rel-sec-title">${safe(k)}</div>
            <div class="rel-sec-sub">${num(items.length)} itens ‚Ä¢ Qtd: ${num(totQtd)} ‚Ä¢ Valor: ${money(totVal)}</div>
          </div>
          <table class="rel-table">
            <thead>
              <tr><th>C√≥digo</th><th>Produto</th><th>NCM</th><th style="text-align:right">Estoque</th><th style="text-align:right">Pre√ßo</th><th style="text-align:right">Valor</th></tr>
            </thead>
            <tbody>${rows || `<tr><td colspan="6" class="muted" style="padding:14px">Sem itens.</td></tr>`}</tbody>
          </table>
        </div>
      `;
    }).join("");

    const body = `
      <div class="rel-card">
        <div class="rel-top">
          <div>
            <div class="rel-title">üè∑Ô∏è ${safe(titulo)}</div>
            <div class="rel-sub">${safe(subt)}</div>
          </div>
          <div class="rel-chip">${num(list.length)} itens</div>
        </div>
        ${sections || `<div class="muted" style="padding:14px">Nenhum item encontrado.</div>`}
      </div>
    `;

    out.innerHTML = body;
    lastPDFHtml = buildPDFHtml(titulo, subt, periodo, body);
    return;
  }

  // ========= 5) Entradas (NF-e) =========
  if(tipo==="entradas"){
    const emp = norm($("rEmp")?.value);
    const prodQ = norm($("rProd")?.value);

    const notasList = (notas||[]).slice().reverse().filter(n=>{
      const dt = n.dhEmi ? new Date(n.dhEmi) : (n.dataISO? new Date(n.dataISO) : null);
      if(de && (!dt || dt<de)) return false;
      if(ateEnd && (!dt || dt>ateEnd)) return false;
      if(emp){
        const h = `${n.emitNome||""} ${n.emitFant||""} ${n.emitCNPJ||""}`.toLowerCase();
        if(!h.includes(emp)) return false;
      }
      if(prodQ){
        const items = Array.isArray(n.itens) ? n.itens : [];
        const hit = items.some(it=>{
          const h = `${it.xProd||it.nome||""} ${it.cProd||""} ${it.NCM||it.ncm||""} ${it.codigo2||""} ${it.codigo1||""}`.toLowerCase();
          return h.includes(prodQ);
        });
        if(!hit) return false;
      }
      return true;
    });

    const linhas = [];
    for(const n of notasList){
      const dt = n.dhEmi ? new Date(n.dhEmi) : (n.dataISO? new Date(n.dataISO) : null);
      const data = dt ? brDateTime(dt).slice(0,16).replace(" ", " ") : (n.data||"");
      const danfe = n.chave || n.chNFe || n.id || "";
      const empresa = n.emitNome || n.emitFant || "";
      const nf = n.nNF || n.numero || "";
      const items = Array.isArray(n.itens) ? n.itens : [];
      for(const it of items){
        if(prodQ){
          const h = `${it.xProd||it.nome||""} ${it.cProd||""} ${it.NCM||it.ncm||""}`.toLowerCase();
          if(!h.includes(prodQ)) continue;
        }
        linhas.push({
          data, empresa, nf, danfe,
          produto: (it.xProd||it.nome||""),
          ncm: (it.NCM||it.ncm||""),
          qtd: Number(it.qCom||it.qtd||0),
          vProd: Number(it.vProd||0)
        });
      }
    }

    const totalNotas = notasList.length;
    const totalItens = linhas.length;
    const totalQtd = linhas.reduce((s,x)=>s+x.qtd,0);
    const totalVal = linhas.reduce((s,x)=>s+x.vProd,0);

    const titulo = "Entradas (NF-e)";
    const subt = (emp ? `Empresa: ${$("rEmp")?.value}` : "Todas as empresas") + (prodQ ? ` ‚Ä¢ Produto: ${$("rProd")?.value}` : "");
    const periodo = `${$("rDeBR")?.value||"‚Äî"} at√© ${$("rAteBR")?.value||"‚Äî"}`;

    const kpis = `
      <div class="rel-kpis">
        <div class="kpi"><div class="k">Notas</div><div class="v">${num(totalNotas)}</div></div>
        <div class="kpi"><div class="k">Itens</div><div class="v">${num(totalItens)}</div></div>
        <div class="kpi"><div class="k">Qtd</div><div class="v">${num(totalQtd)}</div></div>
        <div class="kpi"><div class="k">Valor</div><div class="v">${money(totalVal)}</div></div>
      </div>
    `;

    const rows = linhas.map(x=>`
      <tr>
        <td>${safe(x.data)}</td>
        <td><b>${safe(x.empresa)}</b><div class="muted">NF: ${safe(x.nf)} ‚Ä¢ Chave: ${safe(String(x.danfe).slice(-12))}‚Ä¶</div></td>
        <td><b>${safe(x.produto)}</b><div class="muted">NCM: ${safe(x.ncm)}</div></td>
        <td style="text-align:right">${num(x.qtd)}</td>
        <td style="text-align:right"><b>${money(x.vProd)}</b></td>
      </tr>
    `).join("");

    const body = `
      <div class="rel-card">
        <div class="rel-top">
          <div>
            <div class="rel-title">üßæ ${safe(titulo)}</div>
            <div class="rel-sub">${safe(subt)} ‚Ä¢ Per√≠odo: ${safe(periodo)}</div>
          </div>
          <div class="rel-chip">${num(totalItens)} itens</div>
        </div>
        ${kpis}
        <table class="rel-table">
          <thead>
            <tr><th>Data</th><th>Empresa / NF</th><th>Produto</th><th style="text-align:right">Qtd</th><th style="text-align:right">Valor</th></tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="5" class="muted" style="padding:14px">Nenhuma entrada no per√≠odo.</td></tr>`}</tbody>
        </table>
      </div>
    `;
    out.innerHTML = body;
    lastPDFHtml = buildPDFHtml(titulo, subt, periodo, body);
    return;
  }

  // ========= 6) Curva ABC =========
  if(tipo==="abc"){
    const base = $("rAbcBase")?.value || "estoque";

    let items = [];
    if(base==="estoque"){
      items = produtos.map(p=>{
        const v = Number(p.estoqueAtual||0)*Number(p.preco||0);
        return {nome:p.nome||"", categoria:p.categoria||p.classificacao||"", ncm:p.ncm||"", valor:v};
      });
      if(busca){
        items = items.filter(x=>`${x.nome} ${x.categoria} ${x.ncm}`.toLowerCase().includes(busca));
      }
    }else{
      // Entradas no per√≠odo (por produto)
      const notasList = (notas||[]).slice().filter(n=>{
        const dt = n.dhEmi ? new Date(n.dhEmi) : (n.dataISO? new Date(n.dataISO) : null);
        if(de && (!dt || dt<de)) return false;
        if(ateEnd && (!dt || dt>ateEnd)) return false;
        return true;
      });

      const map = new Map();
      for(const n of notasList){
        const its = Array.isArray(n.itens)? n.itens: [];
        for(const it of its){
          const nome = String(it.xProd||it.nome||"").trim();
          const ncm = String(it.NCM||it.ncm||"").trim();
          const key = `${nome}||${ncm}`;
          const cur = map.get(key) || {nome, categoria:"(NF-e)", ncm, valor:0};
          cur.valor += Number(it.vProd||0);
          map.set(key, cur);
        }
      }
      items = Array.from(map.values());
      if(busca){
        items = items.filter(x=>`${x.nome} ${x.ncm}`.toLowerCase().includes(busca));
      }
    }

    items = items.filter(x=>Number(x.valor||0)>0);
    items.sort((a,b)=>b.valor-a.valor);

    const total = items.reduce((s,x)=>s+Number(x.valor||0),0);
    let acum = 0;

    const rows = items.map((x,i)=>{
      acum += x.valor;
      const perc = total ? (x.valor/total*100) : 0;
      const acumPerc = total ? (acum/total*100) : 0;
      const cls = (acumPerc<=80) ? "A" : (acumPerc<=95) ? "B" : "C";
      return `
        <tr>
          <td style="text-align:right">${i+1}</td>
          <td><b>${safe(x.nome)}</b><div class="muted">${safe(x.categoria||"")}</div></td>
          <td>${safe(x.ncm||"")}</td>
          <td style="text-align:right"><b>${money(x.valor)}</b></td>
          <td style="text-align:right">${perc.toFixed(2)}%</td>
          <td style="text-align:right">${acumPerc.toFixed(2)}%</td>
          <td><span class="rel-pill ${cls==="A"?"ok":cls==="B"?"warn":"bad"}">${cls}</span></td>
        </tr>
      `;
    }).join("");

    const titulo = "Curva ABC";
    const subt = base==="estoque" ? "Base: valor em estoque" : "Base: entradas NF-e (valor de produtos)";
    const periodo = base==="entradas" ? `${$("rDeBR")?.value||"‚Äî"} at√© ${$("rAteBR")?.value||"‚Äî"}` : "‚Äî";

    const body = `
      <div class="rel-card">
        <div class="rel-top">
          <div>
            <div class="rel-title">üìà ${safe(titulo)}</div>
            <div class="rel-sub">${safe(subt)} ${base==="entradas" ? `‚Ä¢ Per√≠odo: ${safe(periodo)}`:""}</div>
          </div>
          <div class="rel-chip">${num(items.length)} itens</div>
        </div>

        <div class="rel-kpis">
          <div class="kpi"><div class="k">Total</div><div class="v">${money(total)}</div></div>
          <div class="kpi"><div class="k">Itens</div><div class="v">${num(items.length)}</div></div>
        </div>

        <table class="rel-table">
          <thead>
            <tr>
              <th style="text-align:right">#</th><th>Produto</th><th>NCM</th>
              <th style="text-align:right">Valor</th><th style="text-align:right">% Item</th><th style="text-align:right">% Acum</th><th>Classe</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="7" class="muted" style="padding:14px">Sem dados suficientes para curva ABC.</td></tr>`}</tbody>
        </table>
      </div>
    `;

    out.innerHTML = body;
    lastPDFHtml = buildPDFHtml(titulo, subt, periodo, body);
    return;
  }

  toast("‚ö†Ô∏è Tipo de relat√≥rio n√£o suportado.");
});

$("btnPDFRel").addEventListener("click",()=>{
  if(!lastPDFHtml){ toast("‚ö†Ô∏è Gere um relat√≥rio primeiro"); return; }
  openPrintWindow(lastPDFHtml, lastPDFName);
});

$("btnLimparRel").addEventListener("click",()=>{
  $("rOut").innerHTML = "";
  lastPDFHtml = "";
  toast("üßπ Limpo");
});

/* ========= Gest√£o de Setores ========= */
let setorAtual = "ADMINISTRA√á√ÉO";
let lastSetPDFHtml = "";

$("btnSet").addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderSetores();
  abrirModal("modalSet");
});

$("sBusca")?.addEventListener("input", ()=>renderSetores());

function setorStats(setor){
  // saldo no setor (soma das aloca√ß√µes) + n¬∫ de movimenta√ß√µes (entradas/sa√≠das)
  let saldo = 0;
  for(const p of produtos){
    const al = (p.alocacoes && typeof p.alocacoes==="object") ? p.alocacoes : null;
    if(al && al[setor]) saldo += Number(al[setor])||0;
  }
  const movCount = movs.filter(m=>m.origem===setor || m.destino===setor).length;
  return {saldo, movCount};
}

function renderSetores(){
  const q = ($("sBusca")?.value || "").trim().toLowerCase();
  const grid = $("setGrid");
  if(!grid) return;
  grid.innerHTML = "";

  const list = SETORES.filter(s=>{
    if(!q) return true;
    return s.toLowerCase().includes(q);
  });

  // ordena por saldo desc, depois nome
  const enriched = list.map(s=>({s, ...setorStats(s)}))
    .sort((a,b)=> (b.saldo-a.saldo) || a.s.localeCompare(b.s,'pt-BR'));

  enriched.forEach(({s, saldo, movCount})=>{
    const card = document.createElement("div");
    card.className = "set-card";
    card.innerHTML = `
      <div class="set-top">
        <div class="set-name">${escapeHtml(s)}</div>
        <div class="set-chip">Mov: <span class="set-num">${movCount}</span></div>
      </div>
      <div class="set-sub">Saldo no setor: <span class="set-num">${saldo}</span></div>
    `;
    card.addEventListener("click", ()=>abrirSetorDetalhe(s));
    grid.appendChild(card);
  });

  if(!enriched.length){
    grid.innerHTML = `<div class="rt-card" style="grid-column:1/-1"><div class="rt-title">Nenhum setor encontrado</div></div>`;
  }
}

function abrirSetorDetalhe(setor){
  setorAtual = setor;
  $("sdTitle").textContent = `üèõÔ∏è ${setor}`;
  // defaults: hoje
  const d = new Date(); const pad=n=>String(n).padStart(2,"0");
  const hoje = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  $("sdDe").value = hoje;
  $("sdAte").value = hoje;
  $("sdDir").value = "ambos";
  $("sdOut").innerHTML = "";
  $("sdResumo").innerHTML = "";
  lastSetPDFHtml = "";
  fecharModal("modalSet");
  abrirModal("modalSetDet");
  gerarRelSetor(); // gera automaticamente
}

function gerarRelSetor(){
  const deISO = $("sdDe").value || "";
  const ateISO = $("sdAte").value || "";
  const dir = $("sdDir").value || "ambos";
  const de = deISO ? new Date(deISO+"T00:00:00") : null;
  const ate = ateISO ? new Date(ateISO+"T23:59:59") : null;

  const list = movs.filter(m=>{
    const dt = ptbrToDate(m.quando);
    const okd = !de || (dt && dt>=de);
    const oka = !ate || (dt && dt<=ate);
    let oks = (m.origem===setorAtual || m.destino===setorAtual);
    if(dir==="entradas") oks = (m.destino===setorAtual);
    if(dir==="saidas") oks = (m.origem===setorAtual);
    return okd && oka && oks;
  }).slice().reverse();

  // resumo (saldo atual + entradas/sa√≠das no per√≠odo)
  const {saldo} = setorStats(setorAtual);
  let ent=0, sai=0;
  list.forEach(m=>{
    if(m.destino===setorAtual) ent += Number(m.qtd)||0;
    if(m.origem===setorAtual) sai += Number(m.qtd)||0;
  });

  
  // saldo por classifica√ß√£o e top produtos (saldo atual no setor)
  const catMap = {};
  const prodSaldos = [];
  for(const p of produtos){
    const al = (p.alocacoes && typeof p.alocacoes==="object") ? p.alocacoes : null;
    const s = al ? (Number(al[setorAtual])||0) : 0;
    if(s>0){
      const c = p.categoria || "SEM CLASSIFICA√á√ÉO";
      catMap[c] = (catMap[c]||0) + s;
      prodSaldos.push({ nome: p.nome||"", codigo: (p.codigo2||p.codigo1||""), categoria: c, saldo: s });
    }
  }
  const catRows = Object.entries(catMap)
    .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0],'pt-BR'))
    .map(([c,v])=> `<tr><td>${escapeHtml(c)}</td><td style="text-align:right"><b>${v}</b></td></tr>`)
    .join("") || `<tr><td colspan="2" class="muted" style="padding:10px">Nenhum saldo no setor.</td></tr>`;

  const top = prodSaldos.sort((a,b)=> b.saldo-a.saldo).slice(0,20);
  const topRows = top.map(x=> `
    <tr>
      <td>${escapeHtml(x.codigo)}</td>
      <td>${escapeHtml(x.nome)}</td>
      <td>${escapeHtml(x.categoria)}</td>
      <td style="text-align:right"><b>${x.saldo}</b></td>
    </tr>
  `).join("") || `<tr><td colspan="4" class="muted" style="padding:10px">Nenhum saldo no setor.</td></tr>`;

$("sdResumo").innerHTML = `
    <div class="rt-title">Resumo</div>
    <div class="rt-sub">Per√≠odo: ${escapeHtml(deISO||"‚Äî")} a ${escapeHtml(ateISO||"‚Äî")} ‚Ä¢ Registros: ${list.length}</div>

    <div class="twocol" style="margin-top:10px">
      <div class="rt-card" style="margin:0">
        <div class="rt-sub">Saldo atual no setor</div>
        <div class="rt-title" style="margin:0">${saldo}</div>
      </div>
      <div class="rt-card" style="margin:0">
        <div class="rt-sub">Entradas / Sa√≠das (per√≠odo)</div>
        <div class="rt-title" style="margin:0">${ent} / ${sai}</div>
      </div>
    </div>

    <div class="rt-card" style="margin-top:12px">
      <div class="rt-title" style="margin:0 0 6px 0">üè∑Ô∏è Saldo por Classifica√ß√£o</div>
      <table class="rt-table">
        <thead><tr><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
        <tbody>${catRows}</tbody>
      </table>
    </div>

    <div class="rt-card" style="margin-top:12px">
      <div class="rt-title" style="margin:0 0 6px 0">üì¶ Top 20 produtos no setor</div>
      <table class="rt-table">
        <thead><tr><th>C√≥digo</th><th>Produto</th><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
        <tbody>${topRows}</tbody>
      </table>
    </div>
  `;

  const rows = list.map(m=>({
    "Quando": escapeHtml(m.quando||""),
    "Produto": escapeHtml(m.produto_nome||""),
    "Classifica√ß√£o": escapeHtml(m.categoria||""),
    "Qtd": `<b>${m.qtd}</b>`,
    "Origem": escapeHtml(m.origem||""),
    "Destino": escapeHtml(m.destino||""),
    "Obs": escapeHtml(m.obs||"")
  }));
  const cols = ["Quando","Produto","Classifica√ß√£o","Qtd","Origem","Destino","Obs"];
  const table = tableFromRows(cols, rows);

  const subt = `Setor: ${setorAtual} ‚Ä¢ ${deISO||"‚Äî"} a ${ateISO||"‚Äî"} ‚Ä¢ Registros: ${list.length}`;
  const card = buildReportCard("Movimenta√ß√µes do setor", subt, table);
  $("sdOut").innerHTML = card;

  lastSetPDFHtml = buildPrintableDoc({
    title:`Movimenta√ß√µes do Setor ‚Ä¢ ${setorAtual}`,
    subtitle: subt,
    bodyHTML: `
      <div class="card">
        <div style="font-weight:950;font-size:14px;margin-bottom:6px">Resumo</div>
        <div style="font-size:11px;color:#5b6288;font-weight:800">Saldo atual: <b>${saldo}</b> ‚Ä¢ Entradas/Sa√≠das no per√≠odo: <b>${ent}</b>/<b>${sai}</b></div>
      </div>

      <div class="card">
        <div style="font-weight:950;font-size:14px;margin-bottom:6px">Saldo por Classifica√ß√£o</div>
        <table>
          <thead><tr><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
          <tbody>${catRows}</tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:950;font-size:14px;margin-bottom:6px">Top 20 produtos no setor</div>
        <table>
          <thead><tr><th>C√≥digo</th><th>Produto</th><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
          <tbody>${topRows}</tbody>
        </table>
      </div>

      ${card.replace(/rt-card/g,'card').replace(/<table class="rt-table">/g,'<table>').replace(/rt-table/g,'')}
    `
  });

  toast("‚úÖ Setor carregado");
}

$("btnGerarSet").addEventListener("click", gerarRelSetor);

$("btnPDFSet").addEventListener("click", ()=>{
  if(!lastSetPDFHtml){ toast("‚ö†Ô∏è Gere primeiro"); return; }
  openPrintWindow(lastSetPDFHtml, "setor_"+setorAtual);
});

$("btnVoltarSet").addEventListener("click", ()=>{
  fecharModal("modalSetDet");
  renderSetores();
  abrirModal("modalSet");
});



$("btnEstoque").addEventListener("click",()=>{ window.scrollTo({top:0,behavior:"smooth"}); toast("üì¶ Estoque"); });

/* ---- Persist√™ncia ---- */
function save(){
  localStorage.setItem(KEY_PROD, JSON.stringify(produtos));
  localStorage.setItem(KEY_MOV, JSON.stringify(movs));
  localStorage.setItem(KEY_NOTAS, JSON.stringify(notas));
}
function load(){
  try{
    const raw = localStorage.getItem(KEY_PROD);
    const rm  = localStorage.getItem(KEY_MOV);
    produtos = raw ? JSON.parse(raw).map(normalizeProduto) : [];
    movs = rm ? JSON.parse(rm) : [];
    const rn = localStorage.getItem(KEY_NOTAS);
    notas = rn ? JSON.parse(rn) : [];
  }catch{ produtos=[]; movs=[]; }
}

/* ---- Normaliza√ß√£o compat√≠vel com seu JSON ---- */
function parseInputJSON(data){
  if(Array.isArray(data)){
    // suporte ao formato antigo estranho
    if(data.length>=4 && data[1]==="produtos" && String(data[2]).trim()===":" && Array.isArray(data[3])) return data[3];
    return data;
  }
  if(data && typeof data==="object"){
    if(Array.isArray(data.produtos)) return data.produtos;
    if(Array.isArray(data.Produtos)) return data.Produtos;
    if(Array.isArray(data.itens)) return data.itens;
    if(Array.isArray(data.items)) return data.items;
    if(Array.isArray(data.data)) return data.data;
  }
  return null;
}

function normalizeProduto(p){
  const o = {...p};

  // Identificadores
  o.codigo1 = (o.codigo1 ?? o.id ?? "NULL");
  o.codigo2 = (o.codigo2 ?? o.sku ?? "");

  // Textos
  o.nome      = String(o.nome ?? o.descricao ?? o.item ?? o.produto ?? "").trim();
  o.descricao = String(o.descricao ?? "").trim();

  // Classifica√ß√£o / grupo
  o.categoria = String(o.categoria ?? o.classificacao ?? o.grupo ?? "SEM CLASSIFICA√á√ÉO").trim() || "SEM CLASSIFICA√á√ÉO";

  // NCM (mant√©m formato com pontos se vier assim)
  o.ncm = String(o.ncm ?? o.NCM ?? o.ncm_codigo ?? "").trim();

  // Estoques / valores
  o.estoqueAtual = Number(o.estoqueAtual ?? o.estoque_atual ?? o.qtd ?? o.quantidade ?? 0) || 0;
  o.estoqueMin   = Number(o.estoqueMin ?? o.estoque_minimo ?? o.minimo ?? 0) || 0;
  o.preco        = Number(o.preco ?? o.preco_custo ?? o.valor ?? 0) || 0;

  // Local e status
  o.setor = String(o.setor ?? o.local ?? "ALMOXARIFADO").trim() || "ALMOXARIFADO";
  o.ativo = (o.ativo ?? o.active ?? o.ativo_sn);
  if(typeof o.ativo === "string") o.ativo = !/^(0|false|n|nao|n√£o)$/i.test(o.ativo.trim());
  if(typeof o.ativo !== "boolean") o.ativo = true;

  return o;
}

function categoriasUnicas(){
  const s = new Set(produtos.map(p=>p.categoria).filter(Boolean));
  return Array.from(s).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
}

/* ---- UI Estoque ---- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function statusProduto(p){
  const a=p.estoqueAtual||0, m=p.estoqueMin||0;
  if(a===0) return {cls:"zero", txt:"ZERADO"};
  if(a<=m) return {cls:"low", txt:"BAIXO"};
  return {cls:"ok", txt:"OK"};
}

function updateStats(){
  let ok=0, low=0, zero=0;
  for(const p of produtos){
    const st=statusProduto(p).cls;
    if(st==="ok") ok++; else if(st==="low") low++; else zero++;
  }
  $("statTotal").textContent = produtos.length;
  $("statOk").textContent = ok;
  $("statLow").textContent = low;
  $("statZero").textContent = zero;
}

function render(){
  const q = ($("q").value||"").toLowerCase().trim();
  const list = !q ? produtos : produtos.filter(p=>{
    const hay = `${p.nome} ${p.descricao||""} ${p.codigo1} ${p.codigo2} ${p.categoria} ${p.ncm||""} ${p.setor||""}`.toLowerCase();
    return hay.includes(q);
  });

  const grid=$("grid");
  grid.innerHTML="";

  if(produtos.length===0){
    grid.innerHTML = `<div class="card"><div style="font-weight:950">Importe seu JSON em üíæ Dados.</div><div class="muted" style="margin-top:8px">Depois disso, tudo funciona offline.</div></div>`;
    updateStats();
    return;
  }
  if(list.length===0){
    grid.innerHTML = `<div class="card"><div style="font-weight:950">Nenhum resultado.</div><div class="muted" style="margin-top:8px">Tente outro termo.</div></div>`;
    updateStats();
    return;
  }

  list.forEach(p=>{
    const st=statusProduto(p);
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="row">
        <div>
          <div class="code">${escapeHtml(p.codigo2||p.codigo1||"-")}</div>
          <div class="muted" style="margin-top:2px;font-size:12px">${escapeHtml(p.codigo1 && p.codigo1!=="NULL" ? "("+p.codigo1+")" : "")}</div>
        </div>
        <div class="cat">${escapeHtml(p.categoria||"")}</div>
      </div>
      <div class="name">${escapeHtml(p.nome||"-")}</div>
      <div class="muted" style="margin-top:6px;font-size:12px;display:flex;gap:10px;flex-wrap:wrap;">
        ${p.ncm?`<span><b>NCM</b>: ${escapeHtml(p.ncm)}</span>`:""}
        ${p.setor?`<span><b>Setor</b>: ${escapeHtml(p.setor)}</span>`:""}
        ${p.ativo===false?`<span class="badge" style="border-color: rgba(245, 158, 11, .5); color:#f59e0b">INATIVO</span>`:""}
      </div>
      <div class="meta">
        <div class="box">
          <div class="lbl">ESTOQUE</div>
          <div class="val">${p.estoqueAtual||0} / ${p.estoqueMin||0}</div>
        </div>
        <div class="box">
          <div class="lbl">PRE√áO</div>
          <div class="val">R$ ${(Number(p.preco)||0).toFixed(2)}</div>
        </div>
      </div>
      <div class="status">
        <div class="muted" style="font-weight:900">${escapeHtml(p.setor||"ALMOXARIFADO")}</div>
        <div class="badge ${st.cls}">${st.txt}</div>
      </div>
    `;
    card.addEventListener("click",()=>openEdit(p));
    grid.appendChild(card);
  });

  updateStats();
}

/* ---- Editar produto ---- */
function openEdit(p){
  editIndex = produtos.indexOf(p);
  if(editIndex<0) return;

  const catList = categoriasUnicas();
  $("pCategoria").innerHTML = (catList.length ? catList : ["SEM CLASSIFICA√á√ÉO"])
    .map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

  $("pCodigo1").value = p.codigo1 ?? "";
  $("pCodigo2").value = p.codigo2 ?? "";
  $("pNome").value    = p.nome ?? "";
  $("pCategoria").value = p.categoria ?? (catList[0]||"SEM CLASSIFICA√á√ÉO");
  $("pNcm").value     = p.ncm ?? "";
  $("pSetor").value   = p.setor ?? "ALMOXARIFADO";
  $("pAtivo").checked = (p.ativo !== false);
  $("pAtual").value   = p.estoqueAtual ?? 0;
  $("pMin").value     = p.estoqueMin ?? 0;
  $("pPreco").value   = p.preco ?? 0;
  $("pDesc").value    = p.descricao ?? "";

  abrirModal("modalProduto");
}

$("btnSaveProd").addEventListener("click",()=>{
  if(editIndex<0) return;
  const p = produtos[editIndex];

  p.codigo1 = $("pCodigo1").value.trim() || "NULL";
  p.codigo2 = $("pCodigo2").value.trim();
  p.nome = $("pNome").value.trim();
  p.categoria = $("pCategoria").value;
  p.ncm = $("pNcm").value.trim();
  p.setor = $("pSetor").value.trim() || "ALMOXARIFADO";
  p.ativo = $("pAtivo").checked;

  p.estoqueAtual = Math.max(0, parseInt($("pAtual").value,10)||0);
  p.estoqueMin = Math.max(0, parseInt($("pMin").value,10)||0);
  p.preco = Math.max(0, parseFloat($("pPreco").value)||0);
  p.descricao = $("pDesc").value;

  save();
  fecharModal("modalProduto");
  toast("‚úÖ Produto salvo");
  render();
});

$("btnDelProd").addEventListener("click",()=>{
  if(editIndex<0) return;
  if(!confirm("Deletar este produto?")) return;
  produtos.splice(editIndex,1);
  editIndex=-1;
  save();
  fecharModal("modalProduto");
  toast("üóëÔ∏è Deletado");
  render();
});

/* ---- Dados: importar/exportar/reset ---- */
(function bindDados(){
  const btnImport = $("btnImport");
  const fileInput = $("fileInput");
  const btnExport = $("btnExport");
  const btnExportCSV = $("btnExportCSV");
  const btnExportNotas = $("btnExportNotas");
  const btnImportNotas = $("btnImportNotas");
  const notasInput = $("notasInput");
  const btnReset = $("btnReset");

  if(btnImport && fileInput){
    btnImport.addEventListener("click",()=> fileInput.click());
    fileInput.addEventListener("change",(e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      const r = new FileReader();
      r.onload = ()=>{
        try{
          const raw = String(r.result || "").replace(/^\uFEFF/, "").trim();
          const data = JSON.parse(raw);

          // Aceita: [ ... ], {produtos:[...]}, ou formato antigo especial
          const arr = parseInputJSON(data);
          if(!arr || !Array.isArray(arr)){
            toast("‚ö†Ô∏è JSON inv√°lido (n√£o achei lista de produtos)");
            return;
          }

          // mostra campos detectados (√∫til para validar o layout do seu JSON)
          try{
            const keys = new Set();
            for(let i=0;i<Math.min(arr.length, 200);i++){
              const o = arr[i] || {};
              Object.keys(o).forEach(k=> keys.add(k));
            }
            const listKeys = Array.from(keys).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
            const box = $("camposBox");
            const wrap = $("camposDetectados");
            if(box && wrap){
              wrap.innerHTML = listKeys.map(k=>`<span class="chip" style="border:1px solid rgba(255,255,255,.16); padding:6px 10px; border-radius:999px; font-size:12px;">${escapeHtml(k)}</span>`).join("");
              box.style.display = listKeys.length ? "block" : "none";
            }
          }catch(_){}

          produtos = arr.map(normalizeProduto);

          // movimenta√ß√µes embutidas (se existirem)
          movs = Array.isArray(data?.movimentacoes) ? data.movimentacoes
               : Array.isArray(data?.movs) ? data.movs
               : [];

          // notas embutidas (se existirem)
          notas = Array.isArray(data?.notas) ? data.notas : (Array.isArray(data?.Notas) ? data.Notas : notas);

          try{
            save();
          }catch(err){
            console.error("Erro ao salvar no localStorage:", err);
            toast("‚ùå Falha ao salvar no navegador (localStorage). Verifique permiss√µes/limite de armazenamento.");
            return;
          }

          toast(`‚úÖ Importado: ${produtos.length} itens`);
          fecharModal("modalDados");
          render();
          // permite importar o mesmo arquivo novamente sem precisar trocar o nome
          try{ fileInput.value = ""; }catch(_){};

          window.__lastJsonName = file.name || "dados.json";
          updateLinkedStatus();
        }catch(err){
          console.error("Import JSON error:", err);
          toast("‚ùå Erro ao importar: " + (err && err.message ? err.message : "falha"));
        }
      };
      r.readAsText(file, "utf-8");
      e.target.value="";
    });
  }

  if(btnExport){
    btnExport.addEventListener("click",()=>{
      const payload = { produtos, movimentacoes: movs, notas, exportado_em: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (window.__lastJsonName && /\.json$/i.test(window.__lastJsonName))
        ? window.__lastJsonName.replace(/\.json$/i,"_ATUALIZADO.json")
        : "ALMOX2026_ATUALIZADO.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("üì§ JSON exportado");
    });
  }

  if(btnExportCSV){
    btnExportCSV.addEventListener("click",()=>{
      if(!Array.isArray(produtos) || produtos.length===0){ toast("‚ö†Ô∏è Nada para exportar"); return; }
      const headers = ["codigo1","codigo2","codigo7","nome","categoria","ncm","estoqueAtual","estoqueMin","preco","setor"];
      const rows = produtos.map(p=>{
        const obj = {
          codigo1: p.codigo1 ?? "",
          codigo2: p.codigo2 ?? "",
          codigo7: p.codigo7 ?? "",
          nome: p.nome ?? "",
          categoria: p.categoria ?? "",
          ncm: p.ncm ?? "",
          estoqueAtual: p.estoqueAtual ?? 0,
          estoqueMin: p.estoqueMin ?? 0,
          preco: p.preco ?? 0,
          setor: p.setor ?? "ALMOXARIFADO"
        };
        return headers.map(h=>{
          const v = (obj[h] ?? "").toString();
          return '"' + v.replace(/"/g,'""') + '"';
        }).join(",");
      });

    /* ===== Notas (backup/restore) ===== */
    if(btnExportNotas){
      btnExportNotas.addEventListener("click",()=>{
        const payload = { notas, exportado_em: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ALMOX2026_NOTAS_BACKUP.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 6000);
        toast("‚úÖ Backup de notas gerado");
      });
    }
    if(btnImportNotas && notasInput){
      btnImportNotas.addEventListener("click",()=> notasInput.click());
      notasInput.addEventListener("change",(e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{
            const raw = String(r.result||"").replace(/^\\uFEFF/,"").trim();
            const data = JSON.parse(raw);
            const arr = Array.isArray(data) ? data : (Array.isArray(data.notas) ? data.notas : []);
            if(!Array.isArray(arr) || arr.length===0){ toast("‚ö†Ô∏è Arquivo sem notas"); return; }

            // Dedup simples por chave (quando existir) ou por combina√ß√£o num/s√©rie/emiss√£o/fornecedor
            const keyOf = (n)=>{
              const ch = (n && (n.chave || n.chNFe || n.chaveNFe)) ? String(n.chave || n.chNFe || n.chaveNFe) : "";
              if(ch) return "CH:"+ch.trim();
              return "K:" + [n.numero||"", n.serie||"", n.emissao||"", n.fornecedor||""].join("|").trim();
            };
            const existing = new Map(notas.map(n=>[keyOf(n), n]));
            let add = 0;
            for(const n of arr){
              const k = keyOf(n||{});
              if(!existing.has(k)){
                existing.set(k, n);
                add++;
              }
            }
            notas = Array.from(existing.values());
            save();
            toast(`‚úÖ Notas importadas. Novas: ${add}`);
          }catch(err){
            console.error(err);
            toast("‚ùå Erro ao importar notas");
          }finally{
            notasInput.value = "";
          }
        };
        r.readAsText(file, "utf-8");
      });
    }
      const csv = headers.join(",") + "\n" + rows.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ALMOX2026_PRODUTOS.csv";
      a.click();
      URL.revokeObjectURL(url);
      toast("‚úÖ CSV exportado");
    });
  }

  if(btnReset){
    btnReset.addEventListener("click",()=>{
      if(!confirm("Limpar dados do aparelho?")) return;
      localStorage.removeItem(KEY_PROD);
      localStorage.removeItem(KEY_MOV);
      produtos=[]; movs=[];
      render();
      toast("üßπ Limpo");
      updateLinkedStatus();
    });
  }
})();

/* ---- Vincular/Salvar no mesmo arquivo (File System Access API) ---- */
const FS_DB = "ALMOX2026_FS_DB_V1";
const FS_STORE = "handles";

function fsOpenDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(FS_DB, 1);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(FS_STORE)) db.createObjectStore(FS_STORE);
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function fsGet(key){
  const db = await fsOpenDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(FS_STORE,"readonly");
    const st = tx.objectStore(FS_STORE);
    const rq = st.get(key);
    rq.onsuccess = ()=> resolve(rq.result || null);
    rq.onerror = ()=> reject(rq.error);
  });
}
async function fsSet(key,val){
  const db = await fsOpenDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(FS_STORE,"readwrite");
    tx.objectStore(FS_STORE).put(val, key);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}
async function fsDel(key){
  const db = await fsOpenDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(FS_STORE,"readwrite");
    tx.objectStore(FS_STORE).delete(key);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}

async function updateLinkedStatus(){
  const statusEl = document.getElementById("dbFileStatus");
  const btnSave = document.getElementById("btnSaveToLinked");
  const btnLink = document.getElementById("btnLinkFile");
  if(!statusEl || !btnSave || !btnLink) return;

  const supported = !!window.showOpenFilePicker && !!window.FileSystemFileHandle;
  if(!supported){
    statusEl.textContent = "Seu navegador n√£o suporta salvar no mesmo arquivo. Use: Exportar JSON.";
    btnSave.disabled = true;
    btnLink.disabled = true;
    return;
  }

  try{
    const handle = await fsGet("jsonFile");
    if(handle){
      statusEl.textContent = "Arquivo vinculado. Voc√™ pode salvar no mesmo arquivo.";
      btnSave.disabled = false;
    }else{
      statusEl.textContent = "Nenhum arquivo vinculado.";
      btnSave.disabled = true;
    }
  }catch{
    statusEl.textContent = "N√£o foi poss√≠vel ler o arquivo vinculado.";
    btnSave.disabled = true;
  }
}

async function importarDeHandle(handle){
  const file = await handle.getFile();
  const text = await file.text();
  const data = JSON.parse(text);
  const arr = parseInputJSON(data);
  if(!arr){ toast("‚ö†Ô∏è JSON inv√°lido"); return; }
  produtos = arr.map(normalizeProduto);
  movs = Array.isArray(data.movimentacoes) ? data.movimentacoes : [];
  notas = Array.isArray(data.notas) ? data.notas : notas;

  try{ save(); }catch(err){
    console.error("Erro ao salvar no localStorage:", err);
    toast("‚ùå Falha ao salvar no navegador (localStorage). Verifique permiss√µes/limite de armazenamento.");
    return;
  }
  window.__lastJsonName = file.name || "dados.json";
  toast(`‚úÖ Importado: ${produtos.length}`);
  fecharModal("modalDados");
  render();
}

document.addEventListener("DOMContentLoaded", ()=>{
  const btnLink = document.getElementById("btnLinkFile");
  const btnSave = document.getElementById("btnSaveToLinked");
  if(btnLink){
    btnLink.addEventListener("click", async ()=>{
      try{
        const [handle] = await window.showOpenFilePicker({
          types:[{ description:"JSON", accept:{ "application/json":[".json"] } }],
          multiple:false
        });
        if(!handle) return;
        await fsSet("jsonFile", handle);
        await importarDeHandle(handle);
        updateLinkedStatus();
      }catch(err){
        // usu√°rio cancelou ou n√£o suportado
      }
    });
  }
  if(btnSave){
    btnSave.addEventListener("click", async ()=>{
      try{
        const handle = await fsGet("jsonFile");
        if(!handle){ toast("‚ö†Ô∏è Nenhum arquivo vinculado"); return; }

        // pedir permiss√£o
        const perm = await handle.requestPermission?.({mode:"readwrite"});
        if(perm && perm !== "granted"){ toast("‚ö†Ô∏è Permiss√£o negada"); return; }

        const payload = { produtos, movimentacoes: movs, exportado_em: new Date().toISOString() };
        const writable = await handle.createWritable();
        await writable.write(JSON.stringify(payload,null,2));
        await writable.close();
        toast("üíæ Salvo no arquivo!");
      }catch(err){
        console.error(err);
        toast("‚ùå N√£o foi poss√≠vel salvar. Use Exportar JSON.");
      }
    });
  }
});

/* ========= Fase 2: Movimenta√ß√µes =========

   Modelo de controle:
   - Origem ALMOXARIFADO: baixa estoqueAtual e credita saldo do setor (alocacoes[setor])
   - Origem SETOR: baixa alocacoes[origem] e credita alocacoes[destino]
   As aloca√ß√µes ficam dentro do produto, assim voc√™ consegue ver "o que foi transferido" depois.
*/
function ensureAloc(p){
  if(!p.alocacoes || typeof p.alocacoes !== "object") p.alocacoes = {};
  return p.alocacoes;
}
function prepararMovimentacao(){
  // preenche selects
  const opt = SETORES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  $("mOrig").innerHTML = opt;
  $("mDest").innerHTML = opt;
  $("mOrig").value = "ALMOXARIFADO";
  $("mDest").value = "ADMINISTRA√á√ÉO";
  $("mItem").value = "";
  $("mObs").value = "";
  $("mQtd").value = "1";
  movProdutoIndex = -1;

  // datetime default
  const now = new Date();
  const pad=(n)=>String(n).padStart(2,"0");
  const v = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
  $("mQuando").value = v;

  $("mSug").style.display = "none";
  $("mSug").innerHTML = "";
}

function sugRender(indices, q){
  const box = $("mSug");
  if(!indices.length){ box.style.display="none"; box.innerHTML=""; return; }
  box.style.display="block";
  const esc = (x)=>escapeHtml(x);
  const qrx = q ? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),"ig") : null;
  box.innerHTML = indices.slice(0,12).map(idx=>{
    const p = produtos[idx];
    const name = String(p.nome||"");
    const hi = qrx ? esc(name).replace(qrx, m=>`<strong>${m}</strong>`) : esc(name);
    const alm = Number(p.estoqueAtual)||0;
    return `<div class="sug-item" data-idx="${idx}">
      <div class="sug-title">${hi}</div>
      <div class="sug-sub">${esc(p.categoria||"")} ‚Ä¢ Almox: <b>${alm}</b></div>
    </div>`;
  }).join("");

  box.querySelectorAll(".sug-item").forEach(el=>{
    el.addEventListener("click",()=>{
      const idx = parseInt(el.getAttribute("data-idx"),10);
      selectMovProduto(idx);
    });
  });
}

function selectMovProduto(idx){
  movProdutoIndex = idx;
  $("mItem").value = produtos[idx].nome || "";
  $("mSug").style.display="none";
}

$("mItem")?.addEventListener("input",()=>{
  const q = $("mItem").value.trim().toLowerCase();
  if(!q){ $("mSug").style.display="none"; movProdutoIndex=-1; return; }
  const hits = [];
  for(let i=0;i<produtos.length;i++){
    const p=produtos[i];
    const hay = `${p.nome||""} ${p.codigo1||""} ${p.codigo2||""} ${p.categoria||""}`.toLowerCase();
    if(hay.includes(q)) hits.push(i);
    if(hits.length>=40) break;
  }
  sugRender(hits, q);
});

$("btnGravarMov")?.addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON primeiro"); return; }
  if(movProdutoIndex<0){ toast("‚ö†Ô∏è Selecione um item"); return; }

  const qtd = Math.max(1, parseInt($("mQtd").value,10)||1);
  const origem = $("mOrig").value;
  const destino = $("mDest").value;
  if(origem===destino){ toast("‚ö†Ô∏è Origem = destino"); return; }

  const p = produtos[movProdutoIndex];

  const quandoRaw = $("mQuando").value;
  const dt = quandoRaw ? new Date(quandoRaw) : new Date();
  const quandoISO = dt.toISOString();
  const quando = brDateTime(dt);

  const mov = {
    id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"-"+Math.random().toString(16).slice(2),
    produto_idx: movProdutoIndex,
    produto_nome: p.nome,
    codigo2: p.codigo2,
    categoria: p.categoria,
    qtd, origem, destino,
    obs: $("mObs").value || "",
    quando,
    quandoISO
  };

  const r = applyMovToStock(mov);
  if(!r.ok){ toast("‚ùå "+(r.msg||"Falha ao aplicar")); return; }

  movs.push(mov);

  save();
  render();
  renderMovList();
  toast("‚úÖ Movimenta√ß√£o gravada");

  $("mItem").value = "";
  $("mObs").value = "";
  $("mQtd").value = "1";
  movProdutoIndex = -1;
});

function renderMovList(){
  const box = $("movList");
  if(!box) return;
  box.innerHTML = "";
  const last = movs.slice().reverse().slice(0,12);
  if(!last.length){
    box.innerHTML = `<div class="card" style="margin:0"><div class="muted" style="font-weight:900">Nenhuma movimenta√ß√£o.</div></div>`;
    return;
  }
  last.forEach(m=>{
    const div=document.createElement("div");
    div.className="card";
    div.style.margin="0 0 10px 0";
    div.style.cursor = "pointer";
    div.setAttribute("data-id", m.id || "");
    div.innerHTML = `
      <div class="row">
        <div style="font-weight:950">${escapeHtml(m.produto_nome||"-")}</div>
        <div class="muted" style="font-weight:900">${escapeHtml(m.quando||"")}</div>
      </div>
      <div class="muted" style="margin-top:6px;font-weight:900">
        Qtd: <b style="color:var(--pri)">${m.qtd}</b> ‚Ä¢ ${escapeHtml(m.origem)} ‚Üí ${escapeHtml(m.destino)}
      </div>
      ${m.obs ? `<div class="muted" style="margin-top:6px">${escapeHtml(m.obs)}</div>` : ""}
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" style="padding:8px 10px;font-size:12px" type="button">‚úèÔ∏è Editar / üóëÔ∏è Deletar</button>
      </div>
    `;
    div.addEventListener("click",(ev)=>{
      // se clicar no bot√£o ou no card, abre o editor
      const id = div.getAttribute("data-id");
      if(id) openMovEditById(id);
    });
    box.appendChild(div);
  });
}



/* --- Editar/Deletar movimenta√ß√µes (com revers√£o de estoque) --- */
let movEditId = null;

function resolveProdutoIndexFromMov(m){
  const idx = Number(m.produto_idx);
  if(Number.isInteger(idx) && idx>=0 && idx<produtos.length){
    // valida se bate com c√≥digo/nome para reduzir risco de √≠ndice "andar"
    const p = produtos[idx];
    if((m.codigo2 && p.codigo2===m.codigo2) || (m.produto_nome && p.nome===m.produto_nome)) return idx;
  }
  // fallback: tenta achar pelo c√≥digo2
  if(m.codigo2){
    const j = produtos.findIndex(p=>String(p.codigo2||"")===String(m.codigo2));
    if(j>=0) return j;
  }
  // fallback: tenta achar pelo nome
  if(m.produto_nome){
    const j = produtos.findIndex(p=>String(p.nome||"")===String(m.produto_nome));
    if(j>=0) return j;
  }
  return -1;
}

function revertMov(m){
  const idx = resolveProdutoIndexFromMov(m);
  if(idx<0) return {ok:false, msg:"Produto n√£o encontrado para reverter."};
  const p = produtos[idx];
  const qtd = Math.max(1, Number(m.qtd)||1);
  if(m.origem==="ALMOXARIFADO"){
    p.estoqueAtual = (Number(p.estoqueAtual)||0) + qtd;
    const al = ensureAloc(p);
    al[m.destino] = (Number(al[m.destino])||0) - qtd;
  }else{
    const al = ensureAloc(p);
    al[m.origem] = (Number(al[m.origem])||0) + qtd;
    al[m.destino] = (Number(al[m.destino])||0) - qtd;
  }
  return {ok:true};
}

function applyMovToStock(m){
  const idx = resolveProdutoIndexFromMov(m);
  if(idx<0) return {ok:false, msg:"Produto n√£o encontrado para aplicar."};
  const p = produtos[idx];
  const qtd = Math.max(1, Number(m.qtd)||1);

  if(m.origem===m.destino) return {ok:false, msg:"Origem = destino"};

  if(m.origem==="ALMOXARIFADO"){
    // Permite negativo (invent√°rio posterior)
    p.estoqueAtual = (Number(p.estoqueAtual)||0) - qtd;
    const al = ensureAloc(p);
    al[m.destino] = (Number(al[m.destino])||0) + qtd;
  }else{
    const al = ensureAloc(p);
    // Permite negativo no setor tamb√©m
    al[m.origem] = (Number(al[m.origem])||0) - qtd;
    al[m.destino] = (Number(al[m.destino])||0) + qtd;
  }
  return {ok:true};
}

function movToDatetimeLocal(quando){
  // tenta converter "pt-BR" ou ISO para datetime-local
  if(!quando) return "";
  // se j√° for yyyy-mm-ddThh:mm
  if(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(quando)) return quando.slice(0,16);
  // tenta parse pelo Date
  const d = new Date(quando);
  if(!isNaN(d.getTime())){
    const pad=(n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  // tenta parse simples pt-BR "dd/mm/aaaa, hh:mm:ss" ou "dd/mm/aaaa hh:mm"
  const m = String(quando).match(/(\d{2})\/(\d{2})\/(\d{4}).*?(\d{2}):(\d{2})/);
  if(m){
    const [_,dd,mm,yyyy,hh,mi]=m;
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  return "";
}

function formatWhenFromInput(v){
  if(!v) return brDateTime(new Date());
  return brDateTime(new Date(v));
}

function openMovEditById(id){
  const mov = movs.find(x=>x.id===id);
  if(!mov){ toast("‚ö†Ô∏è Movimenta√ß√£o n√£o encontrada"); return; }

  // preenche selects (mesmo conjunto)
  const opt = SETORES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  $("meOrig").innerHTML = opt;
  $("meDest").innerHTML = opt;

  movEditId = id;
  $("meItem").value = mov.produto_nome || "";
  $("meQtd").value = Number(mov.qtd)||1;
  $("meOrig").value = mov.origem || "ALMOXARIFADO";
  $("meDest").value = mov.destino || "ADMINISTRA√á√ÉO";
  $("meObs").value = mov.obs || "";
  $("meQuando").value = movToDatetimeLocal(mov.quando);

  const idx = resolveProdutoIndexFromMov(mov);
  const p = idx>=0 ? produtos[idx] : null;
  const alm = p ? (Number(p.estoqueAtual)||0) : 0;
  $("meInfo").textContent = p ? `Estoque atual no ALMOX: ${alm} ‚Ä¢ Classifica√ß√£o: ${p.categoria||""}` : "Produto n√£o localizado no estoque atual.";
  abrirModal("modalMovEdit");
}

function commitMovEdit(action){
  const movIdx = movs.findIndex(x=>x.id===movEditId);
  if(movIdx<0){ toast("‚ö†Ô∏è Movimenta√ß√£o n√£o encontrada"); return; }
  const old = movs[movIdx];

  if(action==="delete"){
    if(!confirm("Deletar esta movimenta√ß√£o? O estoque ser√° revertido.")) return;
    const r = revertMov(old);
    if(!r.ok){ toast("‚ùå "+(r.msg||"Falha ao reverter")); return; }
    movs.splice(movIdx,1);
    save(); render(); renderMovList();
    fecharModal("modalMovEdit");
    toast("üóëÔ∏è Movimenta√ß√£o deletada (estoque revertido)");
    return;
  }

  // salvar
  const updated = {...old};
  updated.qtd = Math.max(1, parseInt($("meQtd").value,10)||1);
  updated.origem = $("meOrig").value;
  updated.destino = $("meDest").value;
  updated.obs = $("meObs").value || "";
  const dt2 = $("meQuando").value ? new Date($("meQuando").value) : new Date();
  updated.quandoISO = dt2.toISOString();
  updated.quando = brDateTime(dt2);

  // 1) reverte antigo
  const r1 = revertMov(old);
  if(!r1.ok){ toast("‚ùå "+(r1.msg||"Falha ao reverter (salvar)")); return; }

  // 2) tenta aplicar novo
  const r2 = applyMovToStock(updated);
  if(!r2.ok){
    // tenta restaurar antigo para n√£o quebrar
    applyMovToStock(old);
    toast("‚ùå "+(r2.msg||"Falha ao aplicar altera√ß√µes"));
    return;
  }

  movs[movIdx] = updated;
  save(); render(); renderMovList();
  fecharModal("modalMovEdit");
  toast("‚úÖ Movimenta√ß√£o atualizada");
}


$("btnExportMov")?.addEventListener("click",()=>{
  const blob = new Blob([JSON.stringify(movs,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="ALMOX2026_movimentacoes.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("üì§ Movimenta√ß√µes exportadas");
});


$("btnMovEditSalvar")?.addEventListener("click",()=>commitMovEdit("save"));
$("btnMovEditDel")?.addEventListener("click",()=>commitMovEdit("delete"));

/* ---- init ---- */
document.addEventListener("DOMContentLoaded", async ()=>{
  load();

  // Auto-carregamento (quando servido via GitHub Pages / http)
  // Autoload desativado: use Dados > Importar JSON


  render();
  $("q").addEventListener("input",render);
  updateLinkedStatus();
});


</script>
</body>
</html>
