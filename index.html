

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ALMOX2026 Online</title>
<script>
  // Carregar produtos do backend automaticamente
  (async function() {
    try {
      const response = await fetch('/api/almox/produtos');
      if (response.ok) {
        const produtos = await response.json();
        const KEY_PROD = 'ALMOX2026_PROD_BASE_V1';
        localStorage.setItem(KEY_PROD, JSON.stringify(produtos));
        console.log('[ALMOX] ' + produtos.length + ' produtos carregados do backend');
      }
    } catch (e) {
      console.warn('[ALMOX] Erro ao carregar produtos:', e);
    }
  })();
</script>
<style>
  :root{
    --bg0:#0b0d18; --bg1:#11142a; --card:#171b34; --card2:#1c2140;
    --txt:#e9ecff; --muted:#aab0d8; --pri:#00d4ff; --sec:#7c3aed;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    color:var(--txt);
    background:radial-gradient(1200px 700px at 20% 0%, #15204a 0%, var(--bg0) 60%);
    overflow-x:hidden;
  }

  /* ===== Floating Nav (n√£o fixa conte√∫do) ===== */
  .fnav{
    position:fixed; left:50%; transform:translateX(-50%);
    top:10px; z-index:9999;
    display:flex; gap:12px; align-items:center; justify-content:center;
    padding:14px 16px 18px;
    background:rgba(23,27,52,.92);
    border:1px solid var(--line);
    border-radius:26px;
    /* blur removido (Android Chrome evita artefatos) */
    backdrop-filter:none; -webkit-backdrop-filter:none;
box-shadow:0 14px 40px rgba(0,0,0,.45);
    max-width:calc(100vw - 16px);
  }
  .fbtn{
    width:58px;height:58px;border-radius:18px;border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    display:flex;align-items:center;justify-content:center;
    font-size:28px; cursor:pointer; user-select:none;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
    touch-action:manipulation;
  }
  .fbtn:active{transform:scale(.96)}
  .fbtn:hover{border-color:rgba(0,212,255,.35)}
  .fhandle{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:8px; width:84px; height:7px; border-radius:999px;
    background:rgba(255,255,255,.35);
  }

  main{padding:108px 12px 18px}
  .topbar{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin:0 2px 12px;}
  .title{font-weight:950; font-size:24px; letter-spacing:.3px}
  .pill{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; font-size:12px; color:var(--muted)}
  .pill span{background:rgba(255,255,255,.06); border:1px solid var(--line); padding:6px 10px; border-radius:999px}
  .muted{color:var(--muted)}
  .search{
    margin:10px 2px 14px;
    background:rgba(255,255,255,.06); border:1px solid var(--line);
    border-radius:16px; padding:12px;
    display:flex; gap:10px; align-items:center;
  }
  .search input{
    width:100%; border:none; outline:none; background:transparent; color:var(--txt);
    font-size:16px;
  }

  .grid{display:grid; gap:12px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    box-shadow:0 8px 24px rgba(0,0,0,.28);
  }
  .row{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
  .code{color:var(--pri); font-weight:900}
  .cat{font-size:12px; background:rgba(124,58,237,.22); border:1px solid rgba(124,58,237,.35); padding:6px 10px; border-radius:999px}
  .name{margin-top:8px; font-weight:850; line-height:1.25}
  .meta{margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .box{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.09); border-radius:14px; padding:10px}
  .lbl{font-size:11px;color:var(--muted);font-weight:800;letter-spacing:.4px}
  .val{margin-top:4px;font-size:16px;font-weight:950}
  .status{
    margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;
    border-top:1px solid rgba(255,255,255,.08); padding-top:12px;
  }
  .badge{font-weight:950; font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid transparent}
  .ok{background:rgba(16,185,129,.18); color:var(--ok); border-color:rgba(16,185,129,.28)}
  .low{background:rgba(245,158,11,.18); color:var(--warn); border-color:rgba(245,158,11,.28)}
  .zero{background:rgba(239,68,68,.18); color:var(--bad); border-color:rgba(239,68,68,.28)}

  /* ===== Modal (sheet) ===== */
  .modal{
    position:fixed; inset:0; z-index:10000;
    background:rgba(0,0,0,.62);
    display:none; align-items:flex-end; justify-content:center;
    padding:12px;
  }
  .modal.active{display:flex}
  .sheet{
    width:100%; max-width:820px; max-height:88vh; overflow:auto;
    background:rgba(23,27,52,.98);
    border:1px solid var(--line);
    border-radius:20px 20px 0 0;
    box-shadow:0 24px 70px rgba(0,0,0,.6);
  }
  .mhead{
    position:sticky; top:0; z-index:2;
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#041018;
    padding:14px 14px 12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:950;
    border-radius:18px 18px 0 0;
  }
  .mhead .x{
    width:40px;height:40px;border-radius:999px;border:none;
    background:rgba(255,255,255,.25); color:#fff; font-size:20px; cursor:pointer;
  }
  .mbar{width:80px;height:7px;border-radius:999px;background:rgba(255,255,255,.55); margin:10px auto 0}
  .mbody{padding:14px}
  .group{margin-bottom:12px}
  label{display:block;font-size:12px;color:rgba(255,255,255,.85);font-weight:900;letter-spacing:.3px;margin-bottom:6px}
  input,select,textarea{
    width:100%; padding:12px 12px; border-radius:14px;
    border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
    color:var(--txt); outline:none; font-size:16px;
  }
  textarea{min-height:84px; resize:vertical}
  .twocol{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:12px 14px 16px; border-top:1px solid rgba(255,255,255,.10)}
  .btn{
    border:none; border-radius:16px; padding:14px 12px;
    font-weight:950; cursor:pointer; font-size:15px;
    touch-action:manipulation;
  }
  .primary{background:linear-gradient(135deg,var(--pri),#00a8cc); color:#041018}
  .secondary{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:var(--txt)}
  .danger{background:var(--bad); color:#fff}

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:11000;
    background:rgba(23,27,52,.96); border:1px solid var(--line);
    padding:10px 14px; border-radius:999px; font-weight:900;
    display:none;
  }
  .toast.show{display:block}

  @media (max-width:360px){
    .fbtn{width:54px;height:54px;border-radius:16px}
    .meta{grid-template-columns:1fr}
  }

  /* ===== Sugest√µes (movimenta√ß√µes) ===== */
  .sug-item{
    padding:12px 12px;
    background:rgba(255,255,255,.04);
    border-bottom:1px solid rgba(255,255,255,.10);
    cursor:pointer;
  }
  .sug-item:last-child{border-bottom:none}
  .sug-item:hover{background:rgba(0,212,255,.10)}
  .sug-title{font-weight:950}
  .sug-sub{margin-top:4px;font-size:12px;color:var(--muted);font-weight:800}

  
  /* Ajuste: bot√µes do modal Relat√≥rios centralizados */
  #modalRel .twocol{width:100%}
  #modalRel .twocol .btn{width:100%}

  /* ===== Relat√≥rios (tabelas) ===== */
  .rt-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px}
  .rt-title{font-weight:950;font-size:16px;margin-bottom:6px}
  .rt-sub{color:var(--muted);font-weight:800;font-size:12px;margin-bottom:10px}
  .rt-table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid rgba(255,255,255,.12)}
  .rt-table thead th{
    text-align:left; padding:10px 10px;
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#041018; font-weight:950; font-size:12px;
  }
  .rt-table tbody td{padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.10); font-size:12px; vertical-align:top}
  .rt-table tbody tr:nth-child(even){background:rgba(255,255,255,.04)}
  .rt-table tbody tr:last-child td{border-bottom:none}
  .rt-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:950;font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}

  /* ===== Setores ===== */
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:380px){ .grid2{grid-template-columns:1fr} }
  .set-card{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    transition:transform .15s ease, border-color .15s ease, background .15s ease;
  }
  .set-card:active{transform:scale(.98)}
  .set-card:hover{border-color:rgba(0,212,255,.45); background:rgba(0,212,255,.08)}
  .set-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
  .set-name{font-weight:950; font-size:13px; letter-spacing:.2px}
  .set-chip{padding:4px 8px;border-radius:999px;font-weight:950;font-size:11px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
  .set-sub{margin-top:8px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35}
  .set-num{font-weight:950;color:var(--pri)}

  /* Anti-banding: aumenta opacidade dos cards no Android Chrome */
  .pCard,.prod-card,.cardItem,.itemCard,.produto-card{
    background:rgba(26,28,52,.92) !important;
  }

.actions .btn{width:100%}

@media (max-width:360px){ .actions{grid-template-columns:1fr} }
</style>
<meta property="og:type" content="website">
		<meta property="og:url" content="https://almoxapp-6cszixvm.manus.space/almox-offline.html">
		<meta property="og:title" content="ALMOX2026 Online">
		<meta property="og:description" content="Sistema de gerenciamento de almoxarifado multiusu√°rio com sincroniza√ß√£o em tempo real e backend persistente.">
		<meta property="og:image" content="https://files.manuscdn.com/webdev_screenshots/2026/02/02/T6NvK35wuB2wEgdQXNmvRq.png?x-oss-process=image/resize,w_1200/crop,h_630,x_0,y_0">
		<meta property="og:image:width" content="1200">
		<meta property="og:image:height" content="630">
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:title" content="ALMOX2026 Online">
		<meta name="twitter:description" content="Sistema de gerenciamento de almoxarifado multiusu√°rio com sincroniza√ß√£o em tempo real e backend persistente.">
		<meta name="twitter:image" content="https://files.manuscdn.com/webdev_screenshots/2026/02/02/T6NvK35wuB2wEgdQXNmvRq.png?x-oss-process=image/resize,w_1200/crop,h_630,x_0,y_0">
		<meta name="twitter:image:width" content="1200">
		<meta name="twitter:image:height" content="630"><link rel="canonical" href="https://almoxapp-6cszixvm.manus.space/almox-offline.html" /></head>
<body>

<!-- Floating nav -->
<div class="fnav" id="fnav">
  <div class="fbtn" id="btnEstoque" title="Estoque">üì¶</div>
  <div class="fbtn" id="btnMov" title="Movimenta√ß√µes">üîÅ</div>
  <div class="fbtn" id="btnRel" title="Relat√≥rios">üìä</div>
  <div class="fbtn" id="btnSet" title="Setores">üèõÔ∏è</div>
  <div class="fbtn" id="btnDados" title="Dados">üíæ</div>
  <div class="fhandle" id="fhandle"></div>
</div>

<main>
  <div class="topbar">
    <div>
      <div class="title">ALMOX2026</div>
      <div class="muted" style="margin-top:4px;font-weight:700">Base Offline ‚Ä¢ Importar JSON em Dados</div>
    </div>
    <div class="pill">
      <span>Total: <b id="statTotal">0</b></span>
      <span style="color:var(--ok)">OK: <b id="statOk">0</b></span>
      <span style="color:var(--warn)">Baixo: <b id="statLow">0</b></span>
      <span style="color:var(--bad)">Zerado: <b id="statZero">0</b></span>
    </div>
  </div>

  <div class="search">
    <span style="font-size:18px">üîé</span>
    <input id="q" type="search" placeholder="Buscar por nome, c√≥digo, classifica√ß√£o..." />
  </div>

  <div class="grid" id="grid"></div>
</main>

<!-- MODAL: DADOS -->
<div class="modal" id="modalDados" aria-hidden="true">
  <div class="sheet">
    <div class="mhead">
      <div>üíæ Dados</div>
      <button class="x" data-close="modalDados">&times;</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group">
        <button class="btn primary" id="btnImport">üì• Importar JSON</button>
        <input type="file" id="fileInput" accept=".json" style="display:none">
      </div>
      <div class="group">
        <button class="btn secondary" id="btnExport">üì§ Exportar JSON (produtos)</button>
      </div>
      <div class="group">
        <button class="btn secondary" id="btnExportExcel">üìä Exportar Excel</button>
      </div>
      <div class="group">
        <button class="btn secondary" id="btnExportPDF">üìÑ Exportar PDF</button>
      </div>
      <div class="group muted" style="font-size:13px;line-height:1.4">
        <b>Android offline:</b> a primeira vez precisa importar. Depois fica salvo no aparelho (localStorage).
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" data-close="modalDados">Fechar</button>
      <button class="btn secondary" id="btnReset">üßπ Limpar dados do aparelho</button>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR PRODUTO -->
<div class="modal" id="modalProduto" aria-hidden="true">
  <div class="sheet">
    <div class="mhead">
      <div>‚úèÔ∏è Editar produto</div>
      <button class="x" data-close="modalProduto">&times;</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group">
        <label>C√≥digo 1</label>
        <input id="pCodigo1" />
      </div>
      <div class="group">
        <label>C√≥digo 2</label>
        <input id="pCodigo2" />
      </div>
      <div class="group">
        <label>Nome</label>
        <input id="pNome" />
      </div>
      <div class="group">
        <label>Classifica√ß√£o (do JSON)</label>
        <select id="pCategoria"></select>
      </div>
      <div class="twocol">
        <div class="group">
          <label>Estoque atual (Almoxarifado)</label>
          <input id="pAtual" type="number" min="0" />
        </div>
        <div class="group">
          <label>Estoque m√≠nimo</label>
          <input id="pMin" type="number" min="0" />
        </div>
      </div>
      <div class="group">
        <label>Pre√ßo</label>
        <input id="pPreco" type="number" step="0.01" min="0" />
      </div>
      <div class="group">
        <label>Descri√ß√£o</label>
        <textarea id="pDesc" placeholder="Opcional"></textarea>
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" data-close="modalProduto">Cancelar</button>
      <button class="btn danger" id="btnDelProd">üóëÔ∏è Deletar</button>
      <button class="btn primary" id="btnSaveProd">‚úÖ Salvar</button>
    </div>
  </div>
</div>


<!-- MODAL: MOVIMENTA√á√ïES (1 tela) -->
<div class="modal" id="modalMov" aria-hidden="true">
  <div class="sheet">
    <div class="mhead">
      <div>üîÅ Movimenta√ß√µes</div>
      <button class="x" data-close="modalMov">&times;</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group">
        <label>Item (digite para buscar)</label>
        <input id="mItem" placeholder="Ex.: sulfite, martelo..." autocomplete="off" />
        <div id="mSug" style="display:none; margin-top:8px; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden;"></div>
      </div>

      <div class="twocol">
        <div class="group">
          <label>Quantidade</label>
          <input id="mQtd" type="number" min="1" value="1" />
        </div>
        <div class="group">
          <label>Data/Hora</label>
          <input id="mQuando" type="datetime-local" />
        </div>
      </div>

      <div class="group">
        <label>Setor origem</label>
        <select id="mOrig"></select>
      </div>
      <div class="group">
        <label>Setor destinat√°rio</label>
        <select id="mDest"></select>
      </div>

      <div class="group">
        <label>Observa√ß√£o</label>
        <input id="mObs" placeholder="Opcional" />
      </div>

      <div class="group">
        <button class="btn primary" id="btnGravarMov">‚úÖ Gravar movimenta√ß√£o</button>
      </div>

      <div class="group">
        <div class="muted" style="font-weight:900;margin-bottom:8px">√öltimas movimenta√ß√µes</div>
        <div id="movList"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn secondary" data-close="modalMov">Fechar</button>
      <button class="btn secondary" id="btnExportMov">üì§ Exportar Movimenta√ß√µes</button>
    </div>
  </div>
</div>


<!-- MODAL: INCLUIR PRODUTO -->
<div class="modal" id="modalAdicionarProd" aria-hidden="true">
  <div class="sheet">
    <div class="mhead">
      <div>‚ûï Incluir Novo Produto</div>
      <button class="x" data-close="modalAdicionarProd">&times;</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group">
        <label>C√≥digo (7 d√≠gitos) *</label>
        <input type="text" id="novoProdCodigo1" placeholder="Ex: 8011001" maxlength="50" required>
      </div>
      <div class="group">
        <label>C√≥digo (5 d√≠gitos)</label>
        <input type="text" id="novoProdCodigo2" placeholder="Ex: 1102" maxlength="50">
      </div>
      <div class="group">
        <label>Nome do Produto *</label>
        <input type="text" id="novoProdNome" placeholder="Ex: COCO RALADO PACOTE 100G" maxlength="255" required>
      </div>
      <div class="group">
        <label>Descri√ß√£o</label>
        <input type="text" id="novoProdDescricao" placeholder="Descri√ß√£o adicional" maxlength="500">
      </div>
      <div class="group">
        <label>Categoria</label>
        <input type="text" id="novoProdCategoria" placeholder="Ex: ALIMENTOS" maxlength="100">
      </div>
      <div class="group">
        <label>NCM</label>
        <input type="text" id="novoProdNCM" placeholder="Ex: 19059090" maxlength="20">
      </div>
      <div class="group">
        <label>Pre√ßo (R$)</label>
        <input type="number" id="novoProdPreco" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="group">
        <label>Estoque M√≠nimo</label>
        <input type="number" id="novoProdEstoqueMin" placeholder="0" value="0" min="0">
      </div>
      <div class="group">
        <label>Estoque Inicial</label>
        <input type="number" id="novoProdEstoqueInicial" placeholder="0" value="0" min="0">
      </div>
      <div class="group">
        <label>Setor</label>
        <input type="text" id="novoProdSetor" placeholder="ALMOXARIFADO" value="ALMOXARIFADO" maxlength="100">
      </div>
      <div class="group">
        <label>
          <input type="checkbox" id="novoProdAtivo" checked>
          Ativo
        </label>
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" data-close="modalAdicionarProd">Cancelar</button>
      <button class="btn primary" id="btnSalvarNovoProd">‚úÖ Salvar Produto</button>
    </div>
  </div>
</div>

<!-- MODAL: RELAT√ìRIOS -->
<div class="modal" id="modalRel" aria-hidden="true">
  <div class="sheet">
    <div class="mhead">
      <div>üìä Relat√≥rios</div>
      <button class="x" data-close="modalRel">&times;</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group">
        <label>Tipo de relat√≥rio</label>
        <select id="rTipo">
          <option value="inventario">üì¶ Invent√°rio Geral</option>
          <option value="baixo">‚ö†Ô∏è Produtos abaixo do m√≠nimo</option>
          <option value="classificacao">üè∑Ô∏è Produtos por Classifica√ß√£o</option>
          <option value="movsetor">üîÅ Movimenta√ß√µes por Setor (por per√≠odo)</option>
        </select>
      </div>

      <div id="rFiltros" class="group"></div>

      <div class="twocol">
        <button class="btn primary" id="btnGerarRel">‚úÖ Gerar</button>
        <button class="btn secondary" id="btnPDFRel">üìÑ Salvar em PDF</button>
      </div>

      <div id="rOut" style="margin-top:12px"></div>
    </div>
    <div class="actions">
      <button class="btn secondary" data-close="modalRel">Fechar</button>
      <button class="btn secondary" id="btnLimparRel">üßπ Limpar</button>
    </div>
  </div>
</div>


<!-- MODAL: GEST√ÉO DE SETORES -->
<div class="modal" id="modalSet" aria-hidden="true">
  <div class="sheet">
    <div class="mhead">
      <div>üèõÔ∏è Gest√£o de Setores</div>
      <button class="x" data-close="modalSet">&times;</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="group">
        <label>Buscar setor</label>
        <input id="sBusca" placeholder="Digite: admin, sa√∫de..." />
      </div>

      <div id="setGrid" class="grid2" style="margin-top:10px"></div>
      <div class="muted" style="margin-top:10px;font-weight:800">
        Toque em um setor para ver as movimenta√ß√µes e gerar PDF.
      </div>
    </div>
    <div class="actions">
      <button class="btn secondary" data-close="modalSet">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL: DETALHE DO SETOR -->
<div class="modal" id="modalSetDet" aria-hidden="true">
  <div class="sheet">
    <div class="mhead">
      <div id="sdTitle">üèõÔ∏è Setor</div>
      <button class="x" data-close="modalSetDet">&times;</button>
    </div>
    <div class="mbar"></div>
    <div class="mbody">
      <div class="twocol">
        <div class="group" style="margin:0">
          <label>De</label>
          <input id="sdDe" type="date" />
        </div>
        <div class="group" style="margin:0">
          <label>At√©</label>
          <input id="sdAte" type="date" />
        </div>
      </div>

      <div class="group">
        <label>Dire√ß√£o</label>
        <select id="sdDir">
          <option value="ambos">Entradas + Sa√≠das</option>
          <option value="entradas">Somente Entradas</option>
          <option value="saidas">Somente Sa√≠das</option>
        </select>
      </div>

      <div class="twocol">
        <button class="btn primary" id="btnGerarSet">‚úÖ Gerar</button>
        <button class="btn secondary" id="btnPDFSet">üìÑ Salvar em PDF</button>
      </div>

      <div id="sdResumo" class="rt-card" style="margin-top:12px"></div>
      <div id="sdOut" style="margin-top:12px"></div>
    </div>
    <div class="actions">
      <button class="btn secondary" data-close="modalSetDet">Fechar</button>
      <button class="btn secondary" id="btnVoltarSet">‚Ü©Ô∏è Setores</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* Captura erros para facilitar teste no celular */
window.addEventListener("error", (e)=>{
  try{
    toast("‚ùå Erro: " + (e.message || "desconhecido"));
  }catch(_){}
});
window.addEventListener("unhandledrejection", (e)=>{
  try{
    toast("‚ùå Erro: " + (e.reason && e.reason.message ? e.reason.message : "promise"));
  }catch(_){}
});


/* ========= ALMOX2026 ‚Ä¢ BASE OFFLINE (Fase 1) =========
   Objetivo: modais SEMPRE abrem + importar JSON + listar + editar + salvar.
*/
"use strict";

const KEY_PROD = "ALMOX2026_PROD_BASE_V1";
const KEY_MOV  = "ALMOX2026_MOV_BASE_V1";

const SETORES = [
  "ALMOXARIFADO",
  "ADMINISTRA√á√ÉO","AGRICULTURA","DESENV SOCIAL","BOMBEIROS","COMPRAS","CONSELHO TUTELAR","CRAS","CREAS","CRIAN√áA FELIZ",
  "CULTURA","DESENV REGIONAL","EDUCA√á√ÉO","ESPA√áO AMIGO","ESPORTE","FINAN√áAS","GABINETE","GEST√ÉO PESSOAL","LAR DO ANCI√ÉO",
  "LICITA√á√ÉO","LIMPEZA P√öBLICA","MEIO AMBIENTE","MERENDAS","OBRAS E INFRA","POUPATEMPO","PROCURADORIA","RH","SA√öDE",
  "TERCEIRO SETOR","TR√ÇNSITO","TRANSPORTE","TRIBUTA√á√ÉO","TURISMO","VIGIL√ÇNCIA SANIT√ÅRIA"
];

let movs = [];
let movProdutoIndex = -1; // √≠ndice do produto selecionado para movimenta√ß√£o


let produtos = [];

async function bootLoad(){
  const adapter = getAdapter();
  const data = await adapter.loadAll();
  if(Array.isArray(data.produtos) && data.produtos.length){
    produtos = data.produtos.map(normalizeProduto);
  }
  if(Array.isArray(data.movs) && data.movs.length){
    movs = data.movs;
  }
}
async function bootSave(){
  const adapter = getAdapter();
  await adapter.saveAll({produtos, movs});
}

let editIndex = -1;

const $ = (id)=>document.getElementById(id);

/* =========================
   ALMOX2026 ‚Ä¢ Configura√ß√£o
   =========================
   Offline (padr√£o): usa localStorage.
   Manus/Deploy (online): mude DATA_MODE para "online" e implemente ApiAdapter.
*/
const CONFIG = {
  APP_NAME: "ALMOX2026",
  DATA_MODE: "offline", // "offline" | "online"
  ONLINE: {
    // Exemplo: Supabase/Manus
    // baseUrl: "https://SEU-ENDPOINT",
    // apiKey: "SUA-CHAVE",
  }
};

/* Adapter (OFFLINE/ONLINE) ‚Äî mant√©m o resto do app igual */
const StorageAdapter = {
  async loadAll(){
    // retorna { produtos:[], movs:[] }
    const rawP = localStorage.getItem("almox_produtos");
    const rawM = localStorage.getItem("almox_movs");
    return {
      produtos: rawP ? JSON.parse(rawP) : [],
      movs: rawM ? JSON.parse(rawM) : []
    };
  },
  async saveAll({produtos, movs}){
    localStorage.setItem("almox_produtos", JSON.stringify(produtos || []));
    localStorage.setItem("almox_movs", JSON.stringify(movs || []));
  }
};

/* Placeholder: quando for para o Manus, substitua estas fun√ß√µes por chamadas ao seu backend */
const ApiAdapter = {
  async loadAll(){
    throw new Error("Online n√£o configurado. Ajuste CONFIG.DATA_MODE e implemente ApiAdapter.");
  },
  async saveAll(){
    throw new Error("Online n√£o configurado. Ajuste CONFIG.DATA_MODE e implemente ApiAdapter.");
  }
};

function getAdapter(){
  return (CONFIG.DATA_MODE === "online") ? ApiAdapter : StorageAdapter;
}

async function persistAll(){
  try{ await bootSave(); }catch(e){ /* ignore */ }
}

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}

/* ---- Modais (100% independentes) ---- */
function abrirModal(id){
  const m=$(id); if(!m) return;
  m.classList.add("active");
  m.setAttribute("aria-hidden","false");
}
function fecharModal(id){
  const m=$(id); if(!m) return;
  m.classList.remove("active");
  m.setAttribute("aria-hidden","true");
}

// Fecha por bot√£o, ou clicando fora do sheet
document.addEventListener("click",(e)=>{
  const close = e.target.closest?.("[data-close]");
  if(close){ fecharModal(close.getAttribute("data-close")); }
  if(e.target.classList?.contains("modal")){ e.target.classList.remove("active"); }
});

/* ---- Nav ---- */
$("btnDados").addEventListener("click",()=>abrirModal("modalDados"));

$("btnMov").addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  prepararMovimentacao();
  renderMovList();
  abrirModal("modalMov");
});

/* ---- Relat√≥rios ---- */
$("btnRel").addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderFiltrosRel();
  $("rOut").innerHTML = "";
  abrirModal("modalRel");
});

$("rTipo").addEventListener("change",renderFiltrosRel);

function renderFiltrosRel(){
  const tipo = $("rTipo").value;
  const box = $("rFiltros");
  if(tipo==="movsetor"){
    const opts = SETORES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    box.innerHTML = `
      <div class="twocol">
        <div class="group" style="margin:0">
          <label>Setor</label>
          <select id="rSetor">${opts}</select>
        </div>
        <div class="group" style="margin:0">
          <label>Dire√ß√£o</label>
          <select id="rDir">
            <option value="ambos">Entradas + Sa√≠das</option>
            <option value="entradas">Somente Entradas</option>
            <option value="saidas">Somente Sa√≠das</option>
          </select>
        </div>
      </div>
      <div class="twocol">
        <div class="group" style="margin:0">
          <label>De</label>
          <input id="rDe" type="date" />
        </div>
        <div class="group" style="margin:0">
          <label>At√©</label>
          <input id="rAte" type="date" />
        </div>
      </div>
      <div class="muted" style="font-size:12px;font-weight:800;margin-top:6px">Dica: se n√£o definir datas, mostra tudo.</div>
    `;
    // defaults: hoje
    const d = new Date(); const pad=n=>String(n).padStart(2,"0");
    const hoje = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    setTimeout(()=>{
      const rSetor = document.getElementById("rSetor");
      if(rSetor) rSetor.value = "ADMINISTRA√á√ÉO";
      const rDe = document.getElementById("rDe");
      const rAte = document.getElementById("rAte");
      if(rDe) rDe.value = hoje;
      if(rAte) rAte.value = hoje;
    },0);
  } else if(tipo==="classificacao"){
    const cats = categoriasUnicas();
    const opts = ['<option value="">(Todas)</option>'].concat(cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`));
    box.innerHTML = `
      <div class="group" style="margin:0">
        <label>Filtrar classifica√ß√£o</label>
        <select id="rCat">${opts.join("")}</select>
      </div>
    `;
  } else {
    box.innerHTML = `<div class="muted" style="font-size:12px;font-weight:800">Sem filtros adicionais para este relat√≥rio.</div>`;
  }
}

function ptbrToDate(s){
  // s: "dd/mm/aaaa, hh:mm:ss" or "dd/mm/aaaa hh:mm"
  if(!s) return null;
  const m = String(s).match(/^(\d{2})\/(\d{2})\/(\d{4})/);
  if(!m) return null;
  const dd=+m[1], mm=+m[2]-1, yy=+m[3];
  // try time
  const t = String(s).match(/(\d{2}):(\d{2})(?::(\d{2}))?/);
  const hh=t?+t[1]:0, mi=t?+t[2]:0, ss=t&&t[3]?+t[3]:0;
  return new Date(yy,mm,dd,hh,mi,ss);
}

function buildReportCard(title, subtitle, tableHTML){
  return `
    <div class="rt-card">
      <div class="rt-title">${escapeHtml(title)}</div>
      <div class="rt-sub">${escapeHtml(subtitle)}</div>
      ${tableHTML}
    </div>
  `;
}

function tableFromRows(cols, rows){
  const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr></thead>`;
  const tbody = rows.length
    ? `<tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${r[c] ?? ""}</td>`).join("")}</tr>`).join("")}</tbody>`
    : `<tbody><tr><td colspan="${cols.length}" class="muted" style="padding:12px">Nenhum registro.</td></tr></tbody>`;
  return `<table class="rt-table">${thead}${tbody}</table>`;
}

/* ---- Template de PDF (modelo moderno) ---- */
let lastPDFHtml = "";
let lastPDFName = "relatorio";

function buildPrintableDoc({title, subtitle, bodyHTML}){
  const now = new Date().toLocaleString("pt-BR");
  // IMPORTANTE (Android/Chrome): N√ÉO usar tags <script> dentro desta string,
  // pois isso pode encerrar o <script> principal do app e imprimir c√≥digo na tela.
  // Para disparar o PDF, usamos onload no <body>.
  return `<!doctype html><html lang="pt-BR"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHtml(title)}</title>
<style>
:root{--pri:#00d4ff;--sec:#7c3aed;--line:#e7e9f4;--mut:#5b6288;}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; color:#111; background:#fff}
.wrap{padding:14mm 12mm 18mm}
.hdr{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;border-bottom:3px solid #0b0d18;padding-bottom:10px;margin-bottom:12px}
.brand{display:flex;flex-direction:column;gap:4px}
.brand .app{font-weight:950;font-size:18px;letter-spacing:.2px}
.title{font-weight:950;font-size:20px;margin:0}
.subtitle{font-weight:800;font-size:12px;color:var(--mut);margin-top:6px}
.meta{font-size:11px;color:var(--mut);font-weight:800;text-align:right}
table{width:100%;border-collapse:collapse;font-size:11px}
thead th{padding:10px 8px;text-align:left;background:linear-gradient(135deg,var(--pri),var(--sec));color:#061018;font-weight:950}
tbody td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
tbody tr:nth-child(even){background:#f6f7fb}
.card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px}
.footer{position:fixed;left:0;right:0;bottom:0;padding:6mm 12mm;font-size:11px;color:var(--mut);display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--line);background:#fff}
.pnum::after{content:"P√°gina " counter(page) " de " counter(pages);}
@page{margin:14mm 12mm 18mm}
</style></head>
<body onload="setTimeout(function(){window.print();},250)">
<div class="wrap">
  <div class="hdr">
    <div class="brand">
      <div class="app">ALMOX2026</div>
      <div class="title">${escapeHtml(title)}</div>
      <div class="subtitle">${escapeHtml(subtitle||"")}</div>
    </div>
    <div class="meta">
      <div><b>Gerado:</b> ${escapeHtml(now)}</div>
      <div>Modo offline</div>
    </div>
  </div>
  ${bodyHTML}
</div>
<div class="footer">
  <div>ALMOX2026 ‚Ä¢ Relat√≥rio</div>
  <div class="pnum"></div>
</div>
</body></html>`;
}

function openPrintWindow(html, name){
  const w = window.open("", "_blank");
  if(!w){ toast("‚ö†Ô∏è Pop-up bloqueado"); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* ---- Gerar relat√≥rios ---- */
$("btnGerarRel").addEventListener("click",()=>{
  const tipo = $("rTipo").value;
  const out = $("rOut");

  if(tipo==="inventario"){
    // Similar a softwares de varejo: lista com c√≥digo, produto, classifica√ß√£o, estoque, m√≠nimo, status, pre√ßo
    const rows = produtos.map(p=>{
      const st = statusProduto(p);
      return {
        "C√≥digo": escapeHtml(p.codigo2||p.codigo1||""),
        "Produto": escapeHtml(p.nome||""),
        "Classifica√ß√£o": escapeHtml(p.categoria||""),
        "Atual": String(p.estoqueAtual||0),
        "M√≠n": String(p.estoqueMin||0),
        "Status": `<span class="rt-badge">${escapeHtml(st.txt)}</span>`,
        "Pre√ßo": `R$ ${(Number(p.preco)||0).toFixed(2)}`
      };
    });
    const cols = ["C√≥digo","Produto","Classifica√ß√£o","Atual","M√≠n","Status","Pre√ßo"];
    const table = tableFromRows(cols, rows);
    const htmlCard = buildReportCard(
      "Invent√°rio Geral",
      `Total de produtos: ${produtos.length}`,
      table
    );
    out.innerHTML = htmlCard;

    lastPDFHtml = buildPrintableDoc({
      title:"Invent√°rio Geral",
      subtitle:`Total de produtos: ${produtos.length}`,
      bodyHTML: htmlCard.replace(/class="rt-table"/g,'')
        .replace(/rt-card/g,'card')
        .replace(/rt-title/g,'')
        .replace(/rt-sub/g,'')
        .replace(/rt-badge/g,'badge')
        .replace(/rt-table/g,'')
        .replace(/<table class="rt-table">/g,'<table>')
    });
    lastPDFName = "inventario_geral";
    toast("‚úÖ Relat√≥rio gerado");
    return;
  }

  if(tipo==="baixo"){
    const list = produtos.filter(p=> (p.estoqueAtual||0) > 0 && (p.estoqueAtual||0) <= (p.estoqueMin||0));
    const rows = list
      .sort((a,b)=>(a.estoqueAtual||0)-(b.estoqueAtual||0))
      .map(p=>({
        "C√≥digo": escapeHtml(p.codigo2||p.codigo1||""),
        "Produto": escapeHtml(p.nome||""),
        "Classifica√ß√£o": escapeHtml(p.categoria||""),
        "Atual/M√≠n": `<b>${p.estoqueAtual||0}</b> / ${p.estoqueMin||0}`,
        "Pre√ßo": `R$ ${(Number(p.preco)||0).toFixed(2)}`
      }));
    const cols = ["C√≥digo","Produto","Classifica√ß√£o","Atual/M√≠n","Pre√ßo"];
    const table = tableFromRows(cols, rows);
    const htmlCard = buildReportCard(
      "Produtos abaixo do m√≠nimo",
      `Total: ${list.length}`,
      table
    );
    out.innerHTML = htmlCard;

    lastPDFHtml = buildPrintableDoc({
      title:"Produtos abaixo do m√≠nimo",
      subtitle:`Total: ${list.length}`,
      bodyHTML: htmlCard.replace(/rt-card/g,'card').replace(/rt-table/g,'')
        .replace(/<table class="rt-table">/g,'<table>')
    });
    lastPDFName = "abaixo_minimo";
    toast("‚úÖ Relat√≥rio gerado");
    return;
  }

  if(tipo==="classificacao"){
    const cat = document.getElementById("rCat")?.value || "";
    const filtered = cat ? produtos.filter(p=>p.categoria===cat) : produtos;
    // agrupado por classifica√ß√£o com subtotal, comum em softwares de materiais (se√ß√µes por categoria)
    const groups = {};
    for(const p of filtered){
      const c = p.categoria || "SEM CLASSIFICA√á√ÉO";
      if(!groups[c]) groups[c] = [];
      groups[c].push(p);
    }
    const parts = Object.keys(groups).sort((a,b)=>a.localeCompare(b,'pt-BR')).map(c=>{
      const rows = groups[c].map(p=>({
        "C√≥digo": escapeHtml(p.codigo2||p.codigo1||""),
        "Produto": escapeHtml(p.nome||""),
        "Atual": String(p.estoqueAtual||0),
        "M√≠n": String(p.estoqueMin||0),
        "Pre√ßo": `R$ ${(Number(p.preco)||0).toFixed(2)}`
      }));
      const table = tableFromRows(["C√≥digo","Produto","Atual","M√≠n","Pre√ßo"], rows);
      return `<div class="rt-card" style="margin-bottom:12px">
        <div class="rt-title">üè∑Ô∏è ${escapeHtml(c)}</div>
        <div class="rt-sub">Itens: ${groups[c].length}</div>
        ${table}
      </div>`;
    }).join("");
    const title = cat ? `Produtos por Classifica√ß√£o ‚Ä¢ ${cat}` : "Produtos por Classifica√ß√£o";
    out.innerHTML = parts || `<div class="rt-card"><div class="rt-title">${escapeHtml(title)}</div><div class="rt-sub">Nenhum item.</div></div>`;

    lastPDFHtml = buildPrintableDoc({
      title: title,
      subtitle: `Total: ${filtered.length}`,
      bodyHTML: out.innerHTML.replace(/rt-card/g,'card').replace(/rt-table/g,'')
        .replace(/<table class="rt-table">/g,'<table>')
    });
    lastPDFName = "por_classificacao";
    toast("‚úÖ Relat√≥rio gerado");
    return;
  }

  if(tipo==="movsetor"){
    const setor = document.getElementById("rSetor")?.value || "ADMINISTRA√á√ÉO";
    const dir = document.getElementById("rDir")?.value || "ambos";
    const deISO = document.getElementById("rDe")?.value || "";
    const ateISO = document.getElementById("rAte")?.value || "";
    const de = deISO ? new Date(deISO+"T00:00:00") : null;
    const ate = ateISO ? new Date(ateISO+"T23:59:59") : null;

    const list = movs.filter(m=>{
      const dt = ptbrToDate(m.quando);
      const okd = !de || (dt && dt>=de);
      const oka = !ate || (dt && dt<=ate);
      let oks = (m.origem===setor || m.destino===setor);
      if(dir==="entradas") oks = (m.destino===setor);
      if(dir==="saidas") oks = (m.origem===setor);
      return okd && oka && oks;
    }).slice().reverse();

    const rows = list.map(m=>({
      "Quando": escapeHtml(m.quando||""),
      "Produto": escapeHtml(m.produto_nome||""),
      "Classifica√ß√£o": escapeHtml(m.categoria||""),
      "Qtd": `<b>${m.qtd}</b>`,
      "Origem": escapeHtml(m.origem||""),
      "Destino": escapeHtml(m.destino||""),
      "Obs": escapeHtml(m.obs||"")
    }));
    const cols = ["Quando","Produto","Classifica√ß√£o","Qtd","Origem","Destino","Obs"];
    const table = tableFromRows(cols, rows);

    const subt = `Setor: ${setor} ‚Ä¢ ${deISO||"‚Äî"} a ${ateISO||"‚Äî"} ‚Ä¢ Registros: ${list.length}`;
    const htmlCard = buildReportCard("Movimenta√ß√µes por setor", subt, table);
    out.innerHTML = htmlCard;

    lastPDFHtml = buildPrintableDoc({
      title:"Movimenta√ß√µes por setor",
      subtitle: subt,
      bodyHTML: htmlCard.replace(/rt-card/g,'card').replace(/rt-table/g,'')
        .replace(/<table class="rt-table">/g,'<table>')
    });
    lastPDFName = "mov_por_setor";
    toast("‚úÖ Relat√≥rio gerado");
    return;
  }
});

$("btnPDFRel").addEventListener("click",()=>{
  if(!lastPDFHtml){ toast("‚ö†Ô∏è Gere um relat√≥rio primeiro"); return; }
  openPrintWindow(lastPDFHtml, lastPDFName);
});

$("btnLimparRel").addEventListener("click",()=>{
  $("rOut").innerHTML = "";
  lastPDFHtml = "";
  toast("üßπ Limpo");
});

/* ========= Gest√£o de Setores ========= */
let setorAtual = "ADMINISTRA√á√ÉO";
let lastSetPDFHtml = "";

$("btnSet").addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderSetores();
  abrirModal("modalSet");
});

$("sBusca")?.addEventListener("input", ()=>renderSetores());

function setorStats(setor){
  // saldo no setor (soma das aloca√ß√µes) + n¬∫ de movimenta√ß√µes (entradas/sa√≠das)
  let saldo = 0;
  for(const p of produtos){
    const al = (p.alocacoes && typeof p.alocacoes==="object") ? p.alocacoes : null;
    if(al && al[setor]) saldo += Number(al[setor])||0;
  }
  const movCount = movs.filter(m=>m.origem===setor || m.destino===setor).length;
  return {saldo, movCount};
}

function renderSetores(){
  const q = ($("sBusca")?.value || "").trim().toLowerCase();
  const grid = $("setGrid");
  if(!grid) return;
  grid.innerHTML = "";

  const list = SETORES.filter(s=>{
    if(!q) return true;
    return s.toLowerCase().includes(q);
  });

  // ordena por saldo desc, depois nome
  const enriched = list.map(s=>({s, ...setorStats(s)}))
    .sort((a,b)=> (b.saldo-a.saldo) || a.s.localeCompare(b.s,'pt-BR'));

  enriched.forEach(({s, saldo, movCount})=>{
    const card = document.createElement("div");
    card.className = "set-card";
    card.innerHTML = `
      <div class="set-top">
        <div class="set-name">${escapeHtml(s)}</div>
        <div class="set-chip">Mov: <span class="set-num">${movCount}</span></div>
      </div>
      <div class="set-sub">Saldo no setor: <span class="set-num">${saldo}</span></div>
    `;
    card.addEventListener("click", ()=>abrirSetorDetalhe(s));
    grid.appendChild(card);
  });

  if(!enriched.length){
    grid.innerHTML = `<div class="rt-card" style="grid-column:1/-1"><div class="rt-title">Nenhum setor encontrado</div></div>`;
  }
}

function abrirSetorDetalhe(setor){
  setorAtual = setor;
  $("sdTitle").textContent = `üèõÔ∏è ${setor}`;
  // defaults: hoje
  const d = new Date(); const pad=n=>String(n).padStart(2,"0");
  const hoje = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  $("sdDe").value = hoje;
  $("sdAte").value = hoje;
  $("sdDir").value = "ambos";
  $("sdOut").innerHTML = "";
  $("sdResumo").innerHTML = "";
  lastSetPDFHtml = "";
  fecharModal("modalSet");
  abrirModal("modalSetDet");
  gerarRelSetor(); // gera automaticamente
}

function gerarRelSetor(){
  const deISO = $("sdDe").value || "";
  const ateISO = $("sdAte").value || "";
  const dir = $("sdDir").value || "ambos";
  const de = deISO ? new Date(deISO+"T00:00:00") : null;
  const ate = ateISO ? new Date(ateISO+"T23:59:59") : null;

  const list = movs.filter(m=>{
    const dt = ptbrToDate(m.quando);
    const okd = !de || (dt && dt>=de);
    const oka = !ate || (dt && dt<=ate);
    let oks = (m.origem===setorAtual || m.destino===setorAtual);
    if(dir==="entradas") oks = (m.destino===setorAtual);
    if(dir==="saidas") oks = (m.origem===setorAtual);
    return okd && oka && oks;
  }).slice().reverse();

  // resumo (saldo atual + entradas/sa√≠das no per√≠odo)
  const {saldo} = setorStats(setorAtual);
  let ent=0, sai=0;
  list.forEach(m=>{
    if(m.destino===setorAtual) ent += Number(m.qtd)||0;
    if(m.origem===setorAtual) sai += Number(m.qtd)||0;
  });

  
  // saldo por classifica√ß√£o e top produtos (saldo atual no setor)
  const catMap = {};
  const prodSaldos = [];
  for(const p of produtos){
    const al = (p.alocacoes && typeof p.alocacoes==="object") ? p.alocacoes : null;
    const s = al ? (Number(al[setorAtual])||0) : 0;
    if(s>0){
      const c = p.categoria || "SEM CLASSIFICA√á√ÉO";
      catMap[c] = (catMap[c]||0) + s;
      prodSaldos.push({ nome: p.nome||"", codigo: (p.codigo2||p.codigo1||""), categoria: c, saldo: s });
    }
  }
  const catRows = Object.entries(catMap)
    .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0],'pt-BR'))
    .map(([c,v])=> `<tr><td>${escapeHtml(c)}</td><td style="text-align:right"><b>${v}</b></td></tr>`)
    .join("") || `<tr><td colspan="2" class="muted" style="padding:10px">Nenhum saldo no setor.</td></tr>`;

  const top = prodSaldos.sort((a,b)=> b.saldo-a.saldo).slice(0,20);
  const topRows = top.map(x=> `
    <tr>
      <td>${escapeHtml(x.codigo)}</td>
      <td>${escapeHtml(x.nome)}</td>
      <td>${escapeHtml(x.categoria)}</td>
      <td style="text-align:right"><b>${x.saldo}</b></td>
    </tr>
  `).join("") || `<tr><td colspan="4" class="muted" style="padding:10px">Nenhum saldo no setor.</td></tr>`;

$("sdResumo").innerHTML = `
    <div class="rt-title">Resumo</div>
    <div class="rt-sub">Per√≠odo: ${escapeHtml(deISO||"‚Äî")} a ${escapeHtml(ateISO||"‚Äî")} ‚Ä¢ Registros: ${list.length}</div>

    <div class="twocol" style="margin-top:10px">
      <div class="rt-card" style="margin:0">
        <div class="rt-sub">Saldo atual no setor</div>
        <div class="rt-title" style="margin:0">${saldo}</div>
      </div>
      <div class="rt-card" style="margin:0">
        <div class="rt-sub">Entradas / Sa√≠das (per√≠odo)</div>
        <div class="rt-title" style="margin:0">${ent} / ${sai}</div>
      </div>
    </div>

    <div class="rt-card" style="margin-top:12px">
      <div class="rt-title" style="margin:0 0 6px 0">üè∑Ô∏è Saldo por Classifica√ß√£o</div>
      <table class="rt-table">
        <thead><tr><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
        <tbody>${catRows}</tbody>
      </table>
    </div>

    <div class="rt-card" style="margin-top:12px">
      <div class="rt-title" style="margin:0 0 6px 0">üì¶ Top 20 produtos no setor</div>
      <table class="rt-table">
        <thead><tr><th>C√≥digo</th><th>Produto</th><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
        <tbody>${topRows}</tbody>
      </table>
    </div>
  `;

  const rows = list.map(m=>({
    "Quando": escapeHtml(m.quando||""),
    "Produto": escapeHtml(m.produto_nome||""),
    "Classifica√ß√£o": escapeHtml(m.categoria||""),
    "Qtd": `<b>${m.qtd}</b>`,
    "Origem": escapeHtml(m.origem||""),
    "Destino": escapeHtml(m.destino||""),
    "Obs": escapeHtml(m.obs||"")
  }));
  const cols = ["Quando","Produto","Classifica√ß√£o","Qtd","Origem","Destino","Obs"];
  const table = tableFromRows(cols, rows);

  const subt = `Setor: ${setorAtual} ‚Ä¢ ${deISO||"‚Äî"} a ${ateISO||"‚Äî"} ‚Ä¢ Registros: ${list.length}`;
  const card = buildReportCard("Movimenta√ß√µes do setor", subt, table);
  $("sdOut").innerHTML = card;

  lastSetPDFHtml = buildPrintableDoc({
    title:`Movimenta√ß√µes do Setor ‚Ä¢ ${setorAtual}`,
    subtitle: subt,
    bodyHTML: `
      <div class="card">
        <div style="font-weight:950;font-size:14px;margin-bottom:6px">Resumo</div>
        <div style="font-size:11px;color:#5b6288;font-weight:800">Saldo atual: <b>${saldo}</b> ‚Ä¢ Entradas/Sa√≠das no per√≠odo: <b>${ent}</b>/<b>${sai}</b></div>
      </div>

      <div class="card">
        <div style="font-weight:950;font-size:14px;margin-bottom:6px">Saldo por Classifica√ß√£o</div>
        <table>
          <thead><tr><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
          <tbody>${catRows}</tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:950;font-size:14px;margin-bottom:6px">Top 20 produtos no setor</div>
        <table>
          <thead><tr><th>C√≥digo</th><th>Produto</th><th>Classifica√ß√£o</th><th style="text-align:right">Saldo</th></tr></thead>
          <tbody>${topRows}</tbody>
        </table>
      </div>

      ${card.replace(/rt-card/g,'card').replace(/<table class="rt-table">/g,'<table>').replace(/rt-table/g,'')}
    `
  });

  toast("‚úÖ Setor carregado");
}

$("btnGerarSet").addEventListener("click", gerarRelSetor);

$("btnPDFSet").addEventListener("click", ()=>{
  if(!lastSetPDFHtml){ toast("‚ö†Ô∏è Gere primeiro"); return; }
  openPrintWindow(lastSetPDFHtml, "setor_"+setorAtual);
});

$("btnVoltarSet").addEventListener("click", ()=>{
  fecharModal("modalSetDet");
  renderSetores();
  abrirModal("modalSet");
});



$("btnEstoque").addEventListener("click",()=>{ window.scrollTo({top:0,behavior:"smooth"}); toast("üì¶ Estoque"); });

/* ---- Persist√™ncia ---- */
function save(){
  localStorage.setItem(KEY_PROD, JSON.stringify(produtos));
  localStorage.setItem(KEY_MOV, JSON.stringify(movs));
}
function load(){
  try{
    const raw = localStorage.getItem(KEY_PROD);
    const rm  = localStorage.getItem(KEY_MOV);
    produtos = raw ? JSON.parse(raw).map(normalizeProduto) : [];
    movs = rm ? JSON.parse(rm) : [];
  }catch{ produtos=[]; movs=[]; }
}

/* ---- Normaliza√ß√£o compat√≠vel com seu JSON ---- */
function parseInputJSON(data){
  if(Array.isArray(data)){
    // suporte ao formato antigo estranho
    if(data.length>=4 && data[1]==="produtos" && String(data[2]).trim()===":" && Array.isArray(data[3])) return data[3];
    return data;
  }
  if(data && typeof data==="object" && Array.isArray(data.produtos)) return data.produtos;
  return null;
}

function normalizeProduto(p){
  const o = {...p};
  o.codigo1 = o.codigo1 ?? o.id ?? "NULL";
  o.codigo2 = o.codigo2 ?? o.sku ?? "";
  o.nome = String(o.nome ?? "").trim();
  o.estoqueAtual = Number(o.estoqueAtual ?? o.estoque_atual ?? 0) || 0;
  o.estoqueMin   = Number(o.estoqueMin ?? o.estoque_minimo ?? 0) || 0;
  o.preco        = Number(o.preco ?? o.preco_custo ?? 0) || 0;
  o.setor        = o.setor || "ALMOXARIFADO";
  o.categoria    = o.categoria ?? o.classificacao ?? "SEM CLASSIFICA√á√ÉO";
  o.descricao    = o.descricao ?? "";
  return o;
}

function categoriasUnicas(){
  const s = new Set(produtos.map(p=>p.categoria).filter(Boolean));
  return Array.from(s).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
}

function limparNomeCategoria(v){
  v = String(v||"").trim();
  v = v.replace(/\s+/g," ");
  return v;
}
function garantirCategoriaNoSelect(selectEl, cat){
  const v = limparNomeCategoria(cat);
  if(!v) return;
  const exists = Array.from(selectEl.options).some(o=>o.value===v);
  if(!exists){
    const opt = document.createElement("option");
    opt.value = v; opt.textContent = v;
    const newOpt = Array.from(selectEl.options).find(o=>o.value==="__NEW__");
    if(newOpt) selectEl.insertBefore(opt, newOpt);
    else selectEl.appendChild(opt);
  }
}

/* ---- UI Estoque ---- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function statusProduto(p){
  const a=p.estoqueAtual||0, m=p.estoqueMin||0;
  if(a===0) return {cls:"zero", txt:"ZERADO"};
  if(a<=m) return {cls:"low", txt:"BAIXO"};
  return {cls:"ok", txt:"OK"};
}

function updateStats(){
  let ok=0, low=0, zero=0;
  for(const p of produtos){
    const st=statusProduto(p).cls;
    if(st==="ok") ok++; else if(st==="low") low++; else zero++;
  }
  $("statTotal").textContent = produtos.length;
  $("statOk").textContent = ok;
  $("statLow").textContent = low;
  $("statZero").textContent = zero;
}

function render(){
  const q = ($("q").value||"").toLowerCase().trim();
  const list = !q ? produtos : produtos.filter(p=>{
    const hay = `${p.nome} ${p.codigo1} ${p.codigo2} ${p.categoria}`.toLowerCase();
    return hay.includes(q);
  });

  const grid=$("grid");
  grid.innerHTML="";

  if(produtos.length===0){
    grid.innerHTML = `<div class="card"><div style="font-weight:950">Importe seu JSON em üíæ Dados.</div><div class="muted" style="margin-top:8px">Depois disso, tudo funciona offline.</div></div>`;
    updateStats();
    return;
  }
  if(list.length===0){
    grid.innerHTML = `<div class="card"><div style="font-weight:950">Nenhum resultado.</div><div class="muted" style="margin-top:8px">Tente outro termo.</div></div>`;
    updateStats();
    return;
  }

  list.forEach(p=>{
    const st=statusProduto(p);
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="row">
        <div>
          <div class="code">${escapeHtml(p.codigo2||p.codigo1||"-")}</div>
          <div class="muted" style="margin-top:2px;font-size:12px">${escapeHtml(p.codigo1 && p.codigo1!=="NULL" ? "("+p.codigo1+")" : "")}</div>
        </div>
        <div class="cat">${escapeHtml(p.categoria||"")}</div>
      </div>
      <div class="name">${escapeHtml(p.nome||"-")}</div>
      <div class="meta">
        <div class="box">
          <div class="lbl">ESTOQUE</div>
          <div class="val">${p.estoqueAtual||0} / ${p.estoqueMin||0}</div>
        </div>
        <div class="box">
          <div class="lbl">PRE√áO</div>
          <div class="val">R$ ${(Number(p.preco)||0).toFixed(2)}</div>
        </div>
      </div>
      <div class="status">
        <div class="muted" style="font-weight:900">${escapeHtml(p.setor||"ALMOXARIFADO")}</div>
        <div class="badge ${st.cls}">${st.txt}</div>
      </div>
    `;
    card.addEventListener("click",()=>openEdit(p));
    grid.appendChild(card);
  });

  updateStats();
}

/* ---- Editar produto ---- */
function openEdit(p){
  editIndex = produtos.indexOf(p);
  if(editIndex<0) return;

  const catList = categoriasUnicas();
  $("pCategoria").innerHTML = (catList.length ? catList : ["SEM CLASSIFICA√á√ÉO"])
    .map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("")
    + `<option value="__NEW__">‚ûï Nova classifica√ß√£o‚Ä¶</option>`;

  $("pCodigo1").value = p.codigo1 ?? "";
  $("pCodigo2").value = p.codigo2 ?? "";
  $("pNome").value    = p.nome ?? "";
  $("pCategoria").value = p.categoria ?? (catList[0]||"SEM CLASSIFICA√á√ÉO");
  $("pAtual").value   = p.estoqueAtual ?? 0;
  $("pMin").value     = p.estoqueMin ?? 0;
  $("pPreco").value   = p.preco ?? 0;
  $("pDesc").value    = p.descricao ?? "";


// sele√ß√£o din√¢mica de classifica√ß√£o (permite criar novas)
$("pCategoria").addEventListener("change", ()=>{
  if(editIndex<0) return;
  const sel = $("pCategoria");
  if(sel.value==="__NEW__"){
    const novo = prompt("Digite a nova classifica√ß√£o:", "");
    const v = limparNomeCategoria(novo);
    if(!v){
      // volta para a atual do produto
      sel.value = produtos[editIndex].categoria || "SEM CLASSIFICA√á√ÉO";
      return;
    }
    // garante que existe no select e seleciona
    garantirCategoriaNoSelect(sel, v);
    sel.value = v;
  }
});
  abrirModal("modalProduto");
}

$("btnSaveProd").addEventListener("click",()=>{
  if(editIndex<0) return;
  const p = produtos[editIndex];

  p.codigo1 = $("pCodigo1").value.trim() || "NULL";
  p.codigo2 = $("pCodigo2").value.trim();
  p.nome = $("pNome").value.trim();
  p.categoria = $("pCategoria").value;
  p.estoqueAtual = Math.max(0, parseInt($("pAtual").value,10)||0);
  p.estoqueMin = Math.max(0, parseInt($("pMin").value,10)||0);
  p.preco = Math.max(0, parseFloat($("pPreco").value)||0);
  p.descricao = $("pDesc").value;

  save();
  fecharModal("modalProduto");
  toast("‚úÖ Produto salvo");
  render();
});

$("btnDelProd").addEventListener("click",()=>{
  if(editIndex<0) return;
  if(!confirm("Deletar este produto?")) return;
  produtos.splice(editIndex,1);
  editIndex=-1;
  save();
  fecharModal("modalProduto");
  toast("üóëÔ∏è Deletado");
  render();
});

/* ---- Dados: importar/exportar/reset ---- */
$("btnImport").addEventListener("click",()=> $("fileInput").click());

$("fileInput").addEventListener("change",(e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(r.result);
      const arr = parseInputJSON(data);
      if(!arr){ toast("‚ö†Ô∏è JSON inv√°lido"); return; }
      produtos = arr.map(normalizeProduto);
      movs = [];
      save();
      toast(`‚úÖ Importado: ${produtos.length}`);
      fecharModal("modalDados");
      render();
    }catch{
      toast("‚ùå Erro ao importar");
    }
  };
  r.readAsText(file);
  e.target.value="";
});

$("btnExport").addEventListener("click",()=>{
  const payload = { produtos, movimentacoes: movs, exportado_em: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "ALMOX2026_backup_produtos_movs.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("üì§ Exportado");
});

$("btnReset").addEventListener("click",()=>{
  if(!confirm("Limpar dados do aparelho?")) return;
  localStorage.removeItem(KEY_PROD);
  localStorage.removeItem(KEY_MOV);
  produtos=[]; movs=[];
  render();
  toast("üßπ Limpo");
});


/* ========= Fase 2: Movimenta√ß√µes =========
   Modelo de controle:
   - Origem ALMOXARIFADO: baixa estoqueAtual e credita saldo do setor (alocacoes[setor])
   - Origem SETOR: baixa alocacoes[origem] e credita alocacoes[destino]
   As aloca√ß√µes ficam dentro do produto, assim voc√™ consegue ver "o que foi transferido" depois.
*/
function ensureAloc(p){
  if(!p.alocacoes || typeof p.alocacoes !== "object") p.alocacoes = {};
  return p.alocacoes;
}
function prepararMovimentacao(){
  // preenche selects
  const opt = SETORES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  $("mOrig").innerHTML = opt;
  $("mDest").innerHTML = opt;
  $("mOrig").value = "ALMOXARIFADO";
  $("mDest").value = "ADMINISTRA√á√ÉO";
  $("mItem").value = "";
  $("mObs").value = "";
  $("mQtd").value = "1";
  movProdutoIndex = -1;

  // datetime default
  const now = new Date();
  const pad=(n)=>String(n).padStart(2,"0");
  const v = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
  $("mQuando").value = v;

  $("mSug").style.display = "none";
  $("mSug").innerHTML = "";
}

function sugRender(indices, q){
  const box = $("mSug");
  if(!indices.length){ box.style.display="none"; box.innerHTML=""; return; }
  box.style.display="block";
  const esc = (x)=>escapeHtml(x);
  const qrx = q ? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),"ig") : null;
  box.innerHTML = indices.slice(0,12).map(idx=>{
    const p = produtos[idx];
    const name = String(p.nome||"");
    const hi = qrx ? esc(name).replace(qrx, m=>`<strong>${m}</strong>`) : esc(name);
    const alm = Number(p.estoqueAtual)||0;
    return `<div class="sug-item" data-idx="${idx}">
      <div class="sug-title">${hi}</div>
      <div class="sug-sub">${esc(p.categoria||"")} ‚Ä¢ Almox: <b>${alm}</b></div>
    </div>`;
  }).join("");

  box.querySelectorAll(".sug-item").forEach(el=>{
    el.addEventListener("click",()=>{
      const idx = parseInt(el.getAttribute("data-idx"),10);
      selectMovProduto(idx);
    });
  });
}

function selectMovProduto(idx){
  movProdutoIndex = idx;
  $("mItem").value = produtos[idx].nome || "";
  $("mSug").style.display="none";
}

$("mItem")?.addEventListener("input",()=>{
  const q = $("mItem").value.trim().toLowerCase();
  if(!q){ $("mSug").style.display="none"; movProdutoIndex=-1; return; }
  const hits = [];
  for(let i=0;i<produtos.length;i++){
    const p=produtos[i];
    const hay = `${p.nome||""} ${p.codigo1||""} ${p.codigo2||""} ${p.categoria||""}`.toLowerCase();
    if(hay.includes(q)) hits.push(i);
    if(hits.length>=40) break;
  }
  sugRender(hits, q);
});

$("btnGravarMov")?.addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON primeiro"); return; }
  if(movProdutoIndex<0){ toast("‚ö†Ô∏è Selecione um item"); return; }

  const qtd = Math.max(1, parseInt($("mQtd").value,10)||1);
  const origem = $("mOrig").value;
  const destino = $("mDest").value;
  if(origem===destino){ toast("‚ö†Ô∏è Origem = destino"); return; }

  const p = produtos[movProdutoIndex];

  if(origem==="ALMOXARIFADO"){
    if((p.estoqueAtual||0) < qtd){ toast("‚ùå Estoque insuficiente no ALMOX"); return; }
    p.estoqueAtual -= qtd;
    const al = ensureAloc(p);
    al[destino] = (Number(al[destino])||0) + qtd;
  }else{
    const al = ensureAloc(p);
    const saldo = Number(al[origem])||0;
    if(saldo < qtd){ toast("‚ùå Saldo insuficiente no setor origem"); return; }
    al[origem] = saldo - qtd;
    al[destino] = (Number(al[destino])||0) + qtd;
  }

  const quandoRaw = $("mQuando").value;
  const quando = quandoRaw ? new Date(quandoRaw).toLocaleString("pt-BR") : new Date().toLocaleString("pt-BR");

  movs.push({
    id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"-"+Math.random().toString(16).slice(2),
    produto_idx: movProdutoIndex,
    produto_nome: p.nome,
    codigo2: p.codigo2,
    categoria: p.categoria,
    qtd, origem, destino,
    obs: $("mObs").value || "",
    quando
  });

  save();
  render();          // atualiza estoque na tela
  renderMovList();   // atualiza lista
  toast("‚úÖ Movimenta√ß√£o gravada");
  
  // Notificar outros usu√°rios via WebSocket
  if(window.notificarMovimentacao) {
    window.notificarMovimentacao(movs[movs.length - 1]);
  }

  // limpa item para pr√≥xima
  $("mItem").value = "";
  $("mObs").value = "";
  $("mQtd").value = "1";
  movProdutoIndex = -1;
});

function renderMovList(){
  const box = $("movList");
  if(!box) return;
  box.innerHTML = "";
  const last = movs.slice().reverse().slice(0,12);
  if(!last.length){
    box.innerHTML = `<div class="card" style="margin:0"><div class="muted" style="font-weight:900">Nenhuma movimenta√ß√£o.</div></div>`;
    return;
  }
  last.forEach(m=>{
    const div=document.createElement("div");
    div.className="card";
    div.style.margin="0 0 10px 0";
    div.innerHTML = `
      <div class="row">
        <div style="font-weight:950">${escapeHtml(m.produto_nome||"-")}</div>
        <div class="muted" style="font-weight:900">${escapeHtml(m.quando||"")}</div>
      </div>
      <div class="muted" style="margin-top:6px;font-weight:900">
        Qtd: <b style="color:var(--pri)">${m.qtd}</b> ‚Ä¢ ${escapeHtml(m.origem)} ‚Üí ${escapeHtml(m.destino)}
      </div>
      ${m.obs ? `<div class="muted" style="margin-top:6px">${escapeHtml(m.obs)}</div>` : ""}
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="fbtn" style="width:auto;padding:6px 12px;font-size:12px;background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.5)" onclick="editarMovimentacao(movs.findIndex(mv => mv.id === '${m.id}'))">Editar</button>
        <button class="fbtn" style="width:auto;padding:6px 12px;font-size:12px;background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.5)" onclick="deletarMovimentacao(movs.findIndex(mv => mv.id === '${m.id}'))">Deletar</button>
      </div>
    `;
    box.appendChild(div);
  });
}

$("btnExportMov")?.addEventListener("click",()=>{
  const blob = new Blob([JSON.stringify(movs,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="ALMOX2026_movimentacoes.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("üì§ Movimenta√ß√µes exportadas");
});

/* ---- init ---- */
document.addEventListener("DOMContentLoaded",()=>{
  load();
  render();
  $("q").addEventListener("input",render);
});
</script>
<script src="/almox-sync.js"></script>
<manus-content-root></manus-content-root><script>
			var __manus_space_editor_info = {
			spaceId : '6CSziXVmCQYR2QG3vW2dnY',
			patchList : [],
			hideBadge : false,
			sessionId : 'MXqgWn7BsaR7mkZUcpiBUc',
			isWebDev : true,
			usageStatus : 'UsageStatus_Unknown',
			};
			var __manus__global_env = {
				apiHost: 'https://api.manus.im',
				host: 'https://manus.im',
				amplitudeKey: '46ac3f9abb41dd2d17a5785e052bc6d3',
			};
			</script><script src="https://files.manuscdn.com/manus-space-dispatcher/spaceEditor-DPV-_I11.js" async></script><script
			defer
			data-domain="manus.space"
			src="https://plausible.io/js/script.file-downloads.hash.outbound-links.pageview-props.revenue.tagged-events.js"
		></script>
		<script>
			window.plausible =
				window.plausible ||
				function () {
					(window.plausible.q = window.plausible.q || []).push(arguments);
				};
			plausible('custom-pageview', {
			  props: {
    			domain: window.location.host
  			}
			})
		</script></body>
</html>

<script>
// Listeners para exporta√ß√£o de relat√≥rios
document.addEventListener('DOMContentLoaded', function() {
  const btnExportExcel = document.getElementById('btnExportExcel');
  const btnExportPDF = document.getElementById('btnExportPDF');
  
  if(btnExportExcel) {
    btnExportExcel.addEventListener('click', function() {
      console.log('[ALMOX] Exportando relat√≥rio em Excel...');
      window.location.href = '/api/almox/export/excel';
    });
  }
  
  if(btnExportPDF) {
    btnExportPDF.addEventListener('click', function() {
      console.log('[ALMOX] Exportando relat√≥rio em PDF...');
      window.location.href = '/api/almox/export/pdf';
    });
  }
});
</script>

<script>
// Fun√ß√£o para salvar novo produto
async function salvarNovoProduto() {
  const codigo1 = document.getElementById('novoProdCodigo1').value.trim();
  const codigo2 = document.getElementById('novoProdCodigo2').value.trim();
  const nome = document.getElementById('novoProdNome').value.trim();
  const descricao = document.getElementById('novoProdDescricao').value.trim();
  const categoria = document.getElementById('novoProdCategoria').value.trim();
  const ncm = document.getElementById('novoProdNCM').value.trim();
  const preco = document.getElementById('novoProdPreco').value;
  const estoqueMin = parseInt(document.getElementById('novoProdEstoqueMin').value) || 0;
  const estoque_inicial = parseInt(document.getElementById('novoProdEstoqueInicial').value) || 0;
  const setor = document.getElementById('novoProdSetor').value.trim();
  const ativo = document.getElementById('novoProdAtivo').checked;

  // Validar campos obrigat√≥rios
  if (!codigo1 || !nome) {
    alert('C√≥digo (7 d√≠gitos) e Nome s√£o obrigat√≥rios!');
    return;
  }

  try {
    const response = await fetch('/api/almox/produtos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        codigo1,
        codigo2: codigo2 || codigo1,
        nome,
        descricao,
        categoria,
        ncm,
        preco: preco ? parseFloat(preco) : 0,
        estoqueMin,
        setor,
        ativo,
        estoque_inicial,
      }),
    });

    if (!response.ok) {
      const erro = await response.json();
      alert('Erro: ' + (erro.erro || 'Erro ao salvar produto'));
      return;
    }

    const resultado = await response.json();
    alert('Produto criado com sucesso! C√≥digo: ' + resultado.produto.codigo1);

    // Limpar formul√°rio
    document.getElementById('novoProdCodigo1').value = '';
    document.getElementById('novoProdCodigo2').value = '';
    document.getElementById('novoProdNome').value = '';
    document.getElementById('novoProdDescricao').value = '';
    document.getElementById('novoProdCategoria').value = '';
    document.getElementById('novoProdNCM').value = '';
    document.getElementById('novoProdPreco').value = '';
    document.getElementById('novoProdEstoqueMin').value = '0';
    document.getElementById('novoProdEstoqueInicial').value = '0';
    document.getElementById('novoProdSetor').value = 'ALMOXARIFADO';
    document.getElementById('novoProdAtivo').checked = true;

    // Fechar modal
    abrirModal('');

    // Recarregar produtos
    const prodResponse = await fetch('/api/almox/produtos');
    if (prodResponse.ok) {
      const produtos = await prodResponse.json();
      const KEY_PROD = 'ALMOX2026_PROD_BASE_V1';
      localStorage.setItem(KEY_PROD, JSON.stringify(produtos));
      console.log('[ALMOX] Produtos recarregados');
      
      // Notificar via WebSocket
      if (window.ws && window.ws.readyState === WebSocket.OPEN) {
        window.ws.send(JSON.stringify({
          tipo: 'produto_criado',
          produto: resultado.produto,
        }));
      }

      // Recarregar interface
      render();
    }
  } catch (error) {
    console.error('[ALMOX] Erro ao salvar produto:', error);
    alert('Erro ao salvar produto: ' + error.message);
  }
}

// Listener para bot√£o de salvar
document.addEventListener('DOMContentLoaded', function() {
  const btnSalvar = document.getElementById('btnSalvarNovoProd');
  if (btnSalvar) {
    btnSalvar.addEventListener('click', salvarNovoProduto);
  }
});
</script>
