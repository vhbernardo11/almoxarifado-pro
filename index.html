
<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>ALMOX2026 ‚Äî Estoque &amp; Movimenta√ß√µes (Offline)</title>
<style>
  :root{
    --bg0:#0b0d18; --bg1:#11142a; --card:#171b34; --card2:#1c2140;
    --txt:#e9ecff; --muted:#aab0d8; --pri:#00d4ff; --sec:#7c3aed;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    color:var(--txt);
    background:radial-gradient(1200px 700px at 20% 0%, #15204a 0%, var(--bg0) 60%);
    overflow-x:hidden;
  }

  /* ===== Floating Nav (n√£o fixa conte√∫do) ===== */
  .fnav{
    position:fixed; left:50%; transform:translateX(-50%);
    top:10px; z-index:9999;
    display:flex; gap:12px; align-items:center; justify-content:center;
    padding:14px 16px 18px;
    background:rgba(23,27,52,.92);
    border:1px solid var(--line);
    border-radius:26px;
    /* blur removido (Android Chrome evita artefatos) */
    backdrop-filter:none; -webkit-backdrop-filter:none;
box-shadow:0 14px 40px rgba(0,0,0,.45);
    max-width:calc(100vw - 16px);
  }
  .fbtn{
    width:58px;height:58px;border-radius:18px;border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    display:flex;align-items:center;justify-content:center;
    font-size:28px; cursor:pointer; user-select:none;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
    touch-action:manipulation;
  }
  .fbtn:active{transform:scale(.96)}
  .fbtn:hover{border-color:rgba(0,212,255,.35)}
  .fhandle{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:8px; width:84px; height:7px; border-radius:999px;
    background:rgba(255,255,255,.35);
  }

  main{padding:108px 12px 18px}
  .topbar{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin:0 2px 12px;}
  .title{font-weight:950; font-size:24px; letter-spacing:.3px}
  .pill{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; font-size:12px; color:var(--muted)}
  .pill span{background:rgba(255,255,255,.06); border:1px solid var(--line); padding:6px 10px; border-radius:999px}
  .muted{color:var(--muted)}
  .search{
    margin:10px 2px 14px;
    background:rgba(255,255,255,.06); border:1px solid var(--line);
    border-radius:16px; padding:12px;
    display:flex; gap:10px; align-items:center;
  }
  .search input{
    width:100%; border:none; outline:none; background:transparent; color:var(--txt);
    font-size:16px;
  }

  .grid{display:grid; gap:12px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    box-shadow:0 8px 24px rgba(0,0,0,.28);
  }
  .row{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
  .code{color:var(--pri); font-weight:900}
  .cat{font-size:12px; background:rgba(124,58,237,.22); border:1px solid rgba(124,58,237,.35); padding:6px 10px; border-radius:999px}
  .name{margin-top:8px; font-weight:850; line-height:1.25}
  .meta{margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .box{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.09); border-radius:14px; padding:10px}
  .lbl{font-size:11px;color:var(--muted);font-weight:800;letter-spacing:.4px}
  .val{margin-top:4px;font-size:16px;font-weight:950}
  .status{
    margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;
    border-top:1px solid rgba(255,255,255,.08); padding-top:12px;
  }
  .badge{font-weight:950; font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid transparent}
  .ok{background:rgba(16,185,129,.18); color:var(--ok); border-color:rgba(16,185,129,.28)}
  .low{background:rgba(245,158,11,.18); color:var(--warn); border-color:rgba(245,158,11,.28)}
  .zero{background:rgba(239,68,68,.18); color:var(--bad); border-color:rgba(239,68,68,.28)}

  /* ===== Modal (sheet) ===== */
  .modal{
    position:fixed; inset:0; z-index:10000;
    background:rgba(0,0,0,.62);
    display:none; align-items:flex-end; justify-content:center;
    padding:12px;
  }
  .modal.active{display:flex}
  .sheet{
    width:100%; max-width:820px; max-height:88vh; overflow:auto;
    background:rgba(23,27,52,.98);
    border:1px solid var(--line);
    border-radius:20px 20px 0 0;
    box-shadow:0 24px 70px rgba(0,0,0,.6);
  }
  .mhead{
    position:sticky; top:0; z-index:2;
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#041018;
    padding:14px 14px 12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:950;
    border-radius:18px 18px 0 0;
  }
  .mhead .x{
    width:40px;height:40px;border-radius:999px;border:none;
    background:rgba(255,255,255,.25); color:#fff; font-size:20px; cursor:pointer;
  }
  .mbar{width:80px;height:7px;border-radius:999px;background:rgba(255,255,255,.55); margin:10px auto 0}
  .mbody{padding:14px}
  .group{margin-bottom:12px}
  label{display:block;font-size:12px;color:rgba(255,255,255,.85);font-weight:900;letter-spacing:.3px;margin-bottom:6px}
  input,select,textarea{
    width:100%; padding:12px 12px; border-radius:14px;
    border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
    color:var(--txt); outline:none; font-size:16px;
  }
  textarea{min-height:84px; resize:vertical}
  .twocol{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:12px 14px 16px; border-top:1px solid rgba(255,255,255,.10)}
  .btn{
    border:none; border-radius:16px; padding:14px 12px;
    font-weight:950; cursor:pointer; font-size:15px;
    touch-action:manipulation;
  }
  .primary{background:linear-gradient(135deg,var(--pri),#00a8cc); color:#041018}
  .secondary{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:var(--txt)}
  .danger{background:var(--bad); color:#fff}

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:11000;
    background:rgba(23,27,52,.96); border:1px solid var(--line);
    padding:10px 14px; border-radius:999px; font-weight:900;
    display:none;
  }
  .toast.show{display:block}

  @media (max-width:360px){
    .fbtn{width:54px;height:54px;border-radius:16px}
    .meta{grid-template-columns:1fr}
  }

  /* ===== Sugest√µes (movimenta√ß√µes) ===== */
  .sug-item{
    padding:12px 12px;
    background:rgba(255,255,255,.04);
    border-bottom:1px solid rgba(255,255,255,.10);
    cursor:pointer;
  }
.sug-item.active{outline:2px solid rgba(0,212,255,.7); background: rgba(0,212,255,.10);}
  .sug-item:last-child{border-bottom:none}
  .sug-item:hover{background:rgba(0,212,255,.10)}
  .sug-title{font-weight:950}
  .sug-sub{margin-top:4px;font-size:12px;color:var(--muted);font-weight:800}

  
  /* Ajuste: bot√µes do modal Relat√≥rios centralizados */
  #modalRel .twocol{width:100%}
  #modalRel .twocol .btn{width:100%}

  
  /* ===== Relat√≥rios (tabs) ===== */
  .rt-switch{display:flex;gap:8px;flex-wrap:wrap}
  .rt-tab{
    flex:1 1 auto;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);
    color:rgba(255,255,255,.92);
    font-weight:950;
    letter-spacing:.2px;
    cursor:pointer;
    white-space:nowrap;
    text-align:center;
    -webkit-tap-highlight-color: transparent;
    transition:transform .08s ease, background .2s ease, border-color .2s ease;
  }
  .rt-tab:active{transform:scale(.98)}
  .rt-tab.active{
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#08101a;
    border-color:transparent;
  }
  @media (max-width:420px){
    .rt-tab{flex:1 1 48%}
  }

/* ===== Relat√≥rios (tabelas) ===== */
  .rt-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px}
  .rt-title{font-weight:950;font-size:16px;margin-bottom:6px}
  .rt-sub{color:var(--muted);font-weight:800;font-size:12px;margin-bottom:10px}
  .rt-table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid rgba(255,255,255,.12)}
  .rt-table thead th{
    text-align:left; padding:10px 10px;
    background:linear-gradient(135deg,var(--pri),var(--sec));
    color:#041018; font-weight:950; font-size:12px;
  }
  .rt-table tbody td{padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.10); font-size:12px; vertical-align:top}
  .rt-table tbody tr:nth-child(even){background:rgba(255,255,255,.04)}
  .rt-table tbody tr:last-child td{border-bottom:none}
  .rt-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:950;font-size:11px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}

  /* ===== Setores ===== */
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:380px){ .grid2{grid-template-columns:1fr} }
  .set-card{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:12px;
    cursor:pointer;
    transition:transform .15s ease, border-color .15s ease, background .15s ease;
  }
  .set-card:active{transform:scale(.98)}
  .set-card:hover{border-color:rgba(0,212,255,.45); background:rgba(0,212,255,.08)}
  .set-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
  .set-name{font-weight:950; font-size:13px; letter-spacing:.2px}
  .set-chip{padding:4px 8px;border-radius:999px;font-weight:950;font-size:11px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
  .set-sub{margin-top:8px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35}
  .set-num{font-weight:950;color:var(--pri)}

  /* Anti-banding: aumenta opacidade dos cards no Android Chrome */
  .pCard,.prod-card,.cardItem,.itemCard,.produto-card{
    background:rgba(26,28,52,.92) !important;
  }

  .group{position:relative;}
  #mSug{position:absolute; left:0; right:0; top:calc(100% + 6px); z-index:9999;}
</style>
</head>
<body>
<!-- Floating nav -->
<div class="fnav" id="fnav">
<button class="fbtn" id="btnEstoque" title="Estoque" type="button" onclick="navEstoque()">üì¶</button>
<button class="fbtn" id="btnMov" title="Movimenta√ß√µes" type="button" onclick="navMov()">üîÅ</button>
<button class="fbtn" id="btnRel" title="Relat√≥rios" type="button" onclick="navRel()">üìä</button>
<button class="fbtn" id="btnSet" title="Setores" type="button" onclick="navSetores()">üèõÔ∏è</button>
<button class="fbtn" id="btnDados" title="Dados" type="button" onclick="navDados()">üíæ</button>
<div class="fhandle" id="fhandle"></div>
</div>
<main>
<div class="topbar">
<div>
<div class="title">ALMOX2026</div>
<div class="muted" style="margin-top:4px;font-weight:700">Base Offline ‚Ä¢ Importar JSON em Dados</div>
</div>
<div class="pill">
<span>Total: <b id="statTotal">0</b></span>
<span style="color:var(--ok)">OK: <b id="statOk">0</b></span>
<span style="color:var(--warn)">Baixo: <b id="statLow">0</b></span>
<span style="color:var(--bad)">Zerado: <b id="statZero">0</b></span>
</div>
</div>
<div class="search">
<span style="font-size:18px">üîé</span>
<input id="q" placeholder="Buscar por nome, c√≥digo, classifica√ß√£o..." type="search"/>
</div>
<div class="grid" id="grid"></div>
</main>
<!-- MODAL: DADOS -->
<div aria-hidden="true" class="modal" id="modalDados">
<div class="sheet">
<div class="mhead">
<div>üíæ Dados</div>
<button class="x" data-close="modalDados">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<button class="btn primary" id="btnImport" type="button" onclick="triggerImport()">üì• Importar JSON</button>
<input accept=".json" id="fileInput" style="display:none" type="file"/>
</div>
<div class="group">
<button class="btn primary" id="btnExport" type="button" onclick="exportarJSON()">üì§ Exportar JSON</button>
<button class="btn" id="btnCSV" type="button" onclick="exportarCSV()">üìä Exportar CSV</button>
<button class="btn" id="btnValidate" type="button" onclick="validarBanco()">‚úÖ Validar banco</button>
</div>
<div class="group">
<button class="btn secondary" id="btnExportCSV">üìÑ Exportar CSV (produtos)</button><button class="btn secondary" id="btnValidate2" type="button">‚úÖ Validar banco</button><div id="diagBox" style="margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,.14); border-radius:14px; background:rgba(255,255,255,.06); font-size:13px; line-height:1.5; color:rgba(255,255,255,.88);">Diagn√≥stico: clique em ‚ÄúValidar banco‚Äù.</div>
</div>
<div class="group" style="display:grid; gap:8px;">
<div class="muted" style="font-weight:850;">üîó Vincular arquivo (opcional)</div>
<button class="btn secondary" id="btnLinkFile">üìé Escolher arquivo .json (lembrar)</button>
<button class="btn secondary" disabled="" id="btnSaveToLinked">üíæ Salvar no mesmo arquivo</button>
<div class="muted" id="dbFileStatus" style="font-size:13px;line-height:1.35;">
          Nenhum arquivo vinculado.
        </div>
</div>
<div class="group muted" style="font-size:13px;line-height:1.4">
<b>Offline (Android/Chrome):</b> o navegador n√£o consegue ‚Äúalterar o JSON do reposit√≥rio‚Äù.
        O que ele faz √© salvar tudo no aparelho e, quando voc√™ quiser, exporta um novo JSON j√° com as movimenta√ß√µes.
        <div style="margin-top:8px"><b>Dica:</b> se o bot√£o <i>Salvar no mesmo arquivo</i> n√£o funcionar no seu celular, use o <i>Exportar</i>.</div>
</div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalDados">Fechar</button>
<button class="btn secondary" id="btnReset">üßπ Limpar dados do aparelho</button>
</div>
</div>
</div>
<!-- MODAL: EDITAR PRODUTO -->
<div aria-hidden="true" class="modal" id="modalProduto">
<div class="sheet">
<div class="mhead">
<div>‚úèÔ∏è Editar produto</div>
<button class="x" data-close="modalProduto">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<label>C√≥digo 1</label>
<input id="pCodigo1"/>
</div>
<div class="group">
<label>C√≥digo 2</label>
<input id="pCodigo2"/>
</div>
<div class="group">
<label>Nome</label>
<input id="pNome"/>
</div>
<div class="group">
<label>Classifica√ß√£o (do JSON)</label>
<select id="pCategoria"></select>
</div>
<div class="twocol">
<div class="group">
<label>Estoque atual (Almoxarifado)</label>
<input id="pAtual" min="0" type="number"/>
</div>
<div class="group">
<label>Estoque m√≠nimo</label>
<input id="pMin" min="0" type="number"/>
</div>
</div>
<div class="group">
<label>Pre√ßo</label>
<input id="pPreco" min="0" step="0.01" type="number"/>
</div>
<div class="group">
<label>Descri√ß√£o</label>
<textarea id="pDesc" placeholder="Opcional"></textarea>
</div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalProduto">Cancelar</button>
<button class="btn danger" id="btnDelProd">üóëÔ∏è Deletar</button>
<button class="btn primary" id="btnSaveProd">‚úÖ Salvar</button>
</div>
</div>
</div>
<!-- MODAL: MOVIMENTA√á√ïES (1 tela) -->
<div aria-hidden="true" class="modal" id="modalMov">
<div class="sheet">
<div class="mhead">
<div>üîÅ Movimenta√ß√µes</div>
<button class="x" data-close="modalMov">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<label>Item (digite para buscar)</label>
<input autocomplete="off" id="mItem" placeholder="Ex.: sulfite, martelo..."/>
<div id="mSugCount" style="display:none; margin-top:6px; font-size:12px; color:rgba(255,255,255,.75); font-weight:800;"></div>
<div id="mSug" style="display:none; margin-top:8px; border:1px solid rgba(255,255,255,.12); border-radius:14px; overflow:hidden; max-height:260px; overflow:auto; background: rgba(10,12,20,.95); position:relative; z-index:5;"></div>
</div>
<div class="twocol">
<div class="group">
<label>Quantidade</label>
<input id="mQtd" min="1" type="number" value="1"/>
</div>
<div class="group">
<label>Data/Hora</label>
<input id="mQuando" type="datetime-local"/>
</div>
</div>
<div class="group">
<label>Setor origem</label>
<select id="mOrig"></select>
</div>
<div class="group">
<label>Setor destinat√°rio</label>
<select id="mDest"></select>
</div>
<div class="group">
<label>Observa√ß√£o</label>
<input id="mObs" placeholder="Opcional"/>
</div>
<div class="group">
<button class="btn primary" id="btnGravarMov">‚úÖ Gravar movimenta√ß√£o</button>
</div>
<div class="group">
<div class="muted" style="font-weight:900;margin-bottom:8px">√öltimas movimenta√ß√µes</div>
<div id="movList"></div>
</div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalMov">Fechar</button>
<button class="btn secondary" id="btnExportMov">üì§ Exportar Movimenta√ß√µes</button>
</div>
</div>
</div>
<!-- MODAL: EDITAR/EXCLUIR MOVIMENTA√á√ÉO -->
<div aria-hidden="true" class="modal" id="modalMovEdit">
<div class="sheet">
<div class="sheet-hd">
<div class="sheet-title">‚úèÔ∏è Editar movimenta√ß√£o</div>
<button class="x" onclick="fecharModal('modalMovEdit')">√ó</button>
</div>
<div class="sheet-bd">
<div class="grid2">
<div class="field" style="grid-column:1/-1">
<label>Item</label>
<input class="inp" id="meItem" readonly="" type="text"/>
<div class="hint">Item n√£o pode ser trocado aqui (para manter o v√≠nculo com o estoque). Se precisar trocar, delete e grave outra.</div>
</div>
<div class="field">
<label>Quantidade</label>
<input class="inp" id="meQtd" inputmode="numeric" min="1" type="number"/>
</div>
<div class="field">
<label>Data/Hora</label>
<input class="inp" id="meQuando" type="datetime-local"/>
</div>
<div class="field">
<label>Setor origem</label>
<select class="inp" id="meOrig"></select>
</div>
<div class="field">
<label>Setor destinat√°rio</label>
<select class="inp" id="meDest"></select>
</div>
<div class="field" style="grid-column:1/-1">
<label>Observa√ß√£o</label>
<input class="inp" id="meObs" placeholder="Opcional" type="text"/>
</div>
</div>
<div class="muted" id="meInfo" style="margin-top:10px;font-weight:900"></div>
</div>
<div class="sheet-ft">
<button class="btn ghost" onclick="fecharModal('modalMovEdit')">Cancelar</button>
<button class="btn danger" id="btnMovEditDel">üóëÔ∏è Deletar</button>
<button class="btn primary" id="btnMovEditSalvar">‚úÖ Salvar</button>
</div>
</div>
</div>
<!-- MODAL: RELAT√ìRIOS -->
<div aria-hidden="true" class="modal" id="modalRel">
<div class="sheet">
<div class="mhead">
<div>üìä Relat√≥rios</div>
<button class="x" data-close="modalRel">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div aria-label="Tipos de relat√≥rio" class="rt-switch" role="tablist"><button class="rt-tab active" data-rt="movgeral">üîÅ Mov. Geral</button><button class="rt-tab" data-rt="movsetor">üè¢ Mov. por setor</button></div>
<!-- Mantido para compatibilidade do JS -->
<select id="rTipo" style="display:none"><option selected="selected" value="movgeral">Movimenta√ß√µes (Geral)</option><option value="movsetor">Movimenta√ß√µes por setor</option></select>
<div class="group" id="rFiltros" style="margin-top:12px"></div>
<div class="twocol" style="margin-top:10px">
<button class="btn primary" id="btnGerarRel">‚úÖ Gerar</button>
<button class="btn secondary" id="btnPDFRel">üìÑ Salvar em PDF</button>
</div>
<div id="rOut" style="margin-top:12px"></div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalRel">Fechar</button>
<button class="btn secondary" id="btnLimparRel">üßπ Limpar</button>
</div>
</div>
</div>
<!-- MODAL: GEST√ÉO DE SETORES -->
<div aria-hidden="true" class="modal" id="modalSet">
<div class="sheet">
<div class="mhead">
<div>üèõÔ∏è Gest√£o de Setores</div>
<button class="x" data-close="modalSet">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="group">
<label>Buscar setor</label>
<input id="sBusca" placeholder="Digite: admin, sa√∫de..."/>
</div>
<div class="grid2" id="setGrid" style="margin-top:10px"></div>
<div class="muted" style="margin-top:10px;font-weight:800">
        Toque em um setor para ver as movimenta√ß√µes e gerar PDF.
      </div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalSet">Fechar</button>
</div>
</div>
</div>
<!-- MODAL: DETALHE DO SETOR -->
<div aria-hidden="true" class="modal" id="modalSetDet">
<div class="sheet">
<div class="mhead">
<div id="sdTitle">üèõÔ∏è Setor</div>
<button class="x" data-close="modalSetDet">√ó</button>
</div>
<div class="mbar"></div>
<div class="mbody">
<div class="twocol">
<div class="group" style="margin:0">
<label>De</label>
<input id="sdDe" type="date"/>
</div>
<div class="group" style="margin:0">
<label>At√©</label>
<input id="sdAte" type="date"/>
</div>
</div>
<div class="group">
<label>Dire√ß√£o</label>
<select id="sdDir">
<option value="ambos">Entradas + Sa√≠das</option>
<option value="entradas">Somente Entradas</option>
<option value="saidas">Somente Sa√≠das</option>
</select>
</div>
<div class="twocol">
<button class="btn primary" id="btnGerarSet">‚úÖ Gerar</button>
<button class="btn secondary" id="btnPDFSet">üìÑ Salvar em PDF</button>
</div>
<div class="rt-card" id="sdResumo" style="margin-top:12px"></div>
<div id="sdOut" style="margin-top:12px"></div>
</div>
<div class="actions">
<button class="btn secondary" data-close="modalSetDet">Fechar</button>
<button class="btn secondary" id="btnVoltarSet">‚Ü©Ô∏è Setores</button>
</div>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
// ==== NAV (definido cedo para n√£o quebrar se bindings falharem) ====
function navDados(){ try{ abrirModal("modalDados"); }catch(e){ console.error(e); } }
function navMov(){ try{ if((produtos||[]).length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; } prepararMovimentacao(); renderMovList(); abrirModal("modalMov"); }catch(e){ console.error(e); } }
function navRel(){ try{ if((produtos||[]).length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; } renderFiltrosRel(); $("rOut").innerHTML=""; abrirModal("modalRel"); }catch(e){ console.error(e); } }
function navSetores(){ try{ if((produtos||[]).length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; } if(typeof renderSetores==="function") renderSetores(); abrirModal("modalSetores"); }catch(e){ console.error(e); } }
function navEstoque(){ try{ document.querySelectorAll(".modal.active").forEach(m=>m.classList.remove("active")); window.scrollTo({top:0, behavior:"smooth"}); }catch(e){ console.error(e); } }




/* ========= ALMOX2026 ‚Ä¢ BASE OFFLINE (Fase 1) =========
   Objetivo: modais SEMPRE abrem + importar JSON + listar + editar + salvar.
*/
"use strict";

const KEY_PROD = "ALMOX2026_PROD_BASE_V1";
const KEY_MOV  = "ALMOX2026_MOV_BASE_V1";

const SETORES = [
  "ALMOXARIFADO",
  "ADMINISTRA√á√ÉO","AGRICULTURA","DESENV SOCIAL","BOMBEIROS","COMPRAS","CONSELHO TUTELAR","CRAS","CREAS","CRIAN√áA FELIZ",
  "CULTURA","DESENV REGIONAL","EDUCA√á√ÉO","ESPA√áO AMIGO","ESPORTE","FINAN√áAS","GABINETE","GEST√ÉO PESSOAL","LAR DO ANCI√ÉO",
  "LICITA√á√ÉO","LIMPEZA P√öBLICA","MEIO AMBIENTE","MERENDAS","OBRAS E INFRA","POUPATEMPO","PROCURADORIA","RH","SA√öDE",
  "TERCEIRO SETOR","TR√ÇNSITO","TRANSPORTE","TRIBUTA√á√ÉO","TURISMO","VIGIL√ÇNCIA SANIT√ÅRIA"
];

let movs = banco.movimentacoes; let movProdutoIndex = -1; // √≠ndice do produto selecionado para movimenta√ß√£o


let banco = { produtos: [], movimentacoes: [] };
let produtos = banco.produtos;
let editIndex = -1;

const $ = (id)=>document.getElementById(id);

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}

/* ---- Modais (100% independentes) ---- */
function abrirModal(id){
  const m=$(id); if(!m) return;
  m.classList.add("active");
  m.setAttribute("aria-hidden","false");
}
function fecharModal(id){
  const m=$(id); if(!m) return;
  m.classList.remove("active");
  m.setAttribute("aria-hidden","true");
}

// Fecha por bot√£o, ou clicando fora do sheet
document.addEventListener("click",(e)=>{
  const close = e.target.closest?.("[data-close]");
  if(close){ fecharModal(close.getAttribute("data-close")); }
  if(e.target.classList?.contains("modal")){ e.target.classList.remove("active"); }
});

/* ---- Nav ---- */
$("\1")?.addEventListener("click",()=>abrirModal("modalDados"));

$("\1")?.addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  prepararMovimentacao();
  renderMovList();
  abrirModal("modalMov");
});

/* ---- Relat√≥rios ---- */
$("\1")?.addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderFiltrosRel();
  $("rOut").innerHTML = "";
  abrirModal("modalRel");
});

// Tabs de relat√≥rios (mudan√ßa instant√¢nea)
document.addEventListener("click",(e)=>{
  const b = e.target && e.target.closest ? e.target.closest(".rt-tab") : null;
  if(!b) return;
  const t = b.getAttribute("data-rt");
  if(!t) return;
  document.querySelectorAll("#modalRel .rt-tab").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  $("rTipo").value = t;
  renderFiltrosRel();
  $("rOut").innerHTML = "";
  lastPDFHtml = "";
});



$("\1")?.addEventListener("change",renderFiltrosRel);

function renderFiltrosRel(){
  const tipo = $("rTipo").value;
  const box = $("rFiltros");
  const pad = (s)=>escapeHtml(s);
  const setoresOpts = SETORES.map(s=>`<option value="${pad(s)}">${pad(s)}</option>`).join("");

  if(tipo==="movsetor"){
    box.innerHTML = `
      <div class="twocol">
        <div class="group">
          <label>Setor</label>
          <select id="rSetor">${setoresOpts}</select>
        </div>
        <div class="group">
          <label>Dire√ß√£o</label>
          <select id="rDir">
            <option value="ambos">Entradas e sa√≠das</option>
            <option value="entradas">Somente entradas</option>
            <option value="saidas">Somente sa√≠das</option>
          </select>
        </div>
      </div>
      <div class="twocol">
        <div class="group">
          <label>De (dd/mm/aaaa)</label>
          <input id="rDeBR" placeholder="01/01/2026" inputmode="numeric" />
        </div>
        <div class="group">
          <label>At√© (dd/mm/aaaa)</label>
          <input id="rAteBR" placeholder="31/12/2026" inputmode="numeric" />
        </div>
      </div>
      <div class="muted">Dica: filtre por per√≠odo e gere o PDF.</div>
    `;
    return;
  }

  box.innerHTML = `
    <div class="twocol">
      <div class="group">
        <label>De (dd/mm/aaaa)</label>
        <input id="rDeBR" placeholder="01/01/2026" inputmode="numeric" />
      </div>
      <div class="group">
        <label>At√© (dd/mm/aaaa)</label>
        <input id="rAteBR" placeholder="31/12/2026" inputmode="numeric" />
      </div>
    </div>
    <div class="group">
      <label>Buscar (opcional)</label>
      <input id="rBusca" placeholder="produto, c√≥digo, setor..." />
    </div>
  `;
}


function brDateTime(dt){
  const d = (dt instanceof Date) ? dt : new Date(dt);
  const pad = (n)=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function brDate(dt){
  const d = (dt instanceof Date) ? dt : new Date(dt);
  const pad = (n)=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
}
function brDateTime(dt){
  const d = (dt instanceof Date) ? dt : new Date(dt);
  const pad = (n)=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function ptbrToDate(s){
  // s: "dd/mm/aaaa, hh:mm:ss" or "dd/mm/aaaa hh:mm"
  if(!s) return null;
  const m = String(s).match(/^(\d{2})\/(\d{2})\/(\d{4})/);
  if(!m) return null;
  const dd=+m[1], mm=+m[2]-1, yy=+m[3];
  // try time
  const t = String(s).match(/(\d{2}):(\d{2})(?::(\d{2}))?/);
  const hh=t?+t[1]:0, mi=t?+t[2]:0, ss=t&&t[3]?+t[3]:0;
  return new Date(yy,mm,dd,hh,mi,ss);
}

function buildReportCard(title, subtitle, tableHTML){
  return `
    <div class="rt-card">
      <div class="rt-title">${escapeHtml(title)}</div>
      <div class="rt-sub">${escapeHtml(subtitle)}</div>
      ${tableHTML}
    </div>
  `;
}

function tableFromRows(cols, rows){
  const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr></thead>`;
  const tbody = rows.length
    ? `<tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${r[c] ?? ""}</td>`).join("")}</tr>`).join("")}</tbody>`
    : `<tbody><tr><td colspan="${cols.length}" class="muted" style="padding:12px">Nenhum registro.</td></tr></tbody>`;
  return `<table class="rt-table">${thead}${tbody}</table>`;
}

/* ---- Template de PDF (modelo moderno) ---- */
let lastPDFHtml = "";
let lastPDFName = "relatorio";

function buildPrintableDoc({title, subtitle, bodyHTML}){
  const now = new Date().toLocaleString("pt-BR");
  // IMPORTANTE (Android/Chrome): N√ÉO usar tags <script> dentro desta string,
  // pois isso pode encerrar o <script> principal do app e imprimir c√≥digo na tela.
  // Para disparar o PDF, usamos onload no <body>.
  return `<!doctype html><html lang="pt-BR"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHtml(title)}</title>
<style>
:root{--pri:#00d4ff;--sec:#7c3aed;--line:#e7e9f4;--mut:#5b6288;}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; color:#111; background:#fff}
.wrap{padding:14mm 12mm 18mm}
.hdr{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;border-bottom:3px solid #0b0d18;padding-bottom:10px;margin-bottom:12px}
.brand{display:flex;flex-direction:column;gap:4px}
.brand .app{font-weight:950;font-size:18px;letter-spacing:.2px}
.title{font-weight:950;font-size:20px;margin:0}
.subtitle{font-weight:800;font-size:12px;color:var(--mut);margin-top:6px}
.meta{font-size:11px;color:var(--mut);font-weight:800;text-align:right}
table{width:100%;border-collapse:collapse;font-size:11px}
thead th{padding:10px 8px;text-align:left;background:linear-gradient(135deg,var(--pri),var(--sec));color:#061018;font-weight:950}
tbody td{padding:8px;border-bottom:1px solid var(--line);vertical-align:top}
tbody tr:nth-child(even){background:#f6f7fb}
.card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px}
.footer{position:fixed;left:0;right:0;bottom:0;padding:6mm 12mm;font-size:11px;color:var(--mut);display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--line);background:#fff}
.pnum{font-weight:900}
.pnum::after{content:"P√°gina " counter(page) " de " counter(pages);}
@page{margin:14mm 12mm 18mm}
</style></head>
<body onload="setTimeout(function(){window.print();},250)">
<div class="wrap">
  <div class="hdr">
    <div class="brand">
      <div class="app">ALMOX2026</div>
      <div class="title">${escapeHtml(title)}</div>
      <div class="subtitle">${escapeHtml(subtitle||"")}</div>
    </div>
    <div class="meta">
      <div><b>Gerado:</b> ${escapeHtml(now)}</div>
      <div>Modo offline</div>
    </div>
  </div>
  ${bodyHTML}
</div>
<div class="footer">
  <div class="pnum"></div>
  <div>ALMOX2026 ‚Ä¢ Relat√≥rio</div>
</div>
</body></html>`;
}

function openPrintWindow(html, name){
  const w = window.open("", "_blank");
  if(!w){ toast("‚ö†Ô∏è Pop-up bloqueado"); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

/* ---- Gerar relat√≥rios ---- */
$("\1")?.addEventListener("click",()=>{
  const tipo = $("rTipo").value;
  const out = $("rOut");

  const toDate = (br)=>{
    const m = String(br||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return null;
    return new Date(+m[3], +m[2]-1, +m[1], 0,0,0);
  };
  const de = toDate($("rDeBR")?.value);
  const ate = toDate($("rAteBR")?.value);
  const ateEnd = ate ? new Date(ate.getFullYear(), ate.getMonth(), ate.getDate(), 23,59,59) : null;

  const norm = (s)=>String(s||"").toLowerCase();
  const busca = norm($("rBusca")?.value);

  let list = movs.slice().reverse().filter(m=>{
    const dt = m.quandoISO ? new Date(m.quandoISO) : ptbrToDate(m.quando);
    if(de && (!dt || dt<de)) return false;
    if(ateEnd && (!dt || dt>ateEnd)) return false;
    if(busca){
      const hay = `${m.produto_nome||""} ${m.codigo2||""} ${m.origem||""} ${m.destino||""} ${m.obs||""}`.toLowerCase();
      if(!hay.includes(busca)) return false;
    }
    return true;
  });

  let subt = "Registro de entradas e sa√≠das";
  if(tipo==="movsetor"){
    const setor = $("rSetor")?.value || "ALMOXARIFADO";
    const dir = $("rDir")?.value || "ambos";
    subt = `${setor} ‚Ä¢ ${$("rDir")?.selectedOptions?.[0]?.textContent||""}`;
    list = list.filter(m=>{
      let ok = (m.origem===setor || m.destino===setor);
      if(dir==="entradas") ok = (m.destino===setor);
      if(dir==="saidas") ok = (m.origem===setor);
      return ok;
    });
  }

  const titulo = (tipo==="movsetor") ? `Movimenta√ß√µes por Setor` : `Movimenta√ß√µes (Geral)`;
  const periodo = `${$("rDeBR")?.value||"‚Äî"} at√© ${$("rAteBR")?.value||"‚Äî"}`;

  const rows = list.map(m=>{
    const dt = m.quandoISO ? new Date(m.quandoISO) : ptbrToDate(m.quando);
    const quando = dt ? brDate(dt) : (m.quando||"");
    return `
      <tr>
        <td>${escapeHtml(quando)}</td>
        <td><b>${escapeHtml(m.produto_nome||"")}</b><div class="muted">C√≥digo: ${escapeHtml(m.codigo2||"")}</div></td>
        <td>${escapeHtml(m.origem||"")}</td>
        <td>${escapeHtml(m.destino||"")}</td>
        <td style="text-align:right"><b>${escapeHtml(String(m.qtd||0))}</b></td>
        <td>${escapeHtml(m.obs||"")}</td>
      </tr>
    `;
  }).join("");

  const body = `
    <div class="rel-card">
      <div class="rel-top">
        <div>
          <div class="rel-title">üìÑ ${escapeHtml(titulo)}</div>
          <div class="rel-sub">${escapeHtml(subt)} ‚Ä¢ Per√≠odo: ${escapeHtml(periodo)}</div>
        </div>
        <div class="rel-chip">${list.length} registros</div>
      </div>

      <table class="rel-table">
        <thead>
          <tr>
            <th>Data/Hora</th><th>Produto</th><th>Origem</th><th>Destino</th><th style="text-align:right">Qtd</th><th>Obs</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="6" class="muted" style="padding:14px">Nenhuma movimenta√ß√£o no per√≠odo.</td></tr>`}</tbody>
      </table>
    </div>
  `;

  out.innerHTML = body;
  lastPDFHtml = buildPDFHtml(titulo, subt, periodo, body);
});

$("\1")?.addEventListener("click",()=>{
  if(!lastPDFHtml){ toast("‚ö†Ô∏è Gere um relat√≥rio primeiro"); return; }
  openPrintWindow(lastPDFHtml, lastPDFName);
});

$("\1")?.addEventListener("click",()=>{
  $("rOut").innerHTML = "";
  lastPDFHtml = "";
  toast("üßπ Limpo");
});

/* ========= Gest√£o de Setores ========= */
let setorAtual = "ADMINISTRA√á√ÉO";
let lastSetPDFHtml = "";

$("\1")?.addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderSetores();
  abrirModal("modalSet");
});

$("sBusca")?.addEventListener("input", ()=>renderSetores());

function setorStats(setor){
  // saldo no setor (soma das aloca√ß√µes) + n¬∫ de movimenta√ß√µes (entradas/sa√≠das)
  let saldo = 0;
  for(const p of produtos){
    const al = (p.alocacoes && typeof p.alocacoes==="object") ? p.alocacoes : null;
    if(al && al[setor]) saldo += Number(al[setor])||0;
  }
  const movCount = movs.filter(m=>m.origem===setor || m.destino===setor).length;
  return {saldo, movCount};
}

function renderSetores(){
  const q = ($("sBusca")?.value || "").trim().toLowerCase();
  const grid = $("setGrid");
  if(!grid) return;
  grid.innerHTML = "";

  const list = SETORES.filter(s=>{
    if(!q) return true;
    return s.toLowerCase().includes(q);
  });

  // ordena por saldo desc, depois nome
  const enriched = list.map(s=>({s, ...setorStats(s)}))
    .sort((a,b)=> (b.saldo-a.saldo) || a.s.localeCompare(b.s,'pt-BR'));

  enriched.forEach(({s, saldo, movCount})=>{
    const card = document.createElement("div");
    card.className = "set-card";
    card.innerHTML = `
      <div class="set-top">
        <div class="set-name">${escapeHtml(s)}</div>
        <div class="set-chip">Mov: <span class="set-num">${movCount}</span></div>
      </div>
      <div class="set-sub">Saldo no setor: <span class="set-num">${saldo}</span></div>
    `;
    card.addEventListener("click", ()=>abrirSetorDetalhe(s));
    grid.appendChild(card);
  });

  if(!enriched.length){
    grid.innerHTML = `<div class="rt-card" style="grid-column:1/-1"><div class="rt-title">Nenhum setor encontrado</div></div>`;
  }
}

function abrirSetorDetalhe(setor){
  setorAtual = setor;
  $("sdTitle").textContent = `üèõÔ∏è ${setor}`;
  // defaults: hoje
  const d = new Date(); const pad=n=>String(n).padStart(2,"0");
  const hoje = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  $("sdDe").value = hoje;
  $("sdAte").value = hoje;
  $("sdDir").value = "ambos";
  $("sdOut").innerHTML = "";
  $("sdResumo").innerHTML = "";
  lastSetPDFHtml = "";
  fecharModal("modalSet");
  abrirModal("modalSetDet");
  gerarRelSetor(); // gera automaticamente
}

function gerarRelSetor(){
  // filtros
  const deBR = ($("sdDeBR")?.value || "").trim();
  const ateBR = ($("sdAteBR")?.value || "").trim();
  const dir = $("sdDir").value || "ambos";

  const toDate = (br, end=false)=>{
    const m = br.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) return null;
    return end
      ? new Date(+m[3], +m[2]-1, +m[1], 23,59,59)
      : new Date(+m[3], +m[2]-1, +m[1], 0,0,0);
  };

  const de = toDate(deBR,false);
  const ate = toDate(ateBR,true);

  const list = movs.slice().reverse().filter(m=>{
    const dt = m.quandoISO ? new Date(m.quandoISO) : ptbrToDate(m.quando);
    if(de && (!dt || dt<de)) return false;
    if(ate && (!dt || dt>ate)) return false;

    // por setor
    let oks = (m.origem===setorAtual || m.destino===setorAtual);
    if(dir==="entradas") oks = (m.destino===setorAtual);
    if(dir==="saidas") oks = (m.origem===setorAtual);
    if(!oks) return false;

    return true;
  });

  const rows = list.map(m=>{
    const dt = m.quandoISO ? new Date(m.quandoISO) : ptbrToDate(m.quando);
    const dataSaida = dt ? brDate(dt) : (String(m.quando||"").slice(0,10));
    const tipo = (m.origem===setorAtual) ? "SA√çDA" : (m.destino===setorAtual ? "ENTRADA" : "");
    return `
      <tr>
        <td>${escapeHtml(dataSaida)}</td>
        <td class="muted">${escapeHtml(tipo)}</td>
        <td><b>${escapeHtml(m.produto_nome||"")}</b><div class="muted">C√≥digo: ${escapeHtml(m.codigo2||"")}</div></td>
        <td>${escapeHtml(m.origem||"")}</td>
        <td>${escapeHtml(m.destino||"")}</td>
        <td style="text-align:right"><b>${escapeHtml(String(m.qtd||0))}</b></td>
        <td>${escapeHtml(m.obs||"")}</td>
      </tr>
    `;
  }).join("");

  const periodoTxt = `${deBR||"‚Äî"} a ${ateBR||"‚Äî"}`;

  const body = `
    <div class="rt-card" style="margin-top:12px">
      <div class="rt-title" style="margin:0 0 6px 0">üìÑ Movimenta√ß√µes do Setor ‚Ä¢ ${escapeHtml(setorAtual)}</div>
      <div class="rt-sub">Per√≠odo: ${escapeHtml(periodoTxt)} ‚Ä¢ Registros: ${list.length}</div>

      <table class="rt-table" style="margin-top:12px">
        <thead>
          <tr>
            <th>Data</th><th>Tipo</th><th>Produto</th><th>Origem</th><th>Destino</th><th style="text-align:right">Qtd</th><th>Obs</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="7" class="muted" style="padding:12px">Nenhuma movimenta√ß√£o no per√≠odo.</td></tr>`}</tbody>
      </table>
    </div>
  `;

  $("sdResumo").innerHTML = body;

  const titulo = `Movimenta√ß√µes do Setor - ${setorAtual}`;
  const subt = `Setor: ${setorAtual} ‚Ä¢ Per√≠odo: ${periodoTxt}`;
  lastPDFHtml = buildPDFHtml(titulo, subt, periodoTxt, body);
}

$("\1")?.addEventListener("click", gerarRelSetor);

$("\1")?.addEventListener("click", ()=>{
  if(!lastSetPDFHtml){ toast("‚ö†Ô∏è Gere primeiro"); return; }
  openPrintWindow(lastSetPDFHtml, "setor_"+setorAtual);
});

$("\1")?.addEventListener("click", ()=>{
  fecharModal("modalSetDet");
  renderSetores();
  abrirModal("modalSet");
});



$("\1")?.addEventListener("click",()=>{ window.scrollTo({top:0,behavior:"smooth"}); toast("üì¶ Estoque"); });

/* ---- Persist√™ncia ---- */
function save(){
  try{
    // garante refer√™ncias
    banco.produtos = produtos;
    banco.movimentacoes = movs;
    banco.exportado_em = new Date().toISOString();
    localStorage.setItem(DBKEY, JSON.stringify(banco));
  }catch(e){
    console.error(e);
  }
}
function load(){
  const raw = localStorage.getItem(DBKEY);
  if(!raw){ banco = {produtos:[], movimentacoes:[]}; produtos = banco.produtos; movs = banco.movimentacoes; return; }
  try{
    const obj = JSON.parse(raw);
    const parsed = parseBD(obj) || {produtos:[], movimentacoes:[]};
    banco = parsed;
    produtos = banco.produtos;
    movs = banco.movimentacoes;
  }catch(e){
    console.error(e);
    banco = {produtos:[], movimentacoes:[]};
    produtos = banco.produtos; movs = banco.movimentacoes;
  }
}

/* ---- Normaliza√ß√£o compat√≠vel com seu JSON ---- */

function parseBD(raw){
  // aceita: {produtos:[...], movimentacoes:[...]} OU {produtos:[...]} OU [...]
  if(Array.isArray(raw)){
    return { produtos: raw, movimentacoes: [] };
  }
  if(raw && typeof raw === "object"){
    const produtosArr = Array.isArray(raw.produtos) ? raw.produtos : (Array.isArray(raw.Produtos) ? raw.Produtos : null);
    if(produtosArr){
      const movArr = Array.isArray(raw.movimentacoes) ? raw.movimentacoes
                  : (Array.isArray(raw.movimenta√ß√µes) ? raw.movimenta√ß√µes : []);
      return { produtos: produtosArr, movimentacoes: movArr };
    }
  }
  return null;
}

function parseInputJSON(data){
  if(Array.isArray(data)){
    // suporte ao formato antigo estranho
    if(data.length>=4 && data[1]==="produtos" && String(data[2]).trim()===":" && Array.isArray(data[3])) return data[3];
    return data;
  }
  if(data && typeof data==="object"){
    if(Array.isArray(data.produtos)) return data.produtos;
    if(Array.isArray(data.Produtos)) return data.Produtos;
    if(Array.isArray(data.itens)) return data.itens;
    if(Array.isArray(data.items)) return data.items;
    if(Array.isArray(data.data)) return data.data;
  }
  return null;
}

function normalizeProduto(p){
  const o = {...p};
  o.codigo1 = o.codigo1 ?? o.id ?? "NULL";
  o.codigo2 = o.codigo2 ?? o.sku ?? "";
  o.nome = String(o.nome ?? "").trim();
  o.estoqueAtual = Number(o.estoqueAtual ?? o.estoque_atual ?? 0) || 0;
  o.estoqueMin   = Number(o.estoqueMin ?? o.estoque_minimo ?? 0) || 0;
  o.preco        = Number(o.preco ?? o.preco_custo ?? 0) || 0;
  o.setor        = o.setor || "ALMOXARIFADO";
  o.categoria    = o.categoria ?? o.classificacao ?? "SEM CLASSIFICA√á√ÉO";
  o.descricao    = o.descricao ?? "";
  return o;
}

function categoriasUnicas(){
  const s = new Set(produtos.map(p=>p.categoria).filter(Boolean));
  return Array.from(s).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
}

/* ---- UI Estoque ---- */

function normTxt(s){
  try{
    return String(s||"")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();
  }catch(_){
    return String(s||"").toLowerCase().trim();
  }
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function statusProduto(p){
  const a=p.estoqueAtual||0, m=p.estoqueMin||0;
  if(a===0) return {cls:"zero", txt:"ZERADO"};
  if(a<=m) return {cls:"low", txt:"BAIXO"};
  return {cls:"ok", txt:"OK"};
}

function updateStats(){
  let ok=0, low=0, zero=0;
  for(const p of produtos){
    const st=statusProduto(p).cls;
    if(st==="ok") ok++; else if(st==="low") low++; else zero++;
  }
  $("statTotal").textContent = produtos.length;
  $("statOk").textContent = ok;
  $("statLow").textContent = low;
  $("statZero").textContent = zero;
}

function render(){
  const q = ($("q").value||"").toLowerCase().trim();
  const list = !q ? produtos : produtos.filter(p=>{
    const hay = `${p.nome} ${p.codigo1} ${p.codigo2} ${p.categoria}`.toLowerCase();
    return hay.includes(q);
  });

  const grid=$("grid");
  grid.innerHTML="";

  if(produtos.length===0){
    grid.innerHTML = `<div class="card"><div style="font-weight:950">Importe seu JSON em üíæ Dados.</div><div class="muted" style="margin-top:8px">Depois disso, tudo funciona offline.</div></div>`;
    updateStats();
    return;
  }
  if(list.length===0){
    grid.innerHTML = `<div class="card"><div style="font-weight:950">Nenhum resultado.</div><div class="muted" style="margin-top:8px">Tente outro termo.</div></div>`;
    updateStats();
    return;
  }

  list.forEach(p=>{
    const st=statusProduto(p);
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="row">
        <div>
          <div class="code">${escapeHtml(p.codigo2||p.codigo1||"-")}</div>
          <div class="muted" style="margin-top:2px;font-size:12px">${escapeHtml(p.codigo1 && p.codigo1!=="NULL" ? "("+p.codigo1+")" : "")}</div>
        </div>
        <div class="cat">${escapeHtml(p.categoria||"")}</div>
      </div>
      <div class="name">${escapeHtml(p.nome||"-")}</div>
      <div class="meta">
        <div class="box">
          <div class="lbl">ESTOQUE</div>
          <div class="val">${p.estoqueAtual||0} / ${p.estoqueMin||0}</div>
        </div>
        <div class="box">
          <div class="lbl">PRE√áO</div>
          <div class="val">R$ ${(Number(p.preco)||0).toFixed(2)}</div>
        </div>
      </div>
      <div class="status">
        <div class="muted" style="font-weight:900">${escapeHtml(p.setor||"ALMOXARIFADO")}</div>
        <div class="badge ${st.cls}">${st.txt}</div>
      </div>
    `;
    card.addEventListener("click",()=>openEdit(p));
    grid.appendChild(card);
  });

  updateStats();
}

/* ---- Editar produto ---- */
function openEdit(p){
  editIndex = produtos.indexOf(p);
  if(editIndex<0) return;

  const catList = categoriasUnicas();
  $("pCategoria").innerHTML = (catList.length ? catList : ["SEM CLASSIFICA√á√ÉO"])
    .map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

  $("pCodigo1").value = p.codigo1 ?? "";
  $("pCodigo2").value = p.codigo2 ?? "";
  $("pNome").value    = p.nome ?? "";
  $("pCategoria").value = p.categoria ?? (catList[0]||"SEM CLASSIFICA√á√ÉO");
  $("pAtual").value   = p.estoqueAtual ?? 0;
  $("pMin").value     = p.estoqueMin ?? 0;
  $("pPreco").value   = p.preco ?? 0;
  $("pDesc").value    = p.descricao ?? "";

  abrirModal("modalProduto");
}

$("\1")?.addEventListener("click",()=>{
  if(editIndex<0) return;
  const p = produtos[editIndex];

  p.codigo1 = $("pCodigo1").value.trim() || "NULL";
  p.codigo2 = $("pCodigo2").value.trim();
  p.nome = $("pNome").value.trim();
  p.categoria = $("pCategoria").value;
  p.estoqueAtual = Math.max(0, parseInt($("pAtual").value,10)||0);
  p.estoqueMin = Math.max(0, parseInt($("pMin").value,10)||0);
  p.preco = Math.max(0, parseFloat($("pPreco").value)||0);
  p.descricao = $("pDesc").value;

  save();
  fecharModal("modalProduto");
  toast("‚úÖ Produto salvo");
  render();
});

$("\1")?.addEventListener("click",()=>{
  if(editIndex<0) return;
  if(!confirm("Deletar este produto?")) return;
  produtos.splice(editIndex,1);
  editIndex=-1;
  save();
  fecharModal("modalProduto");
  toast("üóëÔ∏è Deletado");
  render();
});

/* ---- Dados: importar/exportar/reset ---- */
(function bindDados(){
  const btnImport = $("btnImport");
  const fileInput = $("fileInput");
  const btnExport = $("btnExport");
  const btnExportCSV = $("btnExportCSV");
  const btnReset = $("btnReset");

  if(btnImport && fileInput){
document.getElementById("btnImport")?.addEventListener("click",()=> fileInput.click());
document.getElementById("fileInput")?.addEventListener("change",(e)=>{
      const file = (e.target && e.target.files) ? e.target.files[0] : null;
      if(!file) return;

      const r = new FileReader();
      r.onload = ()=>{
        try{
          const raw = String(r.result || "").replace(/^\uFEFF/, "").trim();
          const data = JSON.parse(raw);

          // Aceita: [ ... ], {produtos:[...]}, ou formato antigo especial
          const arr = parseInputJSON(data);
          if(!arr || !Array.isArray(arr)){
            toast("‚ö†Ô∏è JSON inv√°lido (n√£o achei lista de produtos)");
            return;
          }

          produtos = arr.map(normalizeProduto);

          // movimenta√ß√µes embutidas (se existirem)
          movs = Array.isArray(data?.movimentacoes) ? data.movimentacoes
               : Array.isArray(data?.movs) ? data.movs
               : [];

          save();
          toast(`‚úÖ Importado: ${produtos.length} itens`);
          fecharModal("modalDados");
          render();

          window.__lastJsonName = file.name || "dados.json";
          updateLinkedStatus();
        }catch(err){
          console.error("Import JSON error:", err);
          toast("‚ùå Erro ao importar: " + (err && err.message ? err.message : "falha"));
        }
      };
      r.readAsText(file, "utf-8");
      e.target.value="";
    });
  }

  if(btnExport){
document.getElementById("btnExport")?.addEventListener("click",()=>{
      const payload = { produtos, movimentacoes: movs, exportado_em: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (window.__lastJsonName && /\.json$/i.test(window.__lastJsonName))
        ? window.__lastJsonName.replace(/\.json$/i,"_ATUALIZADO.json")
        : "ALMOX2026_ATUALIZADO.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("üì§ JSON exportado");
    });
  }

  if(btnExportCSV){
document.getElementById("btnExportCSV")?.addEventListener("click",()=>{
      if(!Array.isArray(produtos) || produtos.length===0){ toast("‚ö†Ô∏è Nada para exportar"); return; }
      const headers = ["codigo1","codigo2","codigo7","nome","categoria","ncm","estoqueAtual","estoqueMin","preco","setor"];
      const rows = produtos.map(p=>{
        const obj = {
          codigo1: p.codigo1 ?? "",
          codigo2: p.codigo2 ?? "",
          codigo7: p.codigo7 ?? "",
          nome: p.nome ?? "",
          categoria: p.categoria ?? "",
          ncm: p.ncm ?? "",
          estoqueAtual: p.estoqueAtual ?? 0,
          estoqueMin: p.estoqueMin ?? 0,
          preco: p.preco ?? 0,
          setor: p.setor ?? "ALMOXARIFADO"
        };
        return headers.map(h=>{
          const v = (obj[h] ?? "").toString();
          return '"' + v.replace(/"/g,'""') + '"';
        }).join(",");
      });
      const csv = headers.join(",") + "\n" + rows.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ALMOX2026_PRODUTOS.csv";
      a.click();
      URL.revokeObjectURL(url);
      toast("‚úÖ CSV exportado");
    });
  }

  if(btnReset){
document.getElementById("btnReset")?.addEventListener("click",()=>{
      if(!confirm("Limpar dados do aparelho?")) return;
      localStorage.removeItem(KEY_PROD);
      localStorage.removeItem(KEY_MOV);
      produtos=[]; movs=[];
      render();
      toast("üßπ Limpo");
      updateLinkedStatus();
    });
  }
})();

/* ---- Vincular/Salvar no mesmo arquivo (File System Access API) ---- */
const FS_DB = "ALMOX2026_FS_DB_V1";
const FS_STORE = "handles";

function fsOpenDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(FS_DB, 1);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(FS_STORE)) db.createObjectStore(FS_STORE);
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function fsGet(key){
  const db = await fsOpenDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(FS_STORE,"readonly");
    const st = tx.objectStore(FS_STORE);
    const rq = st.get(key);
    rq.onsuccess = ()=> resolve(rq.result || null);
    rq.onerror = ()=> reject(rq.error);
  });
}
async function fsSet(key,val){
  const db = await fsOpenDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(FS_STORE,"readwrite");
    tx.objectStore(FS_STORE).put(val, key);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}
async function fsDel(key){
  const db = await fsOpenDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(FS_STORE,"readwrite");
    tx.objectStore(FS_STORE).delete(key);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}

async function updateLinkedStatus(){
  const statusEl = document.getElementById("dbFileStatus");
  const btnSave = document.getElementById("btnSaveToLinked");
  const btnLink = document.getElementById("btnLinkFile");
  if(!statusEl || !btnSave || !btnLink) return;

  const supported = !!window.showOpenFilePicker && !!window.FileSystemFileHandle;
  if(!supported){
    statusEl.textContent = "Seu navegador n√£o suporta salvar no mesmo arquivo. Use: Exportar JSON.";
    btnSave.disabled = true;
    btnLink.disabled = true;
    return;
  }

  try{
    const handle = await fsGet("jsonFile");
    if(handle){
      statusEl.textContent = "Arquivo vinculado. Voc√™ pode salvar no mesmo arquivo.";
      btnSave.disabled = false;
    }else{
      statusEl.textContent = "Nenhum arquivo vinculado.";
      btnSave.disabled = true;
    }
  }catch{
    statusEl.textContent = "N√£o foi poss√≠vel ler o arquivo vinculado.";
    btnSave.disabled = true;
  }
}

async 
/* ========= Fase 2: Movimenta√ß√µes =========

   Modelo de controle:
   - Origem ALMOXARIFADO: baixa estoqueAtual e credita saldo do setor (alocacoes[setor])
   - Origem SETOR: baixa alocacoes[origem] e credita alocacoes[destino]
   As aloca√ß√µes ficam dentro do produto, assim voc√™ consegue ver "o que foi transferido" depois.
*/
function ensureAloc(p){
  if(!p.alocacoes || typeof p.alocacoes !== "object") p.alocacoes = {};
  return p.alocacoes;
}
function prepararMovimentacao(){
  // preenche selects
  const opt = SETORES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  $("mOrig").innerHTML = opt;
  $("mDest").innerHTML = opt;
  $("mOrig").value = "ALMOXARIFADO";
  $("mDest").value = "ADMINISTRA√á√ÉO";
  $("mItem").value = "";
  $("mObs").value = "";
  $("mQtd").value = "1";
  movProdutoIndex = -1;

  // datetime default
  const now = new Date();
  const pad=(n)=>String(n).padStart(2,"0");
  const v = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
  $("mQuando").value = v;

  $("mSug").style.display = "none";
  $("mSug").innerHTML = "";
}

function sugRender(indices, q){
  const box = $("mSug");
  if(!indices.length){ box.style.display="none"; box.innerHTML=""; const c=$("mSugCount"); if(c){c.style.display="none"; c.textContent="";} return; }
  box.style.display="block"; const c=$("mSugCount"); if(c){c.style.display="block"; c.textContent=`Sugest√µes: ${indices.length}`;}
  const esc = (x)=>escapeHtml(x);
  const qrx = q ? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),"ig") : null;
  sugCursor = -1;
  box.innerHTML = indices.slice(0,25).map(idx=>{
    const p = produtos[idx];
    const name = String(p.nome||"");
    const hi = qrx ? esc(name).replace(qrx, m=>`<strong>${m}</strong>`) : esc(name);
    const alm = Number(p.estoqueAtual)||0;
    return `<div class="sug-item" data-idx="${idx}">
      <div class="sug-title">${hi}</div>
      <div class="sug-sub">${esc(p.categoria||"")} ‚Ä¢ Almox: <b>${alm}</b></div>
    </div>`;
  }).join("");

  box.querySelectorAll(".sug-item").forEach(el=>{
    el.addEventListener("click",()=>{
      const idx = parseInt(el.getAttribute("data-idx"),10);
      selectMovProduto(idx);
    });
  });
}

function selectMovProduto(idx){
  movProdutoIndex = idx;
  $("mItem").value = produtos[idx].nome || "";
  $("mSug").style.display="none";
}

let sugCursor = -1;
function getSugItems(){
  return Array.from($("mSug")?.querySelectorAll(".sug-item")||[]);
}
function paintSugCursor(){
  const items = getSugItems();
  items.forEach((el,i)=>el.classList.toggle("active", i===sugCursor));
  if(items[sugCursor]) items[sugCursor].scrollIntoView({block:"nearest"});
}
function moveSugCursor(delta){
  const items = getSugItems();
  if(!items.length) return;
  sugCursor = Math.max(0, Math.min(items.length-1, sugCursor + delta));
  paintSugCursor();
}
function pageSug(deltaPages){
  const items = getSugItems();
  if(!items.length) return;
  const step = 6;
  sugCursor = (sugCursor<0)?0:sugCursor;
  sugCursor = Math.max(0, Math.min(items.length-1, sugCursor + step*deltaPages));
  paintSugCursor();
}

$("mItem")?.addEventListener("keydown",(e)=>{
  const items = getSugItems();
  if(!items.length) return;

  if(e.key==="ArrowDown"){ e.preventDefault(); if(sugCursor<0) sugCursor=0; else moveSugCursor(1); }
  else if(e.key==="ArrowUp"){ e.preventDefault(); if(sugCursor<0) sugCursor=0; else moveSugCursor(-1); }
  else if(e.key==="PageDown"){ e.preventDefault(); pageSug(1); }
  else if(e.key==="PageUp"){ e.preventDefault(); pageSug(-1); }
  else if(e.key==="Enter"){
    e.preventDefault();
    const el = items[sugCursor>=0?sugCursor:0];
    if(el){
      const idx = parseInt(el.getAttribute("data-idx"),10);
      selectMovProduto(idx);
    }
  } else if(e.key==="Escape"){
    $("mSug").style.display="none"; $("mSug").innerHTML=""; sugCursor=-1;
  } else if(e.key==="Delete"){
    // se estiver com sugest√£o selecionada, limpa sele√ß√£o
    if(sugCursor>=0){ movProdutoIndex=-1; }
  }
});


$("mItem")?.addEventListener("input",()=>{
  const qRaw = $("mItem").value;
  const q = normTxt(qRaw);
  if(!q){ $("mSug").style.display="none"; $("mSug").innerHTML=""; const c=$("mSugCount"); if(c){c.style.display="none"; c.textContent="";} movProdutoIndex=-1; return; }

  const hits = [];
  for(let i=0;i<produtos.length;i++){
    const p=produtos[i];
    const hay = normTxt(`${p.nome||""} ${p.codigo1||""} ${p.codigo2||""} ${p.categoria||""} ${p.ncm||""}`);
    if(hay.includes(q)) hits.push(i);
    if(hits.length>=80) break;
  }
  sugRender(hits, qRaw);
});

$("btnGravarMov")?.addEventListener("click",()=>{
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON primeiro"); return; }
  if(movProdutoIndex<0){ toast("‚ö†Ô∏è Selecione um item"); return; }

  const qtd = Math.max(1, parseInt($("mQtd").value,10)||1);
  const origem = $("mOrig").value;
  const destino = $("mDest").value;
  if(origem===destino){ toast("‚ö†Ô∏è Origem = destino"); return; }

  const p = produtos[movProdutoIndex];

  const quandoRaw = $("mQuando").value;
  const dt = quandoRaw ? new Date(quandoRaw) : new Date();
  const quandoISO = dt.toISOString();
  const quando = brDateTime(dt);

  const mov = {
    id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"-"+Math.random().toString(16).slice(2),
    produto_idx: movProdutoIndex,
    produto_nome: p.nome,
    codigo2: p.codigo2,
    categoria: p.categoria,
    qtd, origem, destino,
    obs: $("mObs").value || "",
    quando,
    quandoISO
  };

  const r = applyMovToStock(mov);
  if(!r.ok){ toast("‚ùå "+(r.msg||"Falha ao aplicar")); return; }

  movs.push(mov);

  save();
  render();
  renderMovList();
  toast("‚úÖ Movimenta√ß√£o gravada");

  $("mItem").value = "";
  $("mObs").value = "";
  $("mQtd").value = "1";
  movProdutoIndex = -1;
});

function renderMovList(){
  const box = $("movList");
  if(!box) return;
  box.innerHTML = "";
  const last = movs.slice().reverse().slice(0,12);
  if(!last.length){
    box.innerHTML = `<div class="card" style="margin:0"><div class="muted" style="font-weight:900">Nenhuma movimenta√ß√£o.</div></div>`;
    return;
  }
  last.forEach(m=>{
    const div=document.createElement("div");
    div.className="card";
    div.style.margin="0 0 10px 0";
    div.style.cursor = "pointer";
    div.setAttribute("data-id", m.id || "");
    div.innerHTML = `
      <div class="row">
        <div style="font-weight:950">${escapeHtml(m.produto_nome||"-")}</div>
        <div class="muted" style="font-weight:900">${escapeHtml(m.quando||"")}</div>
      </div>
      <div class="muted" style="margin-top:6px;font-weight:900">
        Qtd: <b style="color:var(--pri)">${m.qtd}</b> ‚Ä¢ ${escapeHtml(m.origem)} ‚Üí ${escapeHtml(m.destino)}
      </div>
      ${m.obs ? `<div class="muted" style="margin-top:6px">${escapeHtml(m.obs)}</div>` : ""}
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" style="padding:8px 10px;font-size:12px" type="button">‚úèÔ∏è Editar / üóëÔ∏è Deletar</button>
      </div>
    `;
    div.addEventListener("click",(ev)=>{
      // se clicar no bot√£o ou no card, abre o editor
      const id = div.getAttribute("data-id");
      if(id) openMovEditById(id);
    });
    box.appendChild(div);
  });
}



/* --- Editar/Deletar movimenta√ß√µes (com revers√£o de estoque) --- */
let movEditId = null;

function resolveProdutoIndexFromMov(m){
  const idx = Number(m.produto_idx);
  if(Number.isInteger(idx) && idx>=0 && idx<produtos.length){
    // valida se bate com c√≥digo/nome para reduzir risco de √≠ndice "andar"
    const p = produtos[idx];
    if((m.codigo2 && p.codigo2===m.codigo2) || (m.produto_nome && p.nome===m.produto_nome)) return idx;
  }
  // fallback: tenta achar pelo c√≥digo2
  if(m.codigo2){
    const j = produtos.findIndex(p=>String(p.codigo2||"")===String(m.codigo2));
    if(j>=0) return j;
  }
  // fallback: tenta achar pelo nome
  if(m.produto_nome){
    const j = produtos.findIndex(p=>String(p.nome||"")===String(m.produto_nome));
    if(j>=0) return j;
  }
  return -1;
}

function revertMov(m){
  const idx = resolveProdutoIndexFromMov(m);
  if(idx<0) return {ok:false, msg:"Produto n√£o encontrado para reverter."};
  const p = produtos[idx];
  const qtd = Math.max(1, Number(m.qtd)||1);
  if(m.origem==="ALMOXARIFADO"){
    p.estoqueAtual = (Number(p.estoqueAtual)||0) + qtd;
    const al = ensureAloc(p);
    al[m.destino] = (Number(al[m.destino])||0) - qtd;
  }else{
    const al = ensureAloc(p);
    al[m.origem] = (Number(al[m.origem])||0) + qtd;
    al[m.destino] = (Number(al[m.destino])||0) - qtd;
  }
  return {ok:true};
}

function applyMovToStock(m){
  const idx = resolveProdutoIndexFromMov(m);
  if(idx<0) return {ok:false, msg:"Produto n√£o encontrado para aplicar."};
  const p = produtos[idx];
  const qtd = Math.max(1, Number(m.qtd)||1);

  if(m.origem===m.destino) return {ok:false, msg:"Origem = destino"};

  if(m.origem==="ALMOXARIFADO"){
    // Permite negativo (invent√°rio posterior)
    p.estoqueAtual = (Number(p.estoqueAtual)||0) - qtd;
    const al = ensureAloc(p);
    al[m.destino] = (Number(al[m.destino])||0) + qtd;
  }else{
    const al = ensureAloc(p);
    // Permite negativo no setor tamb√©m
    al[m.origem] = (Number(al[m.origem])||0) - qtd;
    al[m.destino] = (Number(al[m.destino])||0) + qtd;
  }
  return {ok:true};
}

function movToDatetimeLocal(quando){
  // tenta converter "pt-BR" ou ISO para datetime-local
  if(!quando) return "";
  // se j√° for yyyy-mm-ddThh:mm
  if(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(quando)) return quando.slice(0,16);
  // tenta parse pelo Date
  const d = new Date(quando);
  if(!isNaN(d.getTime())){
    const pad=(n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  // tenta parse simples pt-BR "dd/mm/aaaa, hh:mm:ss" ou "dd/mm/aaaa hh:mm"
  const m = String(quando).match(/(\d{2})\/(\d{2})\/(\d{4}).*?(\d{2}):(\d{2})/);
  if(m){
    const [_,dd,mm,yyyy,hh,mi]=m;
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  return "";
}

function formatWhenFromInput(v){
  if(!v) return brDateTime(new Date());
  return brDateTime(new Date(v));
}

function openMovEditById(id){
  const mov = movs.find(x=>x.id===id);
  if(!mov){ toast("‚ö†Ô∏è Movimenta√ß√£o n√£o encontrada"); return; }

  // preenche selects (mesmo conjunto)
  const opt = SETORES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  $("meOrig").innerHTML = opt;
  $("meDest").innerHTML = opt;

  movEditId = id;
  $("meItem").value = mov.produto_nome || "";
  $("meQtd").value = Number(mov.qtd)||1;
  $("meOrig").value = mov.origem || "ALMOXARIFADO";
  $("meDest").value = mov.destino || "ADMINISTRA√á√ÉO";
  $("meObs").value = mov.obs || "";
  $("meQuando").value = movToDatetimeLocal(mov.quando);

  const idx = resolveProdutoIndexFromMov(mov);
  const p = idx>=0 ? produtos[idx] : null;
  const alm = p ? (Number(p.estoqueAtual)||0) : 0;
  $("meInfo").textContent = p ? `Estoque atual no ALMOX: ${alm} ‚Ä¢ Classifica√ß√£o: ${p.categoria||""}` : "Produto n√£o localizado no estoque atual.";
  abrirModal("modalMovEdit");
}

function commitMovEdit(action){
  const movIdx = movs.findIndex(x=>x.id===movEditId);
  if(movIdx<0){ toast("‚ö†Ô∏è Movimenta√ß√£o n√£o encontrada"); return; }
  const old = movs[movIdx];

  if(action==="delete"){
    if(!confirm("Deletar esta movimenta√ß√£o? O estoque ser√° revertido.")) return;
    const r = revertMov(old);
    if(!r.ok){ toast("‚ùå "+(r.msg||"Falha ao reverter")); return; }
    movs.splice(movIdx,1);
    save(); render(); renderMovList();
    fecharModal("modalMovEdit");
    toast("üóëÔ∏è Movimenta√ß√£o deletada (estoque revertido)");
    return;
  }

  // salvar
  const updated = {...old};
  updated.qtd = Math.max(1, parseInt($("meQtd").value,10)||1);
  updated.origem = $("meOrig").value;
  updated.destino = $("meDest").value;
  updated.obs = $("meObs").value || "";
  const dt2 = $("meQuando").value ? new Date($("meQuando").value) : new Date();
  updated.quandoISO = dt2.toISOString();
  updated.quando = brDateTime(dt2);

  // 1) reverte antigo
  const r1 = revertMov(old);
  if(!r1.ok){ toast("‚ùå "+(r1.msg||"Falha ao reverter (salvar)")); return; }

  // 2) tenta aplicar novo
  const r2 = applyMovToStock(updated);
  if(!r2.ok){
    // tenta restaurar antigo para n√£o quebrar
    applyMovToStock(old);
    toast("‚ùå "+(r2.msg||"Falha ao aplicar altera√ß√µes"));
    return;
  }

  movs[movIdx] = updated;
  save(); render(); renderMovList();
  fecharModal("modalMovEdit");
  toast("‚úÖ Movimenta√ß√£o atualizada");
}


$("btnExportMov")?.addEventListener("click",()=>{
  const blob = new Blob([JSON.stringify(movs,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="ALMOX2026_movimentacoes.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("üì§ Movimenta√ß√µes exportadas");
});


$("btnMovEditSalvar")?.addEventListener("click",()=>commitMovEdit("save"));
$("btnMovEditDel")?.addEventListener("click",()=>commitMovEdit("delete"));

/* ---- init ---- */
document.addEventListener("DOMContentLoaded", ()=>{ /* desativado (import-only) */ });




/* ===== Robust binding (garante bot√µes ativos) ===== */
const __bindFlags = {};
function onClick(id, fn){
  const el = $(id);
  if(!el) return false;
  const key = id + "_click";
  if(__bindFlags[key]) return true;
  el.addEventListener("click", fn, {passive:false});
  __bindFlags[key]=true;
  return true;
}
function onChange(id, fn){
  const el = $(id);
  if(!el) return false;
  const key = id + "_chg";
  if(__bindFlags[key]) return true;
  el.addEventListener("change", fn);
  __bindFlags[key]=true;
  return true;
}

/* Captura erros para diagn√≥stico no celular */
const __errs=[];
function pushErr(msg){
  __errs.push({t:new Date().toISOString(), msg:String(msg)});
  const box = $("diagBox");
  if(box){
    const last = __errs.slice(-5).map(e=>`‚Ä¢ ${e.msg}`).join("<br>");
    box.innerHTML = `<div style="font-weight:900; margin-bottom:6px;">‚ö†Ô∏è √öltimos erros</div>${last}`;
  }
}
window.addEventListener("error",(e)=>{ try{ pushErr(e.message || e.error || e); }catch(_){ } });
window.addEventListener("unhandledrejection",(e)=>{ try{ pushErr(e.reason || "Promise rejeitada"); }catch(_){ } });

function validateBanco(){
  const req = ["codigo1","codigo2","nome","estoqueAtual","estoqueMin"];
  const p = Array.isArray(produtos)?produtos:[];
  const m = Array.isArray(movs)?movs:[];
  const missCounts = {};
  req.forEach(k=>missCounts[k]=0);

  let missingAny=0;
  let invalidNum=0;
  let dupC1=0, dupC2=0;
  const seen1=new Map(), seen2=new Map();

  for(const item of p){
    for(const k of req){
      if(item[k]===undefined || item[k]===null || String(item[k]).trim()===""){
        missCounts[k]++; missingAny++;
      }
    }
    const ea = Number(item.estoqueAtual ?? item.estoque_atual ?? 0);
    const em = Number(item.estoqueMin ?? item.estoque_minimo ?? 0);
    if(!Number.isFinite(ea) || !Number.isFinite(em)) invalidNum++;

    const c1 = String(item.codigo1 ?? item.id ?? "").trim();
    const c2 = String(item.codigo2 ?? item.sku ?? "").trim();
    if(c1){
      if(seen1.has(c1)) dupC1++;
      else seen1.set(c1,true);
    }
    if(c2){
      if(seen2.has(c2)) dupC2++;
      else seen2.set(c2,true);
    }
  }

  // valida movs b√°sico
  let movInvalid=0;
  for(const mv of m){
    if(!mv) { movInvalid++; continue; }
    const qtd = Number(mv.qtd ?? mv.quantidade ?? 0);
    if(!Number.isFinite(qtd)) movInvalid++;
    if(!mv.origem || !mv.destino) movInvalid++;
    const iso = mv.quandoISO || mv.dataISO || mv.data;
    if(iso && isNaN(Date.parse(iso))){ movInvalid++; }
  }

  const box = $("diagBox");
  if(!box) return;

  const missHtml = Object.entries(missCounts)
    .map(([k,v])=>`<tr><td>${k}</td><td style="text-align:right; font-weight:900;">${v}</td></tr>`).join("");

  box.innerHTML = `
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div style="font-weight:1000; font-size:14px;">‚úÖ Valida√ß√£o do Banco</div>
      <div style="opacity:.85; font-size:12px;">${new Date().toLocaleString("pt-BR")}</div>
    </div>
    <div style="margin-top:10px; display:grid; gap:8px;">
      <div style="padding:10px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);">
        <div style="font-weight:900;">üì¶ Produtos</div>
        <div>Total: <b>${p.length}</b> ‚Ä¢ Campos faltando (somat√≥rio): <b>${missingAny}</b></div>
        <div>N√∫meros inv√°lidos: <b>${invalidNum}</b> ‚Ä¢ Duplicados codigo1: <b>${dupC1}</b> ‚Ä¢ Duplicados codigo2: <b>${dupC2}</b></div>
        <table style="width:100%; margin-top:8px; border-collapse:collapse; font-size:12px;">
          <thead><tr><th style="text-align:left; opacity:.9;">Campo</th><th style="text-align:right; opacity:.9;">Faltando</th></tr></thead>
          <tbody>${missHtml}</tbody>
        </table>
      </div>
      <div style="padding:10px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);">
        <div style="font-weight:900;">üîÅ Movimenta√ß√µes</div>
        <div>Total: <b>${m.length}</b> ‚Ä¢ Inconsistentes: <b>${movInvalid}</b></div>
      </div>
      ${__errs.length ? `<div style="padding:10px; border-radius:12px; background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35);">
        <div style="font-weight:900; color:#ffb3b3;">‚ö†Ô∏è Erros recentes</div>
        <div style="font-size:12px; margin-top:6px;">${__errs.slice(-8).map(e=>`‚Ä¢ ${escapeHtml(e.msg)}`).join("<br>")}</div>
      </div>` : ``}
    </div>
  `;
}

function rebindAll(){
  onClick("btnValidate2", ()=>validarBanco());
  // nav
  onClick("btnDados", ()=>abrirModal("modalDados"));
  onClick("btnMov", ()=>{
    if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
    prepararMovimentacao(); renderMovList(); abrirModal("modalMov");
  });
  onClick("btnRel", ()=>{
    if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
    renderFiltrosRel(); $("rOut").innerHTML=""; abrirModal("modalRel");
  });
  onClick("btnSet", ()=>{
    if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
    renderSetores(); abrirModal("modalSet");
  });
  onClick("btnEstoque", ()=>{ window.scrollTo({top:0,behavior:"smooth"}); });

  // dados
  const file = $("fileInput");
  onClick("btnImport", ()=> file && file.click());
  onChange("fileInput", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    importarJSON(f);
    e.target.value="";
  });
  onClick("btnExport", exportarJSON);
  onClick("btnExportCSV", exportarCSV);
  onClick("btnReset", ()=>{
    if(!confirm("Limpar dados do aparelho?")) return;
    localStorage.removeItem(DBKEY);
    banco={produtos:[], movimentacoes:[]}; produtos=banco.produtos; movs=banco.movimentacoes;
    filtrados=[]; render(); renderMovList(); toast("üßπ Limpo");
  });
  onClick("btnValidate", ()=>validateBanco());

  // produto
  onClick("btnSaveProd", ()=>{ salvarProduto(); });
  onClick("btnDelProd", ()=>{ deletarProduto(); });

  // mov
  onClick("btnGravarMov", ()=>{ gravarMovimentacao(); });
  onClick("btnMovEditSalvar", ()=>{ salvarEdicaoMov(); });
  onClick("btnMovEditDel", ()=>{ deletarMov(); });

  // rel
  onClick("btnGerarRel", ()=>{ gerarRelatorio(); });
  onClick("btnPDFRel", ()=>{ salvarPDFRel(); });
  onClick("btnLimparRel", ()=>{ limparRel(); });
  // setores pdf
  onClick("btnGerarSet", ()=>{ gerarSetorDetalhe(); });
  onClick("btnPDFSet", ()=>{ salvarPDFSetor(); });
  onClick("btnVoltarSet", ()=>{ fecharModal("modalSetDet"); renderSetores(); abrirModal("modalSet"); });

  // tabs rel
  const rt = $("rTipo");
  if(rt && !__bindFlags["rTipo_chg"]){
    rt.addEventListener("change", ()=>{ atualizarRelTab(); });
    __bindFlags["rTipo_chg"]=true;
  }
}
document.addEventListener("DOMContentLoaded", ()=>{ try{ rebindAll(); }catch(e){ pushErr(e); } });
window.addEventListener("pageshow", ()=>{ try{ rebindAll(); }catch(e){ pushErr(e); } });
setTimeout(()=>{ try{ rebindAll(); }catch(e){ pushErr(e); } }, 400);


function initImportOnly(){
  // N√ÉO carrega automaticamente. Come√ßa vazio at√© importar.
  banco = {produtos:[], movimentacoes:[]};
  produtos = banco.produtos;
  movs = banco.movimentacoes;
  filtrados = [];
  render();
  toast("üíæ Abra Dados e importe seu JSON");
}
document.addEventListener("DOMContentLoaded", initImportOnly);
window.addEventListener("pageshow", ()=>{ /* Android bfcache */ });

function navDados(){ abrirModal("modalDados"); }
function navMov(){
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  prepararMovimentacao(); renderMovList(); abrirModal("modalMov");
}
function navRel(){
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderFiltrosRel(); $("rOut").innerHTML=""; abrirModal("modalRel");
}
function navSetores(){
  if(produtos.length===0){ toast("‚ö†Ô∏è Importe o JSON em Dados"); abrirModal("modalDados"); return; }
  renderSetores && renderSetores(); abrirModal("modalSetores");
}
function navEstoque(){
  // fecha modais e volta
  document.querySelectorAll(".modal.active").forEach(m=>m.classList.remove("active"));
  window.scrollTo({top:0, behavior:"smooth"});
}

function triggerImport(){
  const fi = $("fileInput");
  if(!fi){ toast("‚ùå fileInput n√£o encontrado"); return; }
  fi.click();
}

$("fileInput")?.addEventListener("change",()=>{
  const f = $("fileInput").files && $("fileInput").files[0];
  if(!f) return;
  importarJSON(f);
  $("fileInput").value = "";
});

function exportarCSV(){
  if(!banco || !Array.isArray(produtos)){ toast("‚ö†Ô∏è Nada para exportar"); return; }
  let csv = "codigo1,codigo2,nome,categoria,setor,estoqueAtual,estoqueMin,preco,ncm,descricao\n";
  for(const p of produtos){
    const row = [
      p.codigo1??"", p.codigo2??"", p.nome??"", p.categoria??"", p.setor??"",
      p.estoqueAtual??0, p.estoqueMin??0, p.preco??0, p.ncm??"", p.descricao??""
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",");
    csv += row + "\n";
  }
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "ALMOX2026BD.csv"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
  toast("‚úÖ CSV exportado");
}

function validarBanco(){
  const issues=[];
  const prods = Array.isArray(produtos)?produtos:[];
  const mov = Array.isArray(movs)?movs:[];
  const req=["codigo1","codigo2","nome","categoria","estoqueAtual","estoqueMin"];
  const miss={}; req.forEach(k=>miss[k]=0);
  const seen1=new Map(), seen2=new Map();

  prods.forEach((p,i)=>{
    req.forEach(k=>{
      if(p[k]===undefined || p[k]===null || String(p[k]).trim()==="") miss[k]++;
    });
    const c1=String(p.codigo1||"").trim();
    const c2=String(p.codigo2||"").trim();
    if(c1){ if(seen1.has(c1)) issues.push(`Duplicado codigo1 ${c1} (itens ${seen1.get(c1)+1} e ${i+1})`); else seen1.set(c1,i); }
    if(c2){ if(seen2.has(c2)) issues.push(`Duplicado codigo2 ${c2} (itens ${seen2.get(c2)+1} e ${i+1})`); else seen2.set(c2,i); }
    if(Number.isNaN(Number(p.estoqueAtual))) issues.push(`EstoqueAtual inv√°lido: ${p.nome||"(sem nome)"} (${c2||c1||"s/c√≥d"})`);
    if(Number.isNaN(Number(p.estoqueMin))) issues.push(`EstoqueMin inv√°lido: ${p.nome||"(sem nome)"} (${c2||c1||"s/c√≥d"})`);
  });

  mov.forEach((m,i)=>{
    const qtd=Number(m.qtd);
    if(!m.produto_nome) issues.push(`Mov ${i+1}: sem produto_nome`);
    if(!m.origem || !m.destino) issues.push(`Mov ${i+1}: origem/destino vazio`);
    if(!qtd || qtd<=0) issues.push(`Mov ${i+1}: qtd inv√°lida`);
    if(!m.quandoISO && !m.quando) issues.push(`Mov ${i+1}: sem data`);
  });

  const resumo = [
    `üì¶ Produtos: ${prods.length}`,
    `üîÅ Movimenta√ß√µes: ${mov.length}`,
    `‚ö†Ô∏è Faltando (codigo1/codigo2/nome/categoria/estoque): ${Object.values(miss).reduce((a,b)=>a+b,0)}`,
    `üö® Problemas: ${issues.length}`
  ].join("<br>");
  const det = issues.slice(0,120).map(x=>`‚Ä¢ ${escapeHtml(x)}`).join("<br>") || "Nenhum problema cr√≠tico.";
  const box = $("diagBox") || $("diagnostico") || $("dadosDiag");
  if(box) box.innerHTML = `<div style="line-height:1.6">${resumo}<hr style="border:0;border-top:1px solid rgba(255,255,255,.12);margin:10px 0">${det}</div>`;
  else alert(issues.length?issues.join("\n"):"Banco OK");
  toast(issues.length? "‚ö†Ô∏è Valida√ß√£o conclu√≠da":"‚úÖ Banco OK");
}
</script>
</body>
</html>
